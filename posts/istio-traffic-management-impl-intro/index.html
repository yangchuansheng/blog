<!doctype html><html lang=zh-cn dir=ltr class=scroll-smooth data-default-appearance=dark data-auto-appearance=false><head><meta charset=utf-8><meta http-equiv=content-language content="zh-cn"><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=X-UA-Compatible content="ie=edge"><title>Istio 流量管理实现机制深度解析 &#183; 云原生实验室</title>
<meta name=title content="Istio 流量管理实现机制深度解析 &#183; 云原生实验室"><meta name=description content="云原生实验室是一个关注容器、Kubernetes、Istio、DevOps、Prometheus、Envoy、Golang、云原生、微服务等技术的个人博客。"><meta name=keywords content="Istio,"><link rel=canonical href=https://icloudnative.io/posts/istio-traffic-management-impl-intro/><link type=text/css rel=stylesheet href=/css/main.bundle.min.39c80b3a3e619000a59f9a4a5eedbe596ab54386e4a4ab18c7f5f5406ae131ffed48ac9f2614ed92f45d63390f3af1430ee03c827baa7f5c85fe0c68f85dc9b3.css integrity="sha512-OcgLOj5hkACln5pKXu2+WWq1Q4bkpKsYx/X1QGrhMf/tSKyfJhTtkvRdYzkPOvFDDuA8gnuqf1yF/gxo+F3Jsw=="><script type=text/javascript src=/js/appearance.min.516a16745bea5a9bd011138d254cc0fd3973cd55ce6e15f3dec763e7c7c2c7448f8fe7b54cca811cb821b0c7e12cd161caace1dd794ac3d34d40937cbcc9ee12.js integrity="sha512-UWoWdFvqWpvQERONJUzA/TlzzVXObhXz3sdj58fCx0SPj+e1TMqBHLghsMfhLNFhyqzh3XlKw9NNQJN8vMnuEg=="></script><script defer type=text/javascript id=script-bundle src=/js/main.bundle.min.829f642301e982d157769b6448ba4e0d2d54933c6013c25f18def451433c762b8e8def22a1c6a2edd6f3fcbaa4c110aef5255aa8461e6d7e06acc035db4867c3.js integrity="sha512-gp9kIwHpgtFXdptkSLpODS1UkzxgE8JfGN70UUM8diuOje8iocai7dbz/LqkwRCu9SVaqEYebX4GrMA120hnww==" data-copy data-copied></script><script src=/js/zoom.min.js></script><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><meta property="og:title" content="Istio 流量管理实现机制深度解析"><meta property="og:description" content="本文转载自赵化冰的博客 前言 # Istio 作为一个 service mesh 开源项目,其中最重"><meta property="og:type" content="article"><meta property="og:url" content="https://icloudnative.io/posts/istio-traffic-management-impl-intro/"><meta property="og:image" content="https://icloudnative.io/posts/istio-traffic-management-impl-intro/featured.jpg"><meta property="article:section" content="posts"><meta property="article:published_time" content="2018-10-09T20:00:17+08:00"><meta property="article:modified_time" content="2018-10-09T20:00:17+08:00"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://icloudnative.io/posts/istio-traffic-management-impl-intro/featured.jpg"><meta name=twitter:title content="Istio 流量管理实现机制深度解析"><meta name=twitter:description content="本文转载自赵化冰的博客 前言 # Istio 作为一个 service mesh 开源项目,其中最重"><script type=application/ld+json>[{"@context":"https://schema.org","@type":"Article","articleSection":"博客","name":"Istio 流量管理实现机制深度解析","headline":"Istio 流量管理实现机制深度解析","abstract":"本文转载自赵化冰的博客 前言 # Istio 作为一个 service mesh 开源项目,其中最重","inLanguage":"zh-cn","url":"https:\/\/icloudnative.io\/posts\/istio-traffic-management-impl-intro\/","author":{"@type":"Person","name":"米开朗基杨"},"copyrightYear":"2018","dateCreated":"2018-10-09T20:00:17\u002b08:00","datePublished":"2018-10-09T20:00:17\u002b08:00","dateModified":"2018-10-09T20:00:17\u002b08:00","keywords":["Istio"],"mainEntityOfPage":"true","wordCount":"10902"}]</script><meta name=author content="米开朗基杨"><link href=/index.xml rel=me><link href=https://twitter.com/CarsonYangk8s rel=me><link href=https://jsdelivr.icloudnative.io/gh/yangchuansheng/imghosting5@main/uPic/tmpm1ykjt96.webp rel=me><link href=https://github.com/yangchuansheng rel=me><link href=https://t.me/cloudnativer rel=me><script src=/lib/jquery/jquery.slim.min.js integrity></script><link rel=stylesheet href=https://jsdelivr.icloudnative.io/npm/lxgw-wenkai-screen-webfont@1.1.0/style.css><script defer pjax src=https://ymvhjeyojtri.cloud.sealos.top/js></script><script>$(document).ready(function(){var e=setInterval(t,100);function t(){$("#busuanzi_container_site_pv").css("display")!="none"&&(clearInterval(e),$("#busuanzi_site_pv").html(parseInt($("#busuanzi_site_pv").html())+1360325)),$("#busuanzi_container_site_uv").css("display")!="none"&&(clearInterval(e),$("#busuanzi_site_uv").html(parseInt($("#busuanzi_site_uv").html())+731632))}})</script><div id=fps style=z-index:999;position:fixed;bottom:3px;right:3px;color:#fff;font-size:10px></div><script type=text/javascript src=https://cdn.staticfile.org/layer/3.5.1/layer.min.js></script><script type=text/javascript src=https://icloudnative.io/js/fps.js></script><script>(function(e,t,n,s){if(typeof e.webpushr!="undefined")return;e.webpushr=e.webpushr||function(){(e.webpushr.q=e.webpushr.q||[]).push(arguments)};var i=t.getElementsByTagName(n)[0],o=t.createElement(n);o.id=s,o.async=1,o.src="https://cdn.webpushr.com/app.min.js",i.parentNode.appendChild(o)})(window,document,"script","webpushr-jssdk"),webpushr("setup",{key:"BHIaDYldZcXlQt38kYXgH48NQZFQkowuo14rNhiIvrGEP5kFU5lb5h-VIMlUkjy-kxygxW4hEvb6GjijlYYlwCk"})</script><script>var _hmt=_hmt||[];(function(){var e,t=document.createElement("script");t.src="https://hm.baidu.com/hm.js?efe96f04908ae320df234a4f5626879e",e=document.getElementsByTagName("script")[0],e.parentNode.insertBefore(t,e)})()</script><script async src=https://umami.icloudnative.io/oishii data-website-id=f415abb1-1cb9-402e-a1c4-225ca9d792b0></script><script async src="https://eezgfvhagnzs.cloud.sealos.io/gtag/js?id=G-0VHVXWXJMQ"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-0VHVXWXJMQ")</script><div class=top-scroll-bar style=height:5px;background-color:blue;width:0;position:fixed;top:0;z-index:100></div><script type=text/javascript>$(document).ready(function(){$(window).scroll(function(){$(".top-scroll-bar").attr("style","width: "+$(this).scrollTop()/($(document).height()-$(this).height())*100+"%; display: block;")})})</script><script src=https://jsdelivr.icloudnative.io/gh/instantpage/instant.page@master/instantpage.js type=module></script><script type=text/javascript>var OriginTitile=document.title,titleTime;document.addEventListener("visibilitychange",function(){document.hidden?(document.title="你别走吖 Σ(っ °Д °;)っ",clearTimeout(titleTime)):(document.title="你可算回来了 (｡•ˇ‸ˇ•｡)"+OriginTitile,titleTime=setTimeout(function(){document.title=OriginTitile},2e3))})</script><meta name=theme-color></head><body class="flex flex-col h-screen px-6 m-auto text-lg leading-7 max-w-7xl bg-neutral text-neutral-900 dark:bg-neutral-800 dark:text-neutral sm:px-14 md:px-24 lg:px-32"><div id=the-top class="absolute flex self-center"><a class="px-3 py-1 text-sm -translate-y-8 rounded-b-lg bg-primary-200 focus:translate-y-0 dark:bg-neutral-600" href=#main-content><span class="font-bold text-primary-600 ltr:pr-2 rtl:pl-2 dark:text-primary-400">&darr;</span></a></div><div class=min-h-[148px]></div><div class="fixed inset-x-0 pl-[24px] pr-[24px]" style=z-index:100><div id=menu-blur class="absolute opacity-0 inset-x-0 top-0 h-full single_hero_background nozoom backdrop-blur-2xl shadow-2xl"></div><div class="relative max-w-[64rem] ml-auto mr-auto"><div style=padding-left:0;padding-right:0;padding-top:2px;padding-bottom:3px class="main-menu flex items-center justify-between px-4 py-6 sm:px-6 md:justify-start space-x-3"><div><a href=/ class=flex><span class=sr-only>云原生实验室</span>
<img src=/img/logo.webp width=1163 height=1163 class="logo max-h-[5rem] max-w-[5rem] object-scale-down object-left nozoom" alt=云原生实验室></a></div><div class="flex flex-1 items-center justify-between"><nav class="flex space-x-3"><a href=/ class="text-base font-medium text-gray-500 hover:text-gray-900"><h6 style=font-size:1.5rem><span style=color:#23d18b>>$</span>&nbsp;cd /home/<span class=logo_cursor></span></h6></a></nav><nav class="hidden md:flex items-center space-x-5 md:ml-12 h-12"><a href=/examples/ class="flex items-center"><span class=mr-1><span class="relative block icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><path fill="currentcolor" d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6.0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6.0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3.0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1.0-6.2-.3-40.4-.3-61.4.0.0-70 15-84.7-29.8.0.0-11.4-29.1-27.8-36.6.0.0-22.9-15.7 1.6-15.4.0.0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5.0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9.0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4.0 33.7-.3 75.4-.3 83.6.0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6.0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9.0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg></span></span><p class="text-base font-medium text-gray-500 hover:text-gray-900" title=开源项目>项目</p></a><a href="https://umami.icloudnative.io/share/UuDHNJJWIShegM2N/%E4%BA%91%E5%8E%9F%E7%94%9F%E5%AE%9E%E9%AA%8C%E5%AE%A4?theme=dark" target=_blank class="flex items-center"><span class=mr-1><span class="relative block icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><path fill="currentcolor" d="M288 32c-80.8.0-145.5 36.8-192.6 80.6C48.6 156 17.3 208 2.5 243.7c-3.3 7.9-3.3 16.7.0 24.6C17.3 304 48.6 356 95.4 399.4 142.5 443.2 207.2 480 288 480s145.5-36.8 192.6-80.6c46.8-43.5 78.1-95.4 93-131.1 3.3-7.9 3.3-16.7.0-24.6-14.9-35.7-46.2-87.7-93-131.1C433.5 68.8 368.8 32 288 32zM432 256c0 79.5-64.5 144-144 144s-144-64.5-144-144 64.5-144 144-144 144 64.5 144 144zM288 192c0 35.3-28.7 64-64 64-11.5.0-22.3-3-31.6-8.4-.2 2.8-.4 5.5-.4 8.4.0 53 43 96 96 96s96-43 96-96-43-96-96-96c-2.8.0-5.6.1-8.4.4 5.3 9.3 8.4 20.1 8.4 31.6z"/></svg></span></span><p class="text-base font-medium text-gray-500 hover:text-gray-900" title>实时访客</p></a><div><div class="cursor-pointer flex items-center nested-menu"><span class=mr-1><span class="relative block icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path fill="currentcolor" d="M159.3 5.4c7.8-7.3 19.9-7.2 27.7.1 27.6 25.9 53.5 53.8 77.7 84 11-14.4 23.5-30.1 37-42.9 7.9-7.4 20.1-7.4 28 .1 34.6 33 63.9 76.6 84.5 118 20.3 40.8 33.8 82.5 33.8 111.9C448 404.2 348.2 512 224 512 98.4 512 0 404.1.0 276.5c0-38.4 17.8-85.3 45.4-131.7C73.3 97.7 112.7 48.6 159.3 5.4zM225.7 416c25.3.0 47.7-7 68.8-21 42.1-29.4 53.4-88.2 28.1-134.4-2.8-5.6-5.6-11.2-9.8-16.8l-50.6 58.8S180.8 199 175.1 192c-42 51.8-63.1 81.2-63.1 114.8C112 375.4 162.6 416 225.7 416z"/></svg></span></span><a class="text-base font-medium text-gray-500 hover:text-gray-900" title>百宝箱
</a><span><span class="relative block icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentcolor" aria-hidden="true"><path fill-rule="evenodd" d="M5.23 7.21a.75.75.0 011.06.02L10 11.168l3.71-3.938a.75.75.0 111.08 1.04l-4.25 4.5a.75.75.0 01-1.08.0l-4.25-4.5a.75.75.0 01.02-1.06z" clip-rule="evenodd"/></svg></span></span></div><div class="absolute menuhide"><div class="pt-2 p-5 mt-2 rounded-xl backdrop-blur shadow-2xl"><div class="flex flex-col space-y-3"><a href=https://icloudnative.io/uptime-status/ target=_blank class="flex items-center"><span class=mr-1><span class="relative block icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M228.3 469.1 47.6 300.4c-4.2-3.9-8.2-8.1-11.9-12.4h87c22.6.0 43-13.6 51.7-34.5l10.5-25.2 49.3 109.5c3.8 8.5 12.1 14 21.4 14.1s17.8-5 22-13.3L320 253.7l1.7 3.4c9.5 19 28.9 31 50.1 31H476.3c-3.7 4.3-7.7 8.5-11.9 12.4L283.7 469.1c-7.5 7-17.4 10.9-27.7 10.9s-20.2-3.9-27.7-10.9zM503.7 240h-132c-3 0-5.8-1.7-7.2-4.4l-23.2-46.3c-4.1-8.1-12.4-13.3-21.5-13.3s-17.4 5.1-21.5 13.3l-41.4 82.8-51-113.9c-3.9-8.7-12.7-14.3-22.2-14.1s-18.1 5.9-21.8 14.8l-31.8 76.3c-1.2 3-4.2 4.9-7.4 4.9H16c-2.6.0-5 .4-7.3 1.1-5.7-16-8.7-33-8.7-50.3v-5.8c0-69.9 50.5-129.5 119.4-141C165 36.5 211.4 51.4 244 84l12 12 12-12c32.6-32.6 79-47.5 124.6-39.9C461.5 55.6 512 115.2 512 185.1v5.8c0 16.9-2.8 33.5-8.3 49.1z"/></svg></span></span><p class="text-sm font-sm text-gray-500 hover:text-gray-900" title>服务监控</p></a><a href=https://privatebin.icloudnative.io/ target=_blank class="flex items-center"><span class=mr-1><span class="relative block icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M160 0c-23.7.0-44.4 12.9-55.4 32H48C21.5 32 0 53.5.0 80V4e2c0 26.5 21.5 48 48 48H192V176c0-44.2 35.8-80 80-80h48V80c0-26.5-21.5-48-48-48H215.4C204.4 12.9 183.7.0 160 0zM272 128c-26.5.0-48 21.5-48 48V448v16c0 26.5 21.5 48 48 48H464c26.5.0 48-21.5 48-48V256H416c-17.7.0-32-14.3-32-32V128H320 272zM160 40a24 24 0 110 48 24 24 0 110-48zm256 88v96h96l-96-96z"/></svg></span></span><p class="text-sm font-sm text-gray-500 hover:text-gray-900" title>共享文本</p></a><a href=/jstc/ class="flex items-center"><span class=mr-1><span class="relative block icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M0 96C0 60.7 28.7 32 64 32H448c35.3.0 64 28.7 64 64V416c0 35.3-28.7 64-64 64H64c-35.3.0-64-28.7-64-64V96zM323.8 202.5c-4.5-6.6-11.9-10.5-19.8-10.5s-15.4 3.9-19.8 10.5l-87 127.6L170.7 297c-4.6-5.7-11.5-9-18.7-9s-14.2 3.3-18.7 9l-64 80c-5.8 7.2-6.9 17.1-2.9 25.4S78.8 416 88 416h96 32H424c8.9.0 17.1-4.9 21.2-12.8s3.6-17.4-1.4-24.7l-120-176zM112 192c26.5.0 48-21.5 48-48s-21.5-48-48-48-48 21.5-48 48 21.5 48 48 48z"/></svg></span></span><p class="text-sm font-sm text-gray-500 hover:text-gray-900" title>趣味截图</p></a></div></div></div></div><a href=/index.xml class="flex items-center"><span><span class="relative block icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path fill="currentcolor" d="M0 64C0 46.3 14.3 32 32 32c229.8.0 416 186.2 416 416 0 17.7-14.3 32-32 32s-32-14.3-32-32C384 253.6 226.4 96 32 96 14.3 96 0 81.7.0 64zM128 416c0 35.3-28.7 64-64 64S0 451.3.0 416s28.7-64 64-64 64 28.7 64 64zM32 160c159.1.0 288 128.9 288 288 0 17.7-14.3 32-32 32s-32-14.3-32-32c0-123.7-100.3-224-224-224-17.7.0-32-14.3-32-32s14.3-32 32-32z"/></svg></span></span><p class="text-base font-medium text-gray-500 hover:text-gray-900" title></p></a><a href=https://twitter.com/CarsonYangk8s target=_blank class="flex items-center"><span><span class="relative block icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M389.2 48h70.6L305.6 224.2 487 464H345L233.7 318.6 106.5 464H35.8L200.7 275.5 26.8 48H172.4L272.9 180.9 389.2 48zM364.4 421.8h39.1L151.1 88h-42L364.4 421.8z"/></svg></span></span><p class="text-base font-medium text-gray-500 hover:text-gray-900" title></p></a><a href=https://github.com/yangchuansheng target=_blank class="flex items-center"><span><span class="relative block icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><path fill="currentcolor" d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6.0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6.0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3.0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1.0-6.2-.3-40.4-.3-61.4.0.0-70 15-84.7-29.8.0.0-11.4-29.1-27.8-36.6.0.0-22.9-15.7 1.6-15.4.0.0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5.0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9.0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4.0 33.7-.3 75.4-.3 83.6.0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6.0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9.0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg></span></span><p class="text-base font-medium text-gray-500 hover:text-gray-900" title></p></a><button id=search-button aria-label=Search class="text-base hover:text-primary-600 dark:hover:text-primary-400 h-12" title>
<span class="relative block icon"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M505 442.7 405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9.0 208 0S0 93.1.0 208s93.1 208 208 208c48.3.0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9.0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7.0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7.0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg></span></button><div class="ltr:mr-14 rtl:ml-14 cursor-pointer text-sm text-neutral-700 hover:text-primary-600 dark:text-neutral dark:hover:text-primary-400"><button id=appearance-switcher aria-label="Dark mode switcher" type=button><div class="flex items-center justify-center h-12 dark:hidden"><span class="relative block icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M32 256C32 132.2 132.3 32 255.8 32c11.36.0 29.7 1.668 40.9 3.746 9.616 1.777 11.75 14.63 3.279 19.44C245 86.5 211.2 144.6 211.2 207.8c0 109.7 99.71 193 208.3 172.3 9.561-1.805 16.28 9.324 10.11 16.95C387.9 448.6 324.8 480 255.8 480 132.1 480 32 379.6 32 256z"/></svg></span></div><div class="items-center justify-center hidden h-12 dark:flex"><span class="relative block icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M256 159.1c-53.02.0-95.1 42.98-95.1 95.1s41.2 96.9 95.1 96.9 95.1-42.98 95.1-95.1S309 159.1 256 159.1zM509.3 347l-63.2-91.9 63.15-91.01c6.332-9.125 1.104-21.74-9.826-23.72l-109-19.7-19.7-109c-1.975-10.93-14.59-16.16-23.72-9.824L256 65.89 164.1 2.736c-9.125-6.332-21.74-1.107-23.72 9.824L121.6 121.6 12.56 141.3C1.633 143.2-3.596 155.9 2.736 164.1L65.89 256 2.74 347.01c-6.332 9.125-1.105 21.74 9.824 23.72l109 19.7 19.7 109c1.975 10.93 14.59 16.16 23.72 9.824L256 446.1l91.01 63.15c9.127 6.334 21.75 1.107 23.72-9.822l19.7-109 109-19.7C510.4 368.8 515.6 356.1 509.3 347zM256 383.1c-70.69.0-127.1-57.31-127.1-127.1.0-70.69 57.31-127.1 127.1-127.1S383.1 186.2 383.1 256c0 70.7-56.4 127.1-127.1 127.1z"/></svg></span></div></button></div></nav><div class="flex md:hidden items-center space-x-5 md:ml-12"><span></span>
<button id=search-button-mobile aria-label=Search class="text-base hover:text-primary-600 dark:hover:text-primary-400" title>
<span class="relative block icon"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M505 442.7 405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9.0 208 0S0 93.1.0 208s93.1 208 208 208c48.3.0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9.0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7.0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7.0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg></span></button>
<button id=appearance-switcher-mobile aria-label="Dark mode switcher" type=button style=margin-right:5px><div class="flex items-center justify-center h-12 dark:hidden"><span class="relative block icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M32 256C32 132.2 132.3 32 255.8 32c11.36.0 29.7 1.668 40.9 3.746 9.616 1.777 11.75 14.63 3.279 19.44C245 86.5 211.2 144.6 211.2 207.8c0 109.7 99.71 193 208.3 172.3 9.561-1.805 16.28 9.324 10.11 16.95C387.9 448.6 324.8 480 255.8 480 132.1 480 32 379.6 32 256z"/></svg></span></div><div class="items-center justify-center hidden h-12 dark:flex"><span class="relative block icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M256 159.1c-53.02.0-95.1 42.98-95.1 95.1s41.2 96.9 95.1 96.9 95.1-42.98 95.1-95.1S309 159.1 256 159.1zM509.3 347l-63.2-91.9 63.15-91.01c6.332-9.125 1.104-21.74-9.826-23.72l-109-19.7-19.7-109c-1.975-10.93-14.59-16.16-23.72-9.824L256 65.89 164.1 2.736c-9.125-6.332-21.74-1.107-23.72 9.824L121.6 121.6 12.56 141.3C1.633 143.2-3.596 155.9 2.736 164.1L65.89 256 2.74 347.01c-6.332 9.125-1.105 21.74 9.824 23.72l109 19.7 19.7 109c1.975 10.93 14.59 16.16 23.72 9.824L256 446.1l91.01 63.15c9.127 6.334 21.75 1.107 23.72-9.822l19.7-109 109-19.7C510.4 368.8 515.6 356.1 509.3 347zM256 383.1c-70.69.0-127.1-57.31-127.1-127.1.0-70.69 57.31-127.1 127.1-127.1S383.1 186.2 383.1 256c0 70.7-56.4 127.1-127.1 127.1z"/></svg></span></div></button></div></div><div class="-my-2 -mr-2 md:hidden"><label id=menu-button for=menu-controller class=block><input type=checkbox id=menu-controller class=hidden><div class="cursor-pointer hover:text-primary-600 dark:hover:text-primary-400"><span class="relative block icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path fill="currentcolor" d="M0 96C0 78.33 14.33 64 32 64H416c17.7.0 32 14.33 32 32 0 17.7-14.3 32-32 32H32C14.33 128 0 113.7.0 96zM0 256c0-17.7 14.33-32 32-32H416c17.7.0 32 14.3 32 32s-14.3 32-32 32H32c-17.67.0-32-14.3-32-32zM416 448H32c-17.67.0-32-14.3-32-32s14.33-32 32-32H416c17.7.0 32 14.3 32 32s-14.3 32-32 32z"/></svg></span></div><div id=menu-wrapper style=padding-top:5px class="fixed inset-0 z-30 invisible w-screen h-screen m-0 overflow-auto transition-opacity opacity-0 cursor-default bg-neutral-100/50 backdrop-blur-sm dark:bg-neutral-900/50"><ul class="flex space-y-2 mt-3 flex-col items-end w-full px-6 py-6 mx-auto overflow-visible list-none ltr:text-right rtl:text-left max-w-7xl"><li><span class="cursor-pointer inline-block align-text-bottom hover:text-primary-600 dark:hover:text-primary-400"><span class="relative block icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><path fill="currentcolor" d="M310.6 361.4c12.5 12.5 12.5 32.75.0 45.25C304.4 412.9 296.2 416 288 416s-16.38-3.125-22.62-9.375L160 301.3 54.63 406.6C48.38 412.9 40.19 416 32 416S15.63 412.9 9.375 406.6c-12.5-12.5-12.5-32.75.0-45.25l105.4-105.4L9.375 150.6c-12.5-12.5-12.5-32.75.0-45.25s32.75-12.5 45.25.0L160 210.8l105.4-105.4c12.5-12.5 32.75-12.5 45.25.0s12.5 32.75.0 45.25l-105.4 105.4L310.6 361.4z"/></svg></span></span></li><li class=mt-1><a href=/examples/ class="flex items-center"><div class=mr-2><span class="relative block icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><path fill="currentcolor" d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6.0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6.0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3.0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1.0-6.2-.3-40.4-.3-61.4.0.0-70 15-84.7-29.8.0.0-11.4-29.1-27.8-36.6.0.0-22.9-15.7 1.6-15.4.0.0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5.0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9.0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4.0 33.7-.3 75.4-.3 83.6.0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6.0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9.0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg></span></div><p class="text-bg font-bg text-gray-500 hover:text-gray-900" title=开源项目>项目</p></a></li><li class=mt-1><a href="https://umami.icloudnative.io/share/UuDHNJJWIShegM2N/%E4%BA%91%E5%8E%9F%E7%94%9F%E5%AE%9E%E9%AA%8C%E5%AE%A4?theme=dark" target=_blank class="flex items-center"><div class=mr-2><span class="relative block icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><path fill="currentcolor" d="M288 32c-80.8.0-145.5 36.8-192.6 80.6C48.6 156 17.3 208 2.5 243.7c-3.3 7.9-3.3 16.7.0 24.6C17.3 304 48.6 356 95.4 399.4 142.5 443.2 207.2 480 288 480s145.5-36.8 192.6-80.6c46.8-43.5 78.1-95.4 93-131.1 3.3-7.9 3.3-16.7.0-24.6-14.9-35.7-46.2-87.7-93-131.1C433.5 68.8 368.8 32 288 32zM432 256c0 79.5-64.5 144-144 144s-144-64.5-144-144 64.5-144 144-144 144 64.5 144 144zM288 192c0 35.3-28.7 64-64 64-11.5.0-22.3-3-31.6-8.4-.2 2.8-.4 5.5-.4 8.4.0 53 43 96 96 96s96-43 96-96-43-96-96-96c-2.8.0-5.6.1-8.4.4 5.3 9.3 8.4 20.1 8.4 31.6z"/></svg></span></div><p class="text-bg font-bg text-gray-500 hover:text-gray-900" title>实时访客</p></a></li><li class=mt-1><a class="flex items-center"><span class=mr-1><span class="relative block icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path fill="currentcolor" d="M159.3 5.4c7.8-7.3 19.9-7.2 27.7.1 27.6 25.9 53.5 53.8 77.7 84 11-14.4 23.5-30.1 37-42.9 7.9-7.4 20.1-7.4 28 .1 34.6 33 63.9 76.6 84.5 118 20.3 40.8 33.8 82.5 33.8 111.9C448 404.2 348.2 512 224 512 98.4 512 0 404.1.0 276.5c0-38.4 17.8-85.3 45.4-131.7C73.3 97.7 112.7 48.6 159.3 5.4zM225.7 416c25.3.0 47.7-7 68.8-21 42.1-29.4 53.4-88.2 28.1-134.4-2.8-5.6-5.6-11.2-9.8-16.8l-50.6 58.8S180.8 199 175.1 192c-42 51.8-63.1 81.2-63.1 114.8C112 375.4 162.6 416 225.7 416z"/></svg></span></span><p class="text-bg font-bg text-gray-500 hover:text-gray-900" title>百宝箱</p><span><span class="relative block icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentcolor" aria-hidden="true"><path fill-rule="evenodd" d="M5.23 7.21a.75.75.0 011.06.02L10 11.168l3.71-3.938a.75.75.0 111.08 1.04l-4.25 4.5a.75.75.0 01-1.08.0l-4.25-4.5a.75.75.0 01.02-1.06z" clip-rule="evenodd"/></svg></span></span></a></li><li class=mt-1><a href=https://icloudnative.io/uptime-status/ target=_blank class="flex items-center"><span class=mr-1><span class="relative block icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M228.3 469.1 47.6 300.4c-4.2-3.9-8.2-8.1-11.9-12.4h87c22.6.0 43-13.6 51.7-34.5l10.5-25.2 49.3 109.5c3.8 8.5 12.1 14 21.4 14.1s17.8-5 22-13.3L320 253.7l1.7 3.4c9.5 19 28.9 31 50.1 31H476.3c-3.7 4.3-7.7 8.5-11.9 12.4L283.7 469.1c-7.5 7-17.4 10.9-27.7 10.9s-20.2-3.9-27.7-10.9zM503.7 240h-132c-3 0-5.8-1.7-7.2-4.4l-23.2-46.3c-4.1-8.1-12.4-13.3-21.5-13.3s-17.4 5.1-21.5 13.3l-41.4 82.8-51-113.9c-3.9-8.7-12.7-14.3-22.2-14.1s-18.1 5.9-21.8 14.8l-31.8 76.3c-1.2 3-4.2 4.9-7.4 4.9H16c-2.6.0-5 .4-7.3 1.1-5.7-16-8.7-33-8.7-50.3v-5.8c0-69.9 50.5-129.5 119.4-141C165 36.5 211.4 51.4 244 84l12 12 12-12c32.6-32.6 79-47.5 124.6-39.9C461.5 55.6 512 115.2 512 185.1v5.8c0 16.9-2.8 33.5-8.3 49.1z"/></svg></span></span><p class="text-sm font-small text-gray-500 hover:text-gray-900" title>服务监控</p></a></li><li class=mt-1><a href=https://privatebin.icloudnative.io/ target=_blank class="flex items-center"><span class=mr-1><span class="relative block icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M160 0c-23.7.0-44.4 12.9-55.4 32H48C21.5 32 0 53.5.0 80V4e2c0 26.5 21.5 48 48 48H192V176c0-44.2 35.8-80 80-80h48V80c0-26.5-21.5-48-48-48H215.4C204.4 12.9 183.7.0 160 0zM272 128c-26.5.0-48 21.5-48 48V448v16c0 26.5 21.5 48 48 48H464c26.5.0 48-21.5 48-48V256H416c-17.7.0-32-14.3-32-32V128H320 272zM160 40a24 24 0 110 48 24 24 0 110-48zm256 88v96h96l-96-96z"/></svg></span></span><p class="text-sm font-small text-gray-500 hover:text-gray-900" title>共享文本</p></a></li><li class=mt-1><a href=/jstc/ class="flex items-center"><span class=mr-1><span class="relative block icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M0 96C0 60.7 28.7 32 64 32H448c35.3.0 64 28.7 64 64V416c0 35.3-28.7 64-64 64H64c-35.3.0-64-28.7-64-64V96zM323.8 202.5c-4.5-6.6-11.9-10.5-19.8-10.5s-15.4 3.9-19.8 10.5l-87 127.6L170.7 297c-4.6-5.7-11.5-9-18.7-9s-14.2 3.3-18.7 9l-64 80c-5.8 7.2-6.9 17.1-2.9 25.4S78.8 416 88 416h96 32H424c8.9.0 17.1-4.9 21.2-12.8s3.6-17.4-1.4-24.7l-120-176zM112 192c26.5.0 48-21.5 48-48s-21.5-48-48-48-48 21.5-48 48 21.5 48 48 48z"/></svg></span></span><p class="text-sm font-small text-gray-500 hover:text-gray-900" title>趣味截图</p></a></li><li class=mb-2></li><li class=mt-1><a href=/index.xml class="flex items-center"><div><span class="relative block icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path fill="currentcolor" d="M0 64C0 46.3 14.3 32 32 32c229.8.0 416 186.2 416 416 0 17.7-14.3 32-32 32s-32-14.3-32-32C384 253.6 226.4 96 32 96 14.3 96 0 81.7.0 64zM128 416c0 35.3-28.7 64-64 64S0 451.3.0 416s28.7-64 64-64 64 28.7 64 64zM32 160c159.1.0 288 128.9 288 288 0 17.7-14.3 32-32 32s-32-14.3-32-32c0-123.7-100.3-224-224-224-17.7.0-32-14.3-32-32s14.3-32 32-32z"/></svg></span></div><p class="text-bg font-bg text-gray-500 hover:text-gray-900" title></p></a></li><li class=mt-1><a href=https://twitter.com/CarsonYangk8s target=_blank class="flex items-center"><div><span class="relative block icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M389.2 48h70.6L305.6 224.2 487 464H345L233.7 318.6 106.5 464H35.8L200.7 275.5 26.8 48H172.4L272.9 180.9 389.2 48zM364.4 421.8h39.1L151.1 88h-42L364.4 421.8z"/></svg></span></div><p class="text-bg font-bg text-gray-500 hover:text-gray-900" title></p></a></li><li class=mt-1><a href=https://github.com/yangchuansheng target=_blank class="flex items-center"><div><span class="relative block icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><path fill="currentcolor" d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6.0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6.0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3.0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1.0-6.2-.3-40.4-.3-61.4.0.0-70 15-84.7-29.8.0.0-11.4-29.1-27.8-36.6.0.0-22.9-15.7 1.6-15.4.0.0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5.0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9.0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4.0 33.7-.3 75.4-.3 83.6.0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6.0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9.0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg></span></div><p class="text-bg font-bg text-gray-500 hover:text-gray-900" title></p></a></li></ul></div></label></div></div><script>(function(){var e=$(".main-menu"),t=window.location.pathname;e.find('a[href="'+t+'"]').each(function(e,t){$(t).children("p").addClass("active")})})()</script></div></div><script>window.addEventListener("scroll",function(){var t=window.pageYOffset||document.documentElement.scrollTop||document.body.scrollTop||0,n=document.getElementById("menu-blur");n.style.opacity=t/300})</script><div class="relative flex flex-col grow"><div class=wrapper__left style=left:2px data-pad=true dir=ltr><div class="join-us dark:text-black" style=margin-top:3%;height:39%><img class=modalImage style=max-width:13% src=https://jsdelivr.icloudnative.io/gh/yangchuansheng/imghosting5@main/uPic/2023-03-01-22-59-x40tuN.png alt=icon></img><p><a data-umami-event=Sealos href=https://github.com/labring/sealos target=_blank>Sealos</a>，在云桌面中运行分布式应用程序，像使用个人电脑一样使用云</p><img class=modalImage style=max-width:92% src=https://jsdelivr.icloudnative.io/gh/yangchuansheng/imghosting5@main/uPic/2023-08-31-09-52-gLmSek.jpg alt=icon></img><p style=margin-top:1rem!important;text-align:center><a data-umami-event=Sealos class="!rounded-md bg-primary-600 px-4 py-2 !text-neutral !no-underline hover:!bg-primary-500 dark:bg-primary-800 dark:hover:!bg-primary-700" href=https://sealos.run target=_blank role=button>去看看👀</a></p></div><div class=join-us style=top:42%;height:53%><img class="modalImage nozoom" src=https://jsdelivr.icloudnative.io/gh/yangchuansheng/imghosting@three/img/modal-content.svg alt=icon></img><p>扫码加入微信群，和云原生大佬们一起探讨云原生和不可描述的事情！</p><div><img style=width:88px;margin-top:2% src=https://jsdelivr.icloudnative.io/gh/yangchuansheng/imghosting5@main/uPic/tmpm1ykjt96.webp></img></div><button class=button_left>
<a data-umami-event="Telegram cloud_native_share" href=https://t.me/cloudnativer target=_blank><div class=icon_left><svg viewBox="0 0 16 16" class="bi bi-telegram" fill="currentcolor" height="16" width="16" xmlns="http://www.w3.org/2000/svg"><path d="M16 8A8 8 0 110 8a8 8 0 0116 0zM8.287 5.906c-.778.324-2.334.994-4.666 2.01-.378.15-.577.298-.595.442-.03.243.275.339.69.47l.175.055c.408.133.958.288 1.243.294.26.006.549-.1.868-.32 2.179-1.471 3.304-2.214 3.374-2.23.05-.012.12-.026.166.016.047.041.042.12.037.141-.03.129-1.227 1.241-1.846 1.817-.193.18-.33.307-.358.336a8.154 8.154.0 01-.188.186c-.38.366-.664.64.015 1.088.327.216.589.393.85.571.284.194.568.387.936.629.093.06.183.125.27.187.331.236.63.448.997.414.214-.02.435-.22.547-.82.265-1.417.786-4.486.906-5.751a1.426 1.426.0 00-.013-.315.337.337.0 00-.114-.217.526.526.0 00-.31-.093c-.3.005-.763.166-2.984 1.09z"/></svg></div></a><p>加入 Telegram</p></button>
<button class=button_left>
<a data-umami-event="Telegram cloud_native_share" href=https://t.me/cloud_native_share target=_blank><div class=icon_left><svg viewBox="0 0 16 16" class="bi bi-telegram" fill="currentcolor" height="16" width="16" xmlns="http://www.w3.org/2000/svg"><path d="M16 8A8 8 0 110 8a8 8 0 0116 0zM8.287 5.906c-.778.324-2.334.994-4.666 2.01-.378.15-.577.298-.595.442-.03.243.275.339.69.47l.175.055c.408.133.958.288 1.243.294.26.006.549-.1.868-.32 2.179-1.471 3.304-2.214 3.374-2.23.05-.012.12-.026.166.016.047.041.042.12.037.141-.03.129-1.227 1.241-1.846 1.817-.193.18-.33.307-.358.336a8.154 8.154.0 01-.188.186c-.38.366-.664.64.015 1.088.327.216.589.393.85.571.284.194.568.387.936.629.093.06.183.125.27.187.331.236.63.448.997.414.214-.02.435-.22.547-.82.265-1.417.786-4.486.906-5.751a1.426 1.426.0 00-.013-.315.337.337.0 00-.114-.217.526.526.0 00-.31-.093c-.3.005-.763.166-2.984 1.09z"/></svg></div></a><p>黑科技广播站</p></button>
<button class=button_left>
<a data-umami-event="Telegram cloud_native_blogs" href=https://t.me/cloud_native_blogs target=_blank><div class=icon_left><svg viewBox="0 0 16 16" class="bi bi-telegram" fill="currentcolor" height="16" width="16" xmlns="http://www.w3.org/2000/svg"><path d="M16 8A8 8 0 110 8a8 8 0 0116 0zM8.287 5.906c-.778.324-2.334.994-4.666 2.01-.378.15-.577.298-.595.442-.03.243.275.339.69.47l.175.055c.408.133.958.288 1.243.294.26.006.549-.1.868-.32 2.179-1.471 3.304-2.214 3.374-2.23.05-.012.12-.026.166.016.047.041.042.12.037.141-.03.129-1.227 1.241-1.846 1.817-.193.18-.33.307-.358.336a8.154 8.154.0 01-.188.186c-.38.366-.664.64.015 1.088.327.216.589.393.85.571.284.194.568.387.936.629.093.06.183.125.27.187.331.236.63.448.997.414.214-.02.435-.22.547-.82.265-1.417.786-4.486.906-5.751a1.426 1.426.0 00-.013-.315.337.337.0 00-.114-.217.526.526.0 00-.31-.093c-.3.005-.763.166-2.984 1.09z"/></svg></div></a><p>高手博客收藏夹</p></button></div></div><main id=main-content class=grow><article><div id=hero class="h-[150px] md:h-[200px]"></div><div class="fixed inset-x-0 top-0 h-[800px] single_hero_background nozoom" style=background-image:url(/posts/istio-traffic-management-impl-intro/featured_hu82e42c57077cd9164d01addb174abb12_245165_1200x0_resize_q75_box.jpg)><div class="absolute inset-0 bg-gradient-to-t from-neutral dark:from-neutral-800 to-transparent mix-blend-normal"></div><div class="absolute inset-0 opacity-60 bg-gradient-to-t from-neutral dark:from-neutral-800 to-neutral-100 dark:to-neutral-800 mix-blend-normal"></div></div><div id=background-blur class="fixed opacity-0 inset-x-0 top-0 h-full single_hero_background nozoom backdrop-blur-2xl"></div><script>window.addEventListener("scroll",function(){var t=window.pageYOffset||document.documentElement.scrollTop||document.body.scrollTop||0,n=document.getElementById("background-blur");n.style.opacity=t/300})</script><header id=single_header class="mt-5 max-w-prose"><ol class="text-sm text-neutral-500 dark:text-neutral-400 print:hidden"><li class="inline hidden"><a class="hover:underline decoration-neutral-300 dark:underline-neutral-600" href=/>云原生实验室</a><span class="px-1 text-primary-500">/</span></li><li class=inline><a class="hover:underline decoration-neutral-300 dark:underline-neutral-600" href=/posts/>博客</a><span class="px-1 text-primary-500">/</span></li><li class="inline hidden"><a class="hover:underline decoration-neutral-300 dark:underline-neutral-600" href=/posts/istio-traffic-management-impl-intro/>Istio 流量管理实现机制深度解析</a><span class="px-1 text-primary-500">/</span></li></ol><h1 class="mt-0 text-4xl font-extrabold text-neutral-900 dark:text-neutral">Istio 流量管理实现机制深度解析</h1><div class="mt-1 mb-6 text-base text-neutral-500 dark:text-neutral-400 print:hidden"><div class="flex flex-row flex-wrap items-center"><time datetime="2018-10-09 20:00:17 +0800 +0800">2018年10月9日</time><span class="px-2 text-primary-500">&#183;</span><span>10902 字</span><span class="px-2 text-primary-500">&#183;</span><span title=预计阅读>22 分钟</span><span class="px-2 text-primary-500">&#183;</span><span>
<span id=busuanzi_page_pv></span>
<span class="inline-block align-text-bottom"><span class="relative block icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><path fill="currentcolor" d="M288 32c-80.8.0-145.5 36.8-192.6 80.6C48.6 156 17.3 208 2.5 243.7c-3.3 7.9-3.3 16.7.0 24.6C17.3 304 48.6 356 95.4 399.4 142.5 443.2 207.2 480 288 480s145.5-36.8 192.6-80.6c46.8-43.5 78.1-95.4 93-131.1 3.3-7.9 3.3-16.7.0-24.6-14.9-35.7-46.2-87.7-93-131.1C433.5 68.8 368.8 32 288 32zM432 256c0 79.5-64.5 144-144 144s-144-64.5-144-144 64.5-144 144-144 144 64.5 144 144zM288 192c0 35.3-28.7 64-64 64-11.5.0-22.3-3-31.6-8.4-.2 2.8-.4 5.5-.4 8.4.0 53 43 96 96 96s96-43 96-96-43-96-96-96c-2.8.0-5.6.1-8.4.4 5.3 9.3 8.4 20.1 8.4 31.6z"/></svg></span></span></span><span class="px-2 text-primary-500">&#183;</span>
<span class=mb-[2px]><a href=https://github.com/yangchuansheng/blog/tree/main/content/posts/istio-traffic-management-impl-intro/index.md class="text-lg hover:text-primary-500" rel="noopener noreferrer" target=_blank title=编辑内容><span class="inline-block align-text-bottom"><span class="relative block icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M490.3 40.4c21.9 21.87 21.9 57.33.0 79.2l-30 30.1-98-97.98 30.1-30.06C414.3-.2135 449.7-.2135 471.6 21.66L490.3 40.4zM172.4 241.7 339.7 74.34l98 97.96L270.3 339.6C264.2 345.8 256.7 350.4 248.4 353.2l-88.8 29.6C150.1 385.6 141.5 383.4 135 376.1 128.6 370.5 126.4 361 129.2 352.4l29.6-88.8C161.6 255.3 166.2 247.8 172.4 241.7v0zM192 63.1c17.7.0 32 15.23 32 32 0 18.6-14.3 32-32 32H96c-17.67.0-32 15.2-32 32V416c0 17.7 14.33 32 32 32H352c17.7.0 32-14.3 32-32V319.1c0-16.8 14.3-32 32-32s32 15.2 32 32V416c0 53-43 96-96 96H96c-53.02.0-96-43-96-96V159.1c0-53 42.98-96 96-96h96z"/></svg></span></span></a></span></div><div class="flex flex-row flex-wrap items-center"></div><div class="flex flex-row flex-wrap items-center"><span style=margin-top:.5rem class=mr-2 onclick='window.open("/categories/service-mesh/","_self")'><span class=flex><span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">服务网格
</span></span></span><span style=margin-top:.5rem class=mr-2 onclick='window.open("/tags/istio/","_self")'><span class=flex><span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">Istio</span></span></span></div></div><div class=flex><img class="!mt-0 !mb-0 h-24 w-24 rounded-full ltr:mr-4 rtl:ml-4" width=96 height=96 alt=米开朗基杨 src=/img/avatar_hu7a62e3e7bb2f7649c8950e6edda33f38_103483_192x192_fill_box_center_3.png><div class=place-self-center><div class="text-[0.6rem] uppercase leading-3 text-neutral-500 dark:text-neutral-400">作者</div><div class="font-semibold leading-6 text-neutral-800 dark:text-neutral-300">米开朗基杨</div><div class="text-sm text-neutral-700 dark:text-neutral-400">云原生搬砖师 & <a href=https://sealos.run target=_blank>Sealos</a> 开发者布道师 & <a href=https://github.com/labring/FastGPT target=_blank>FastGPT</a> 熟练工</div><div class="text-2xl sm:text-lg"><div class="flex flex-wrap text-neutral-400 dark:text-neutral-500"><a class="px-1 hover:text-primary-700 dark:hover:text-primary-400" href=/index.xml target=_blank aria-label=Rss rel="me noopener noreferrer"><span class="inline-block align-text-bottom"><span class="relative block icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path fill="currentcolor" d="M0 64C0 46.3 14.3 32 32 32c229.8.0 416 186.2 416 416 0 17.7-14.3 32-32 32s-32-14.3-32-32C384 253.6 226.4 96 32 96 14.3 96 0 81.7.0 64zM128 416c0 35.3-28.7 64-64 64S0 451.3.0 416s28.7-64 64-64 64 28.7 64 64zM32 160c159.1.0 288 128.9 288 288 0 17.7-14.3 32-32 32s-32-14.3-32-32c0-123.7-100.3-224-224-224-17.7.0-32-14.3-32-32s14.3-32 32-32z"/></svg></span></span></a><a class="px-1 hover:text-primary-700 dark:hover:text-primary-400" href=https://twitter.com/CarsonYangk8s target=_blank aria-label=X-Twitter rel="me noopener noreferrer"><span class="inline-block align-text-bottom"><span class="relative block icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M389.2 48h70.6L305.6 224.2 487 464H345L233.7 318.6 106.5 464H35.8L200.7 275.5 26.8 48H172.4L272.9 180.9 389.2 48zM364.4 421.8h39.1L151.1 88h-42L364.4 421.8z"/></svg></span></span></a><a class="px-1 hover:text-primary-700 dark:hover:text-primary-400" href=https://jsdelivr.icloudnative.io/gh/yangchuansheng/imghosting5@main/uPic/tmpm1ykjt96.webp target=_blank aria-label=Wechat rel="me noopener noreferrer"><span class="inline-block align-text-bottom"><span class="relative block icon"><svg width="800" height="800" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M11.8088 7.05902C11.3508 7.06746 10.9637 7.45766 10.9718 7.90277 10.9802 8.36421 11.3599 8.7252 11.8309 8.7196 12.3031 8.71385 12.6613 8.3491 12.6568 7.87785 12.6529 7.41534 12.2749 7.05051 11.8088 7.05902zm-4.45801.85655C7.36789 7.47215 6.98366 7.07275 6.52729 7.05933 6.06002 7.04561 5.67572 7.40269 5.66207 7.8632 5.64827 8.32985 6.0052 8.70373 6.47584 8.71569 6.94241 8.72757 7.33354 8.36996 7.35079 7.91557zm8.54451.75542C14.0388 8.76798 12.4244 9.33078 11.1137 10.6023c-1.3243 1.2847-1.92882 2.8588-1.76358 4.8103C8.62446 15.3226 7.96351 15.2237 7.2988 15.1678 7.06924 15.1484 6.7968 15.1759 6.60235 15.2856 5.95689 15.6498 5.33812 16.061 4.60471 16.5195 4.73928 15.9108 4.82638 15.3778 4.98058 14.8652 5.09398 14.4884 5.04146 14.2788 4.69434 14.0333c-2.22866-1.5734-3.1681-3.9282-2.46505-6.35259.65044-2.24277 2.24776-3.60293 4.41815-4.31196C9.60982 2.4011 12.939 3.38815 14.7404 5.74012 15.391 6.58969 15.7899 7.54323 15.8953 8.67099z" fill="currentcolor"/><path d="M17.6884 12.3843C17.3253 12.3818 17.0167 12.6791 17.0019 13.046 16.9861 13.4383 17.2912 13.7605 17.6794 13.7615 18.055 13.7627 18.3517 13.4787 18.3655 13.105 18.38 12.7117 18.0749 12.387 17.6884 12.3843zm-4.3139 1.3819C13.7489 13.7666 14.057 13.4737 14.0711 13.1041 14.0861 12.7127 13.7713 12.3845 13.3795 12.3828 12.9915 12.381 12.6664 12.714 12.6799 13.0994 12.6927 13.4678 13.003 13.7658 13.3745 13.7662zm6.6919 6.479C19.4785 19.9835 18.9392 19.5907 18.3652 19.5308 17.7932 19.471 17.1919 19.801 16.5936 19.8622 14.771 20.0486 13.138 19.5407 11.7916 18.2956 9.23081 15.927 9.59671 12.2954 12.5594 10.3543c2.6331-1.72503 6.4948-1.14995 8.3513 1.2437C22.5307 13.6866 22.3403 16.4592 20.3626 18.2139 19.7903 18.7217 19.5843 19.1397 19.9515 19.809 20.0193 19.9326 20.027 20.0891 20.0664 20.2452z" fill="currentcolor"/></svg></span></span></a><a class="px-1 hover:text-primary-700 dark:hover:text-primary-400" href=https://github.com/yangchuansheng target=_blank aria-label=Github rel="me noopener noreferrer"><span class="inline-block align-text-bottom"><span class="relative block icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><path fill="currentcolor" d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6.0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6.0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3.0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1.0-6.2-.3-40.4-.3-61.4.0.0-70 15-84.7-29.8.0.0-11.4-29.1-27.8-36.6.0.0-22.9-15.7 1.6-15.4.0.0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5.0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9.0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4.0 33.7-.3 75.4-.3 83.6.0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6.0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9.0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg></span></span></a><a class="px-1 hover:text-primary-700 dark:hover:text-primary-400" href=https://t.me/cloudnativer target=_blank aria-label=Telegram rel="me noopener noreferrer"><span class="inline-block align-text-bottom"><span class="relative block icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><path fill="currentcolor" d="M248 8C111.033 8 0 119.033.0 256S111.033 504 248 504 496 392.967 496 256 384.967 8 248 8zM362.952 176.66c-3.732 39.215-19.881 134.378-28.1 178.3-3.476 18.584-10.322 24.816-16.948 25.425-14.4 1.326-25.338-9.517-39.287-18.661-21.827-14.308-34.158-23.215-55.346-37.177-24.485-16.135-8.612-25 5.342-39.5 3.652-3.793 67.107-61.51 68.335-66.746.153-.655.3-3.1-1.154-4.384s-3.59-.849-5.135-.5q-3.283.746-104.608 69.142-14.845 10.194-26.894 9.934c-8.855-.191-25.888-5.006-38.551-9.123-15.531-5.048-27.875-7.717-26.8-16.291q.84-6.7 18.45-13.7 108.446-47.248 144.628-62.3c68.872-28.647 83.183-33.623 92.511-33.789 2.052-.034 6.639.474 9.61 2.885a10.452 10.452.0 013.53 6.716A43.765 43.765.0 01362.952 176.66z"/></svg></span></span></a></div></div></div></div><div class=mb-5></div></header><section class="flex flex-col max-w-full mt-0 prose dark:prose-invert lg:flex-row"><div class="order-first sm:max-w-prose lg:ml-auto px-0 lg:order-last lg:max-w-xs ltr:lg:pl-8 rtl:lg:pr-8"><div class="toc ltr:pl-5 rtl:pr-5 print:hidden lg:sticky lg:top-[140px]"><details open class="mt-0 overflow-hidden rounded-lg ltr:-ml-5 ltr:pl-5 rtl:-mr-5 rtl:pr-5 hidden lg:block"><summary class="block py-1 text-lg font-semibold cursor-pointer bg-neutral-100 text-neutral-800 ltr:-ml-5 ltr:pl-5 rtl:-mr-5 rtl:pr-5 dark:bg-neutral-700 dark:text-neutral-100 lg:hidden">Table of Contents</summary><div class="min-w-[220px] py-2 border-dotted border-neutral-300 ltr:-ml-5 ltr:border-l ltr:pl-5 rtl:-mr-5 rtl:border-r rtl:pr-5 dark:border-neutral-600"><nav id=TableOfContents><ul><li><a href=#前言>前言</a></li><li><a href=#pilot高层架构>Pilot高层架构</a><ul><li><a href=#统一的服务模型>统一的服务模型</a></li><li><a href=#标准数据平面-api>标准数据平面 API</a></li><li><a href=#业务-dsl-语言>业务 DSL 语言</a></li></ul></li><li><a href=#istio-流量管理相关组件>Istio 流量管理相关组件</a><ul><li><a href=#控制平面组件>控制平面组件</a><ul><li><a href=#discovery-services>Discovery Services</a></li><li><a href=#k8s-api-server>K8S API Server</a></li></ul></li><li><a href=#数据平面组件>数据平面组件</a><ul><li><a href=#pilot-agent>Pilot-agent</a></li><li><a href=#envoy>Envoy</a></li></ul></li><li><a href=#命令行工具>命令行工具</a></li></ul></li><li><a href=#数据平面标准-api>数据平面标准 API</a><ul><li><a href=#基本概念和术语>基本概念和术语</a></li><li><a href=#xds-服务接口>XDS 服务接口</a></li><li><a href=#xds-服务接口的最终一致性考虑>XDS 服务接口的最终一致性考虑</a></li><li><a href=#ads-聚合发现服务>ADS 聚合发现服务</a></li></ul></li><li><a href=#bookinfo-示例程序分析>Bookinfo 示例程序分析</a><ul><li><a href=#bookinfo-程序结构>Bookinfo 程序结构</a></li><li><a href=#xds-接口调试方法>xDS 接口调试方法</a><ul><li><a href=#pilot-调试方法>Pilot 调试方法</a></li><li><a href=#envoy-调试方法>Envoy 调试方法</a></li></ul></li><li><a href=#envoy-启动过程分析>Envoy 启动过程分析</a><ul><li><a href=#proxy_init>Proxy_init</a></li><li><a href=#proxyv2>Proxyv2</a></li><li><a href=#envoy-初始配置文件>Envoy 初始配置文件</a></li></ul></li><li><a href=#envoy-配置分析>Envoy 配置分析</a><ul><li><a href=#通过管理接口获取完整配置>通过管理接口获取完整配置</a></li><li><a href=#envoy-配置文件结构>Envoy 配置文件结构</a></li></ul></li><li><a href=#bookinfo-端到端调用分析>Bookinfo 端到端调用分析</a></li></ul></li><li><a href=#小结>小结</a></li><li><a href=#参考资料>参考资料</a></li></ul></nav></div></details><details class="mt-0 overflow-hidden rounded-lg ltr:-ml-5 ltr:pl-5 rtl:-mr-5 rtl:pr-5 lg:hidden"><summary class="py-1 text-lg font-semibold cursor-pointer bg-neutral-100 text-neutral-800 ltr:-ml-5 ltr:pl-5 rtl:-mr-5 rtl:pr-5 dark:bg-neutral-700 dark:text-neutral-100 lg:hidden">Table of Contents</summary><div class="py-2 border-dotted border-neutral-300 ltr:-ml-5 ltr:border-l ltr:pl-5 rtl:-mr-5 rtl:border-r rtl:pr-5 dark:border-neutral-600"><nav id=TableOfContents><ul><li><a href=#前言>前言</a></li><li><a href=#pilot高层架构>Pilot高层架构</a><ul><li><a href=#统一的服务模型>统一的服务模型</a></li><li><a href=#标准数据平面-api>标准数据平面 API</a></li><li><a href=#业务-dsl-语言>业务 DSL 语言</a></li></ul></li><li><a href=#istio-流量管理相关组件>Istio 流量管理相关组件</a><ul><li><a href=#控制平面组件>控制平面组件</a><ul><li><a href=#discovery-services>Discovery Services</a></li><li><a href=#k8s-api-server>K8S API Server</a></li></ul></li><li><a href=#数据平面组件>数据平面组件</a><ul><li><a href=#pilot-agent>Pilot-agent</a></li><li><a href=#envoy>Envoy</a></li></ul></li><li><a href=#命令行工具>命令行工具</a></li></ul></li><li><a href=#数据平面标准-api>数据平面标准 API</a><ul><li><a href=#基本概念和术语>基本概念和术语</a></li><li><a href=#xds-服务接口>XDS 服务接口</a></li><li><a href=#xds-服务接口的最终一致性考虑>XDS 服务接口的最终一致性考虑</a></li><li><a href=#ads-聚合发现服务>ADS 聚合发现服务</a></li></ul></li><li><a href=#bookinfo-示例程序分析>Bookinfo 示例程序分析</a><ul><li><a href=#bookinfo-程序结构>Bookinfo 程序结构</a></li><li><a href=#xds-接口调试方法>xDS 接口调试方法</a><ul><li><a href=#pilot-调试方法>Pilot 调试方法</a></li><li><a href=#envoy-调试方法>Envoy 调试方法</a></li></ul></li><li><a href=#envoy-启动过程分析>Envoy 启动过程分析</a><ul><li><a href=#proxy_init>Proxy_init</a></li><li><a href=#proxyv2>Proxyv2</a></li><li><a href=#envoy-初始配置文件>Envoy 初始配置文件</a></li></ul></li><li><a href=#envoy-配置分析>Envoy 配置分析</a><ul><li><a href=#通过管理接口获取完整配置>通过管理接口获取完整配置</a></li><li><a href=#envoy-配置文件结构>Envoy 配置文件结构</a></li></ul></li><li><a href=#bookinfo-端到端调用分析>Bookinfo 端到端调用分析</a></li></ul></li><li><a href=#小结>小结</a></li><li><a href=#参考资料>参考资料</a></li></ul></nav></div></details><script>(function(){var t,e=$("#TableOfContents");if(e.length>0){t=$(window);function n(){var s,o=t.scrollTop(),i=$(".anchor"),n="";if(i.each(function(e,t){t=$(t),t.offset().top-$(window).height()/3<=o&&(n=t.attr("id"))}),s=e.find("a.active"),s.length==1&&s.eq(0).attr("href")=="#"+n)return!0;s.each(function(e,t){$(t).removeClass("active")}),e.find('a[href="#'+n+'"]').addClass("active"),e.find('a[href="#'+n+'"]').parentsUntil("#TableOfContents").each(function(e,t){$(t).children("a").parents("ul").show()})}t.on("scroll",n),$(document).ready(function(){n()})}})()</script></div></div><div class="min-w-0 min-h-0 max-w-fit"><style>.slideContent{width:80%;@media(max-width:600px){width: 100%;}&>* { user-select: none; } .swiper-slide { a { height: 100%; } img { height: 100%; object-fit: cover; } }}.swiper,swiper-container{margin-left:inherit!important;margin-bottom:-30px}</style><link rel=stylesheet href=https://cdn.staticfile.org/Swiper/9.0.2/swiper-bundle.min.css><script src=https://cdn.staticfile.org/Swiper/9.0.2/swiper-bundle.min.js></script><div class="swiper slideContent" id=slider><div class=swiper-wrapper><div class=swiper-slide><a data-umami-event=gptgod href="https://gptgod.online/#/register?invite_code=46rrqz6qzscsey1jci7sdjw95" target=_blank><img class=nozoom id=support-img src=https://jsdelivr.icloudnative.io/gh/yangchuansheng/imghosting5@main/uPic/2023-09-15-12-36-W4I1A8.png style=border:none;width:100%;max-width:100%;display:inline-block></a></div><div class=swiper-slide><a data-umami-event=FastGPT href="https://ai.fastgpt.in/?inviterId=64215e9914d068bf840141d0" target=_blank><img class=nozoom id=support-img src="https://socialify.git.ci/labring/fastgpt/image?description=1&amp;descriptionEditable=%E5%9F%BA%E4%BA%8E%20LLM%20%E5%A4%A7%E8%AF%AD%E8%A8%80%E6%A8%A1%E5%9E%8B%E7%9A%84%E7%9F%A5%E8%AF%86%E5%BA%93%E9%97%AE%E7%AD%94%E7%B3%BB%E7%BB%9F%EF%BC%8C%E6%8F%90%E4%BE%9B%E5%BC%80%E7%AE%B1%E5%8D%B3%E7%94%A8%E7%9A%84%E6%95%B0%E6%8D%AE%E5%A4%84%E7%90%86%E3%80%81%E6%A8%A1%E5%9E%8B%E8%B0%83%E7%94%A8%E7%AD%89%E8%83%BD%E5%8A%9B%E3%80%82&amp;font=Raleway&amp;forks=1&amp;logo=https%3A%2F%2Fjsdelivr.icloudnative.io%2Fgh%2Flabring%2FFastGPT%40main%2F.github%2Fimgs%2Flogo.svg&amp;name=1&amp;pattern=Brick%20Wall&amp;stargazers=1&amp;theme=Light" style=border:none;width:100%;max-width:100%;display:inline-block></a></div><div class=swiper-slide><a data-umami-event=Laf href=https://github.com/labring/laf target=_blank><img class=nozoom id=support-img src="https://socialify.git.ci/labring/laf/image?description=1&amp;descriptionEditable=Laf%20%E6%98%AF%E4%B8%80%E4%B8%AA%20Serverless%20%E6%A1%86%E6%9E%B6%EF%BC%8C%E6%8F%90%E4%BE%9B%E5%BC%80%E7%AE%B1%E5%8D%B3%E7%94%A8%E7%9A%84%E4%BA%91%E5%87%BD%E6%95%B0%EF%BC%8C%E4%BA%91%E6%95%B0%E6%8D%AE%E5%BA%93%EF%BC%8C%E5%AF%B9%E8%B1%A1%E5%AD%98%E5%82%A8%E7%AD%89%E8%83%BD%E5%8A%9B%E3%80%82%E8%AE%A9%E5%BC%80%E5%8F%91%E8%80%85%E4%B8%93%E6%B3%A8%E4%BA%8E%E4%B8%9A%E5%8A%A1%E5%BC%80%E5%8F%91%EF%BC%8C%E6%97%A0%E9%9C%80%E6%8A%98%E8%85%BE%E6%9C%8D%E5%8A%A1%E5%99%A8%EF%BC%8C%E5%BF%AB%E9%80%9F%E9%87%8A%E6%94%BE%E5%88%9B%E6%84%8F%E3%80%82&amp;font=Raleway&amp;forks=1&amp;logo=https%3A%2F%2Fjsdelivr.icloudnative.io%2Fgh%2Fyangchuansheng%2Fimghosting-test%40main%2FuPic%2F2023-11-13-11-33-rI41Bu.svg&amp;name=1&amp;pattern=Brick%20Wall&amp;stargazers=1&amp;theme=Light" style=border:none;width:100%;max-width:100%;display:inline-block></a></div><div class=swiper-slide><a data-umami-event href=https://jsdelivr.icloudnative.io/gh/yangchuansheng/imghosting@master/img/20200430221955.png target=_blank><img class=nozoom id=support-img src=https://jsdelivr.icloudnative.io/gh/yangchuansheng/imghosting5@main/uPic/2023-02-05-16-18-ofcgZS.png style=border:none;width:100%;max-width:100%;display:inline-block></a></div></div><div class=swiper-button-prev></div><div class=swiper-button-next></div></div><script>var mySwiper=new Swiper("#slider",{direction:"horizontal",loop:!0,autoplay:{delay:5e3},navigation:{nextEl:".swiper-button-next",prevEl:".swiper-button-prev"}})</script><div class="max-w-prose mb-20"><blockquote><p>本文转载自<a href=https://zhaohuabing.com/post/2018-09-25-istio-traffic-management-impl-intro/ target=_blank>赵化冰的博客</a></p></blockquote><div id=前言 class=anchor></div><h2 class="relative group">前言
<span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%e5%89%8d%e8%a8%80 aria-label=锚点>#</a></span></h2><hr><p>Istio 作为一个 service mesh 开源项目,其中最重要的功能就是对网格中微服务之间的流量进行管理,包括服务发现,请求路由和服务间的可靠通信。Istio 实现了 service mesh 的控制平面，并整合 Envoy 开源项目作为数据平面的 sidecar，一起对流量进行控制。</p><p>Istio 体系中流量管理配置下发以及流量规则如何在数据平面生效的机制相对比较复杂，通过官方文档容易管中窥豹，难以了解其实现原理。本文尝试结合系统架构、配置文件和代码对 Istio 流量管理的架构和实现机制进行分析，以达到从整体上理解 Pilot 和 Envoy 的流量管理机制的目的。</p><div id=pilot高层架构 class=anchor></div><h2 class="relative group">Pilot高层架构
<span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#pilot%e9%ab%98%e5%b1%82%e6%9e%b6%e6%9e%84 aria-label=锚点>#</a></span></h2><hr><p>Istio 控制平面中负责流量管理的组件为 <code>Pilot</code>，Pilot 的高层架构如下图所示：</p><p><figure><img loading=lazy class="my-0 rounded-md" src=https://jsdelivr.icloudnative.io/gh/yangchuansheng/imghosting6@main/uPic/5Zywav.jpg alt><figcaption>Pilot Architecture（来自 <a href=https://istio.io/docs/concepts/traffic-management/ target=_blank>Isio官网文档</a>)</figcaption></figure></p><p>根据上图,Pilot 主要实现了下述功能：</p><div id=统一的服务模型 class=anchor></div><h3 class="relative group">统一的服务模型
<span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%e7%bb%9f%e4%b8%80%e7%9a%84%e6%9c%8d%e5%8a%a1%e6%a8%a1%e5%9e%8b aria-label=锚点>#</a></span></h3><p>Pilot 定义了网格中服务的标准模型，这个标准模型独立于各种底层平台。由于有了该标准模型，各个不同的平台可以通过适配器和 Pilot 对接，将自己特有的服务数据格式转换为标准格式，填充到 Pilot 的标准模型中。</p><p>例如 Pilot 中的 Kubernetes 适配器通过 <code>Kubernetes API</code> 服务器得到 kubernetes 中 service 和 pod 的相关信息，然后翻译为标准模型提供给 Pilot 使用。通过适配器模式，Pilot 还可以从 <code>Mesos</code>, <code>Cloud Foundry</code>, <code>Consul</code> 等平台中获取服务信息，还可以开发适配器将其他提供服务发现的组件集成到 Pilot 中。</p><div id=标准数据平面-api class=anchor></div><h3 class="relative group">标准数据平面 API
<span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%e6%a0%87%e5%87%86%e6%95%b0%e6%8d%ae%e5%b9%b3%e9%9d%a2-api aria-label=锚点>#</a></span></h3><p>Pilot 使用了一套起源于 Envoy 项目的标准数据平面 API 来将服务信息和流量规则下发到数据平面的 <code>sidecar</code> 中。</p><p>通过采用该标准 API，Istio 将控制平面和数据平面进行了解耦，为多种数据平面 sidecar 实现提供了可能性。事实上基于该标准 API 已经实现了多种 Sidecar 代理和 Istio 的集成，除 Istio 目前集成的 Envoy 外，还可以和 <code>Linkerd</code>, <code>Nginmesh</code> 等第三方通信代理进行集成，也可以基于该 API 自己编写 Sidecar 实现。</p><p>控制平面和数据平面解耦是 Istio 后来居上，风头超过 Service mesh 鼻祖 <code>Linkerd</code> 的一招妙棋。Istio 站在了控制平面的高度上，而 Linkerd 则成为了可选的一种 sidecar 实现，可谓<strong>降维打击</strong>的一个典型成功案例！</p><p>数据平面标准 API 也有利于生态圈的建立，开源、商业的各种 sidecar 以后可能百花齐放，用户也可以根据自己的业务场景选择不同的 sidecar 和控制平面集成，如高吞吐量的，低延迟的，高安全性的等等。有实力的大厂商可以根据该 API 定制自己的 sidecar，例如蚂蚁金服开源的 Golang 版本的 Sidecar <code>MOSN</code>(Modular Observable Smart Netstub)（<code>SOFAMesh</code> 中 Golang 版本的 Sidecar)；小厂商则可以考虑采用成熟的开源项目或者提供服务的商业 sidecar 实现。</p><p id=blockquote>Istio 和 Envoy 项目联合制定了 <code>Envoy V2 API</code>,并采用该 API 作为 Istio 控制平面和数据平面流量管理的标准接口。</p><div id=业务-dsl-语言 class=anchor></div><h3 class="relative group">业务 DSL 语言
<span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%e4%b8%9a%e5%8a%a1-dsl-%e8%af%ad%e8%a8%80 aria-label=锚点>#</a></span></h3><p>Pilot 还定义了一套 <code>DSL</code>（Domain Specific Language）语言，DSL 语言提供了面向业务的高层抽象，可以被运维人员理解和使用。运维人员使用该 DSL 定义流量规则并下发到 Pilot，这些规则被 Pilot 翻译成数据平面的配置，再通过标准 API 分发到 Envoy 实例，可以在运行期对微服务的流量进行控制和调整。</p><p>Pilot 的规则 DSL 是采用 K8S API Server 中的 <a href=https://kubernetes.io/docs/concepts/extend-kubernetes/api-extension/custom-resources/ target=_blank>Custom Resource (CRD)</a> 实现的，因此和其他资源类型如 Service，Pod 和 Deployment 的创建和使用方法类似，都可以用 <code>Kubectl</code> 进行创建。</p><p>通过运用不同的流量规则，可以对网格中微服务进行精细化的流量控制，如按版本分流，断路器，故障注入，灰度发布等。</p><div id=istio-流量管理相关组件 class=anchor></div><h2 class="relative group">Istio 流量管理相关组件
<span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#istio-%e6%b5%81%e9%87%8f%e7%ae%a1%e7%90%86%e7%9b%b8%e5%85%b3%e7%bb%84%e4%bb%b6 aria-label=锚点>#</a></span></h2><hr><p>我们可以通过下图了解 Istio 流量管理涉及到的相关组件。虽然该图来自 <code>Istio Github old pilot repo</code>, 但图中描述的组件及流程和目前 Pilot 的最新代码的架构基本是一致的。</p><p><figure><img loading=lazy class="my-0 rounded-md" src=https://jsdelivr.icloudnative.io/gh/yangchuansheng/imghosting6@main/uPic/dCSUXw.jpg alt><figcaption>Pilot Design Overview (来自 <a href=https://github.com/istio/old_pilot_repo/blob/master/doc/design.md target=_blank>Istio old_pilot_repo</a>)</figcaption></figure></p><p>图例说明：图中<font color=red>红色</font>的线表示控制流，<strong>黑色</strong>的线表示数据流。<strong>蓝色</strong>部分为和Pilot相关的组件。</p><p>从上图可以看到，Istio 中和流量管理相关的有以下组件：</p><div id=控制平面组件 class=anchor></div><h3 class="relative group">控制平面组件
<span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%e6%8e%a7%e5%88%b6%e5%b9%b3%e9%9d%a2%e7%bb%84%e4%bb%b6 aria-label=锚点>#</a></span></h3><div id=discovery-services class=anchor></div><h4 class="relative group">Discovery Services
<span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#discovery-services aria-label=锚点>#</a></span></h4><p>对应的 docker 镜像为 <code>gcr.io/istio-release/pilot</code>,进程为 <code>pilot-discovery</code>，该组件的功能包括：</p><ul><li>从 <code>Service provider</code>（如kubernetes或者consul）中获取服务信息</li><li>从 K8S API Server 中获取流量规则（K8S CRD Resource）</li><li>将服务信息和流量规则转化为数据平面可以理解的格式，通过标准的数据平面 API 下发到网格中的各个 sidecar 中</li></ul><div id=k8s-api-server class=anchor></div><h4 class="relative group">K8S API Server
<span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#k8s-api-server aria-label=锚点>#</a></span></h4><p>提供 Pilot 相关的 CRD Resource 的增、删、改、查。和 Pilot 相关的 <code>CRD</code> 有以下几种：</p><ul><li><span id=inline-blue>Virtualservice</span> : 用于定义路由规则，如根据来源或 Header 制定规则，或在不同服务版本之间分拆流量。</li><li><span id=inline-blue>DestinationRule</span> : 定义目的服务的配置策略以及可路由子集。策略包括断路器、负载均衡以及 TLS 等。</li><li><span id=inline-blue>ServiceEntry</span> : 用 <a href=https://istio.io/docs/reference/config/istio.networking.v1alpha3/#ServiceEntry target=_blank>ServiceEntry</a> 可以向 Istio 中加入附加的服务条目，以使网格内可以向 Istio 服务网格之外的服务发出请求。</li><li><span id=inline-blue>Gateway</span> : 为网格配置网关，以允许一个服务可以被网格外部访问。</li><li><span id=inline-blue>EnvoyFilter</span> : 可以为 Envoy 配置过滤器。由于 Envoy 已经支持 <code>Lua</code> 过滤器，因此可以通过 <code>EnvoyFilter</code> 启用 Lua 过滤器，动态改变 Envoy 的过滤链行为。我之前一直在考虑如何才能动态扩展 Envoy 的能力，EnvoyFilter 提供了很灵活的扩展性。</li></ul><div id=数据平面组件 class=anchor></div><h3 class="relative group">数据平面组件
<span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%e6%95%b0%e6%8d%ae%e5%b9%b3%e9%9d%a2%e7%bb%84%e4%bb%b6 aria-label=锚点>#</a></span></h3><p>在数据平面有两个进程 <code>Pilot-agent</code> 和 <code>envoy</code>，这两个进程被放在一个 docker 容器 <code>gcr.io/istio-release/proxyv2</code> 中。</p><div id=pilot-agent class=anchor></div><h4 class="relative group">Pilot-agent
<span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#pilot-agent aria-label=锚点>#</a></span></h4><p>该进程根据 K8S API Server 中的配置信息生成 Envoy 的配置文件，并负责启动 Envoy 进程。注意 Envoy 的大部分配置信息都是通过 <code>xDS</code> 接口从 Pilot 中动态获取的，因此 Agent 生成的只是用于初始化 Envoy 的少量静态配置。在后面的章节中，本文将对 Agent 生成的 Envoy 配置文件进行进一步分析。</p><div id=envoy class=anchor></div><h4 class="relative group">Envoy
<span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#envoy aria-label=锚点>#</a></span></h4><p>Envoy 由 <code>Pilot-agent</code> 进程启动，启动后，Envoy 读取 Pilot-agent 为它生成的配置文件，然后根据该文件的配置获取到 Pilot 的地址，通过数据平面标准 API 的 xDS 接口从 pilot 拉取动态配置信息，包括路由（route），监听器（listener），服务集群（cluster）和服务端点（endpoint）。Envoy 初始化完成后，就根据这些配置信息对微服务间的通信进行寻址和路由。</p><div id=命令行工具 class=anchor></div><h3 class="relative group">命令行工具
<span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%e5%91%bd%e4%bb%a4%e8%a1%8c%e5%b7%a5%e5%85%b7 aria-label=锚点>#</a></span></h3><p><code>kubectl</code> 和 <code>istioctl</code>，由于 Istio 的配置是基于 K8S 的 <code>CRD</code>，因此可以直接采用 kubectl 对这些资源进行操作。Istioctl 则针对 Istio 对 CRD 的操作进行了一些封装。Istioctl 支持的功能参见该 <a href=https://istio.io/docs/reference/commands/istioctl target=_blank>表格</a>。</p><div id=数据平面标准-api class=anchor></div><h2 class="relative group">数据平面标准 API
<span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%e6%95%b0%e6%8d%ae%e5%b9%b3%e9%9d%a2%e6%a0%87%e5%87%86-api aria-label=锚点>#</a></span></h2><hr><p>前面讲到，Pilot 采用了一套标准的 API 来向数据平面 Sidecar 提供服务发现，负载均衡池和路由表等流量管理的配置信息。该标准 API 的文档参见 <a href=https://www.envoyproxy.io/docs/envoy/latest/configuration/overview/v2_overview target=_blank>Envoy v2 API</a>。<a href=https://github.com/envoyproxy/data-plane-api/tree/master/envoy/api/v2 target=_blank>Data Plane API Protocol Buffer Definition</a> 给出了 <code>v2 grpc</code> 接口相关的数据结构和接口定义。</p><p id=blockquote>Istio 早期采用了 Envoy v1 API，目前的版本中则使用 V2 API，V1 已被废弃。</p><div id=基本概念和术语 class=anchor></div><h3 class="relative group">基本概念和术语
<span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%e5%9f%ba%e6%9c%ac%e6%a6%82%e5%bf%b5%e5%92%8c%e6%9c%af%e8%af%ad aria-label=锚点>#</a></span></h3><p>首先我们需要了解数据平面 API 中涉及到的一些基本概念：</p><ul><li><code>Host</code> ：能够进行网络通信的实体（如移动设备、服务器上的应用程序）。在此文档中，主机是逻辑网络应用程序。一块物理硬件上可能运行有多个主机，只要它们是可以独立寻址的。在 EDS 接口中，也使用 <code>Endpoint</code> 来表示一个应用实例，对应一个 IP+Port 的组合。</li><li><code>Downstream</code> : 下游主机连接到 Envoy，发送请求并接收响应。</li><li><code>Upstream</code> : 上游主机接收来自 Envoy 的连接和请求，并返回响应。</li><li><code>Listener</code> : 监听器是命名网地址（例如，端口、unix domain socket 等)，可以被下游客户端连接。Envoy 暴露一个或者多个监听器给下游主机连接。在 Envoy 中，Listener 可以绑定到端口上直接对外服务，也可以不绑定到端口上，而是接收其他 listener 转发的请求。</li><li><code>Cluster</code> : 集群是指 Envoy 连接到的逻辑上相同的一组上游主机。Envoy 通过服务发现来发现集群的成员。可以选择通过主动健康检查来确定集群成员的健康状态。Envoy 通过负载均衡策略决定将请求路由到哪个集群成员。</li></ul><div id=xds-服务接口 class=anchor></div><h3 class="relative group">XDS 服务接口
<span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#xds-%e6%9c%8d%e5%8a%a1%e6%8e%a5%e5%8f%a3 aria-label=锚点>#</a></span></h3><p>Istio 数据平面 API 定义了 xDS 服务接口，Pilot 通过该接口向数据平面 sidecar 下发动态配置信息，以对 Mesh 中的数据流量进行控制。xDS 中的 DS 表示 <code>discovery service</code>，即发现服务，表示 <code>xDS</code> 接口使用动态发现的方式提供数据平面所需的配置数据。而 x 则是一个代词，表示有多种 discover service。这些发现服务及对应的数据结构如下：</p><ul><li><code>LDS</code> (Listener Discovery Service) : <a href=https://github.com/envoyproxy/data-plane-api/blob/master/envoy/api/v2/lds.proto target=_blank>envoy.api.v2.Listener</a></li><li><code>CDS</code> (Cluster Discovery Service) : <a href=https://github.com/envoyproxy/data-plane-api/blob/master/envoy/api/v2/rds.proto target=_blank>envoy.api.v2.RouteConfiguration</a></li><li><code>EDS</code> (Endpoint Discovery Service) : <a href=https://github.com/envoyproxy/data-plane-api/blob/master/envoy/api/v2/cds.proto target=_blank>envoy.api.v2.Cluster</a></li><li><code>RDS</code> (Route Discovery Service) : <a href=https://github.com/envoyproxy/data-plane-api/blob/master/envoy/api/v2/eds.proto target=_blank>envoy.api.v2.ClusterLoadAssignment</a></li></ul><div id=xds-服务接口的最终一致性考虑 class=anchor></div><h3 class="relative group">XDS 服务接口的最终一致性考虑
<span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#xds-%e6%9c%8d%e5%8a%a1%e6%8e%a5%e5%8f%a3%e7%9a%84%e6%9c%80%e7%bb%88%e4%b8%80%e8%87%b4%e6%80%a7%e8%80%83%e8%99%91 aria-label=锚点>#</a></span></h3><p>xDS 的几个接口是相互独立的，接口下发的配置数据是最终一致的。但在配置更新过程中，可能暂时出现各个接口的数据不匹配的情况，从而导致部分流量在更新过程中丢失。</p><p>设想这种场景：在 <code>CDS/EDS</code> 只知道 cluster X 的情况下，<code>RDS</code> 的一条路由配置将指向Cluster X 的流量调整到了 Cluster Y。在 CDS/EDS 向 Mesh 中 Envoy 提供 Cluster Y 的更新前，这部分导向 Cluster Y 的流量将会因为 Envoy 不知道 Cluster Y 的信息而被丢弃。</p><p>对于某些应用来说，短暂的部分流量丢失是可以接受的，例如客户端重试可以解决该问题，并不影响业务逻辑。对于另一些场景来说，这种情况可能无法容忍。可以通过调整 xDS 接口的更新逻辑来避免该问题，对上面的情况，可以先通过 CDS/EDS 更新 Y Cluster，然后再通过 RDS 将 X 的流量路由到Y。</p><p>一般来说，为了避免 Envoy 配置数据更新过程中出现流量丢失的情况，xDS 接口应采用下面的顺序：</p><ol><li><code>CDS</code> 首先更新 <code>Cluster</code> 数据（如果有变化）</li><li><code>EDS</code> 更新相应 Cluster 的 <code>Endpoint</code> 信息（如果有变化）</li><li><code>LDS</code> 更新 CDS/EDS 相应的 <code>Listener</code></li><li><code>RDS</code> 最后更新新增 Listener 相关的 <code>Route</code> 配置</li><li>删除不再使用的 CDS cluster 和 EDS endpoints</li></ol><div id=ads-聚合发现服务 class=anchor></div><h3 class="relative group">ADS 聚合发现服务
<span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#ads-%e8%81%9a%e5%90%88%e5%8f%91%e7%8e%b0%e6%9c%8d%e5%8a%a1 aria-label=锚点>#</a></span></h3><p>保证控制平面下发数据一致性，避免流量在配置更新过程中丢失的另一个方式是使用 ADS(Aggregated Discovery Services)，即聚合的发现服务。<code>ADS</code> 通过一个 gRPC 流来发布所有的配置更新，以保证各个 xDS 接口的调用顺序，避免由于 xDS 接口更新顺序导致的配置数据不一致问题。</p><p>关于 XDS 接口的详细介绍可参考 <a href=https://github.com/envoyproxy/data-plane-api/blob/master/XDS_PROTOCOL.md target=_blank>xDS REST and gRPC protocol</a></p><div id=bookinfo-示例程序分析 class=anchor></div><h2 class="relative group">Bookinfo 示例程序分析
<span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#bookinfo-%e7%a4%ba%e4%be%8b%e7%a8%8b%e5%ba%8f%e5%88%86%e6%9e%90 aria-label=锚点>#</a></span></h2><hr><p>下面我们以 <code>Bookinfo</code> 为例对 Istio 中的流量管理实现机制，以及控制平面和数据平面的交互进行进一步分析。</p><div id=bookinfo-程序结构 class=anchor></div><h3 class="relative group">Bookinfo 程序结构
<span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#bookinfo-%e7%a8%8b%e5%ba%8f%e7%bb%93%e6%9e%84 aria-label=锚点>#</a></span></h3><p>下图显示了 Bookinfo 示例程序中各个组件的 IP 地址，端口和调用关系，以用于后续的分析。</p><p><figure><img loading=lazy class="my-0 rounded-md" src=https://jsdelivr.icloudnative.io/gh/yangchuansheng/imghosting6@main/uPic/fONobF.jpg alt></figure></p><div id=xds-接口调试方法 class=anchor></div><h3 class="relative group">xDS 接口调试方法
<span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#xds-%e6%8e%a5%e5%8f%a3%e8%b0%83%e8%af%95%e6%96%b9%e6%b3%95 aria-label=锚点>#</a></span></h3><p>首先我们看看如何对 xDS 接口的相关数据进行查看和分析。Envoy v2 接口采用了 <code>gRPC</code>，由于 gRPC 是基于二进制的 RPC 协议，无法像 V1 的 <code>REST</code> 接口一样通过 curl 和浏览器进行进行分析。但我们还是可以通过 Pilot 和 Envoy 的调试接口查看 xDS 接口的相关数据。</p><div id=pilot-调试方法 class=anchor></div><h4 class="relative group">Pilot 调试方法
<span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#pilot-%e8%b0%83%e8%af%95%e6%96%b9%e6%b3%95 aria-label=锚点>#</a></span></h4><p>Pilot 在 <code>9093</code> 端口提供了下述 <a href=https://github.com/istio/istio/tree/master/pilot/pkg/proxy/envoy/v2 target=_blank>调试接口</a> 下述方法查看 xDS 接口相关数据。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nv>PILOT</span><span class=o>=</span>istio-pilot.istio-system:9093
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># What is sent to envoy</span>
</span></span><span class=line><span class=cl><span class=c1># Listeners and routes</span>
</span></span><span class=line><span class=cl>curl <span class=nv>$PILOT</span>/debug/adsz
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Endpoints</span>
</span></span><span class=line><span class=cl>curl <span class=nv>$PILOT</span>/debug/edsz
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Clusters</span>
</span></span><span class=line><span class=cl>curl <span class=nv>$PILOT</span>/debug/cdsz
</span></span></code></pre></div><div id=envoy-调试方法 class=anchor></div><h4 class="relative group">Envoy 调试方法
<span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#envoy-%e8%b0%83%e8%af%95%e6%96%b9%e6%b3%95 aria-label=锚点>#</a></span></h4><p>Envoy 提供了管理接口，缺省为 localhost 的 <code>15000</code> 端口，可以获取 listener，cluster 以及完整的配置数据导出功能。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ kubectl <span class=nb>exec</span> productpage-v1-54b8b9f55-bx2dq -c istio-proxy curl http://127.0.0.1:15000/help
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  /: Admin home page
</span></span><span class=line><span class=cl>  /certs: print certs on machine
</span></span><span class=line><span class=cl>  /clusters: upstream cluster status
</span></span><span class=line><span class=cl>  /config_dump: dump current Envoy configs <span class=o>(</span>experimental<span class=o>)</span>
</span></span><span class=line><span class=cl>  /cpuprofiler: enable/disable the CPU profiler
</span></span><span class=line><span class=cl>  /healthcheck/fail: cause the server to fail health checks
</span></span><span class=line><span class=cl>  /healthcheck/ok: cause the server to pass health checks
</span></span><span class=line><span class=cl>  /help: print out list of admin commands
</span></span><span class=line><span class=cl>  /hot_restart_version: print the hot restart compatibility version
</span></span><span class=line><span class=cl>  /listeners: print listener addresses
</span></span><span class=line><span class=cl>  /logging: query/change logging levels
</span></span><span class=line><span class=cl>  /quitquitquit: <span class=nb>exit</span> the server
</span></span><span class=line><span class=cl>  /reset_counters: reset all counters to zero
</span></span><span class=line><span class=cl>  /runtime: print runtime values
</span></span><span class=line><span class=cl>  /runtime_modify: modify runtime values
</span></span><span class=line><span class=cl>  /server_info: print server version/status information
</span></span><span class=line><span class=cl>  /stats: print server stats
</span></span><span class=line><span class=cl>  /stats/prometheus: print server stats in prometheus format
</span></span></code></pre></div><p>进入 productpage pod 中的 istio-proxy(Envoy) container，可以看到有下面的监听端口：</p><ul><li><code>9080</code> : productpage 进程对外提供的服务端口</li><li><code>15001</code> : Envoy 的入口监听器，iptable 会将 pod 的流量导入该端口中由 Envoy 进行处理</li><li><code>15000</code> : Envoy 管理端口，该端口绑定在本地环回地址上，只能在 Pod 内访问。</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ kubectl <span class=nb>exec</span> productpage-v1-76474f6fb7-j8fm4 -c istio-proxy -- ss -tulnp
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Netid  State      Recv-Q Send-Q Local Address:Port               Peer Address:Port
</span></span><span class=line><span class=cl>tcp    LISTEN     <span class=m>0</span>      <span class=m>128</span>    127.0.0.1:15000                 *:*                   users:<span class=o>((</span><span class=s2>&#34;envoy&#34;</span>,pid<span class=o>=</span>12,fd<span class=o>=</span>9<span class=o>))</span>
</span></span><span class=line><span class=cl>tcp    LISTEN     <span class=m>0</span>      <span class=m>128</span>       *:9080                  *:*
</span></span><span class=line><span class=cl>tcp    LISTEN     <span class=m>0</span>      <span class=m>128</span>       *:15001                 *:*                   users:<span class=o>((</span><span class=s2>&#34;envoy&#34;</span>,pid<span class=o>=</span>12,fd<span class=o>=</span>85<span class=o>))</span>
</span></span></code></pre></div><div id=envoy-启动过程分析 class=anchor></div><h3 class="relative group">Envoy 启动过程分析
<span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#envoy-%e5%90%af%e5%8a%a8%e8%bf%87%e7%a8%8b%e5%88%86%e6%9e%90 aria-label=锚点>#</a></span></h3><p>Istio 通过 K8s 的 <a href=/posts/kubernetes-extensible-admission/>Admission webhook</a> 机制实现了 sidecar 的自动注入，Mesh 中的每个微服务会被加入 Envoy 相关的容器。下面是 <code>Productpage</code> 微服务的 Pod 内容，可见除 productpage 之外，Istio 还在该 Pod 中注入了两个容器 <code>gcr.io/istio-release/proxy_init</code> 和 <code>gcr.io/istio-release/proxyv2</code>。</p><div class="flex px-4 py-3 rounded-md bg-primary-100 dark:bg-primary-900"><span class="text-primary-400 ltr:pr-3 rtl:pl-3 flex items-center"><span class="relative block icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M506.3 417 293 53c-16.33-28-57.54-28-73.98.0l-213.2 364C-10.59 444.9 9.849 480 42.74 480h426.6c32.76.0 53.26-35 36.96-63zM232 168c0-13.25 10.75-24 24-24s24 10.8 24 24v128c0 13.25-10.75 24-23.1 24S232 309.3 232 296V168zm24 248c-17.36.0-31.44-14.08-31.44-31.44s14.07-31.44 31.44-31.44 31.44 14.08 31.44 31.44C287.4 401.9 273.4 416 256 416z"/></svg></span></span><span class=dark:text-neutral-300>下面 Pod description 中只保留了需要关注的内容，删除了其它不重要的部分。为方便查看，本文中后续的其它配置文件以及命令行输出也会进行类似处理。</span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ kubectl describe pod productpage-v1-54b8b9f55-bx2dq
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Name:               productpage-v1-54b8b9f55-bx2dq
</span></span><span class=line><span class=cl>Namespace:          default
</span></span><span class=line><span class=cl>Init Containers:
</span></span><span class=line><span class=cl>  istio-init:
</span></span><span class=line><span class=cl>    Image:         gcr.io/istio-release/proxy_init:1.0.0
</span></span><span class=line><span class=cl>      Args:
</span></span><span class=line><span class=cl>      -p
</span></span><span class=line><span class=cl>      <span class=m>15001</span>
</span></span><span class=line><span class=cl>      -u
</span></span><span class=line><span class=cl>      <span class=m>1337</span>
</span></span><span class=line><span class=cl>      -m
</span></span><span class=line><span class=cl>      REDIRECT
</span></span><span class=line><span class=cl>      -i
</span></span><span class=line><span class=cl>      *
</span></span><span class=line><span class=cl>      -x
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      -b
</span></span><span class=line><span class=cl>      9080,
</span></span><span class=line><span class=cl>      -d
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Containers:
</span></span><span class=line><span class=cl>  productpage:
</span></span><span class=line><span class=cl>    Image:          istio/examples-bookinfo-productpage-v1:1.8.0
</span></span><span class=line><span class=cl>    Port:           9080/TCP
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  istio-proxy:
</span></span><span class=line><span class=cl>    Image:         gcr.io/istio-release/proxyv2:1.0.0
</span></span><span class=line><span class=cl>    Args:
</span></span><span class=line><span class=cl>      proxy
</span></span><span class=line><span class=cl>      sidecar
</span></span><span class=line><span class=cl>      --configPath
</span></span><span class=line><span class=cl>      /etc/istio/proxy
</span></span><span class=line><span class=cl>      --binaryPath
</span></span><span class=line><span class=cl>      /usr/local/bin/envoy
</span></span><span class=line><span class=cl>      --serviceCluster
</span></span><span class=line><span class=cl>      productpage
</span></span><span class=line><span class=cl>      --drainDuration
</span></span><span class=line><span class=cl>      45s
</span></span><span class=line><span class=cl>      --parentShutdownDuration
</span></span><span class=line><span class=cl>      1m0s
</span></span><span class=line><span class=cl>      --discoveryAddress
</span></span><span class=line><span class=cl>      istio-pilot.istio-system:15007
</span></span><span class=line><span class=cl>      --discoveryRefreshDelay
</span></span><span class=line><span class=cl>      1s
</span></span><span class=line><span class=cl>      --zipkinAddress
</span></span><span class=line><span class=cl>      zipkin.istio-system:9411
</span></span><span class=line><span class=cl>      --connectTimeout
</span></span><span class=line><span class=cl>      10s
</span></span><span class=line><span class=cl>      --statsdUdpAddress
</span></span><span class=line><span class=cl>      istio-statsd-prom-bridge.istio-system:9125
</span></span><span class=line><span class=cl>      --proxyAdminPort
</span></span><span class=line><span class=cl>      <span class=m>15000</span>
</span></span><span class=line><span class=cl>      --controlPlaneAuthPolicy
</span></span><span class=line><span class=cl>      NONE
</span></span></code></pre></div><div id=proxy_init class=anchor></div><h4 class="relative group">Proxy_init
<span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#proxy_init aria-label=锚点>#</a></span></h4><p>Productpage 的 Pod 中有一个 InitContainer <code>proxy_init</code>，<code>InitContrainer</code> 是 K8S 提供的机制，用于在 Pod 中执行一些初始化任务。在 Initialcontainer 执行完毕并退出后，才会启动 Pod 中的其它 container。</p><p>我们看一下 proxy_init 容器中的内容：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ docker image inspect gcr.io/istio-release/proxy_init:1.0.0
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;RepoTags&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;gcr.io/istio-release/proxy_init:1.0.0&#34;</span>
</span></span><span class=line><span class=cl>        <span class=p>],</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;ContainerConfig&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;Env&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin&#34;</span>
</span></span><span class=line><span class=cl>            <span class=p>],</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;Cmd&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;/bin/sh&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;-c&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;#(nop) &#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;ENTRYPOINT [\&#34;/usr/local/bin/istio-iptables.sh\&#34;]&#34;</span>
</span></span><span class=line><span class=cl>            <span class=p>],</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;Entrypoint&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;/usr/local/bin/istio-iptables.sh&#34;</span>
</span></span><span class=line><span class=cl>            <span class=p>],</span>
</span></span><span class=line><span class=cl>        <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>]</span>
</span></span></code></pre></div><p>从上面的命令行输出可以看到，Proxy_init 中执行的命令是 <code>istio-iptables.sh</code>，该脚本源码较长，就不列出来了，有兴趣可以在 Istio 源码仓库的 <a href=https://github.com/istio/istio/blob/master/tools/deb/istio-iptables.sh target=_blank>tools/deb/istio-iptables.sh</a> 查看。</p><p>该脚本的作用是通过配置 iptables 来劫持 Pod 中的流量。结合前面 Pod 中该容器的命令行参数 <code>-p 15001</code>，可以得知 Pod 中的数据流量被 iptables 拦截，并发向 Envoy 的 15001 端口。 <code>-u 1337</code> 参数用于排除用户 ID 为 1337，即 Envoy 自身的流量，以避免 Iptables 把 Envoy 发出的数据又重定向到 Envoy，形成死循环。</p><div id=proxyv2 class=anchor></div><h4 class="relative group">Proxyv2
<span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#proxyv2 aria-label=锚点>#</a></span></h4><p>前面提到，该容器中有两个进程 Pilot-agent 和 envoy。我们进入容器中看看这两个进程的相关信息。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ kubectl <span class=nb>exec</span> productpage-v1-54b8b9f55-bx2dq -c istio-proxy -- ps -ef
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>UID        PID  PPID  C STIME TTY          TIME CMD
</span></span><span class=line><span class=cl>istio-p+     <span class=m>1</span>     <span class=m>0</span>  <span class=m>0</span> Sep06 ?        00:00:00 /usr/local/bin/pilot-agent proxy sidecar --configPath /etc/istio/proxy --binaryPath /usr/local/bin/envoy --serviceCluster productpage --drainDuration 45s --parentShutdownDuration 1m0s --discoveryAddress istio-pilot.istio-system:15007 --discoveryRefreshDelay 1s --zipkinAddress zipkin.istio-system:9411 --connectTimeout 10s --statsdUdpAddress istio-statsd-prom-bridge.istio-system:9125 --proxyAdminPort <span class=m>15000</span> --controlPlaneAuthPolicy NONE
</span></span><span class=line><span class=cl>istio-p+    <span class=m>13</span>     <span class=m>1</span>  <span class=m>0</span> Sep06 ?        00:47:37 /usr/local/bin/envoy -c /etc/istio/proxy/envoy-rev0.json --restart-epoch <span class=m>0</span> --drain-time-s <span class=m>45</span> --parent-shutdown-time-s <span class=m>60</span> --service-cluster productpage --service-node sidecar~192.168.206.23~productpage-v1-54b8b9f55-bx2dq.default~default.svc.cluster.local --max-obj-name-len <span class=m>189</span> -l warn --v2-config-only
</span></span></code></pre></div><p>Envoy 的大部分配置都是 <code>dynamic resource</code>，包括网格中服务相关的 service cluster, listener, route 规则等。这些 dynamic resource 是通过 xDS 接口从 Istio 控制平面中动态获取的。但 Envoy 如何知道 xDS server 的地址呢？这是在 Envoy 初始化配置文件中以 <code>static resource</code> 的方式配置的。</p><div id=envoy-初始配置文件 class=anchor></div><h4 class="relative group">Envoy 初始配置文件
<span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#envoy-%e5%88%9d%e5%a7%8b%e9%85%8d%e7%bd%ae%e6%96%87%e4%bb%b6 aria-label=锚点>#</a></span></h4><p><code>Pilot-agent</code> 进程根据启动参数和 K8S API Server 中的配置信息生成 Envoy 的初始配置文件，并负责启动 Envoy 进程。从 ps 命令输出可以看到 Pilot-agent 在启动 Envoy 进程时传入了 <code>pilot</code> 地址和 <code>zipkin</code> 地址，并为 Envoy 生成了一个初始化配置文件 <code>envoy-rev0.json</code>。</p><p>Pilot agent 生成初始化配置文件的代码： <a href=https://github.com/istio/istio/blob/release-1.0/pkg/bootstrap/bootstrap_config.go target=_blank>https://github.com/istio/istio/blob/release-1.0/pkg/bootstrap/bootstrap_config.go</a> 137行</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// WriteBootstrap generates an envoy config based on config and epoch, and returns the filename.
</span></span></span><span class=line><span class=cl><span class=c1>// TODO: in v2 some of the LDS ports (port, http_port) should be configured in the bootstrap.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=nf>WriteBootstrap</span><span class=p>(</span><span class=nx>config</span> <span class=o>*</span><span class=nx>meshconfig</span><span class=p>.</span><span class=nx>ProxyConfig</span><span class=p>,</span> <span class=nx>node</span> <span class=kt>string</span><span class=p>,</span> <span class=nx>epoch</span> <span class=kt>int</span><span class=p>,</span> <span class=nx>pilotSAN</span> <span class=p>[]</span><span class=kt>string</span><span class=p>,</span> <span class=nx>opts</span> <span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>]</span><span class=kd>interface</span><span class=p>{})</span> <span class=p>(</span><span class=kt>string</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>opts</span> <span class=o>==</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>opts</span> <span class=p>=</span> <span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>]</span><span class=kd>interface</span><span class=p>{}{}</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>os</span><span class=p>.</span><span class=nf>MkdirAll</span><span class=p>(</span><span class=nx>config</span><span class=p>.</span><span class=nx>ConfigPath</span><span class=p>,</span> <span class=mo>0700</span><span class=p>);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=s>&#34;&#34;</span><span class=p>,</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=c1>// attempt to write file
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>fname</span> <span class=o>:=</span> <span class=nf>configFile</span><span class=p>(</span><span class=nx>config</span><span class=p>.</span><span class=nx>ConfigPath</span><span class=p>,</span> <span class=nx>epoch</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>cfg</span> <span class=o>:=</span> <span class=nx>config</span><span class=p>.</span><span class=nx>CustomConfigFile</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>cfg</span> <span class=o>==</span> <span class=s>&#34;&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>cfg</span> <span class=p>=</span> <span class=nx>config</span><span class=p>.</span><span class=nx>ProxyBootstrapTemplatePath</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>cfg</span> <span class=o>==</span> <span class=s>&#34;&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>cfg</span> <span class=p>=</span> <span class=nx>DefaultCfgDir</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=o>......</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>config</span><span class=p>.</span><span class=nx>StatsdUdpAddress</span> <span class=o>!=</span> <span class=s>&#34;&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>h</span><span class=p>,</span> <span class=nx>p</span><span class=p>,</span> <span class=nx>err</span> <span class=p>=</span> <span class=nf>GetHostPort</span><span class=p>(</span><span class=s>&#34;statsd UDP&#34;</span><span class=p>,</span> <span class=nx>config</span><span class=p>.</span><span class=nx>StatsdUdpAddress</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>return</span> <span class=s>&#34;&#34;</span><span class=p>,</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=nf>StoreHostPort</span><span class=p>(</span><span class=nx>h</span><span class=p>,</span> <span class=nx>p</span><span class=p>,</span> <span class=s>&#34;statsd&#34;</span><span class=p>,</span> <span class=nx>opts</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>fout</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>os</span><span class=p>.</span><span class=nf>Create</span><span class=p>(</span><span class=nx>fname</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=s>&#34;&#34;</span><span class=p>,</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// Execute needs some sort of io.Writer
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>err</span> <span class=p>=</span> <span class=nx>t</span><span class=p>.</span><span class=nf>Execute</span><span class=p>(</span><span class=nx>fout</span><span class=p>,</span> <span class=nx>opts</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nx>fname</span><span class=p>,</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>可以使用下面的命令将 productpage pod 中该文件导出来查看其中的内容：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ kubectl <span class=nb>exec</span> productpage-v1-54b8b9f55-bx2dq -c istio-proxy -- cat /etc/istio/proxy/envoy-rev0.json &gt; envoy-rev0.json
</span></span></code></pre></div><p>配置文件的结构如图所示：</p><p><figure><img loading=lazy class="my-0 rounded-md" src=https://jsdelivr.icloudnative.io/gh/yangchuansheng/imghosting6@main/uPic/Rwq4zh.jpg alt></figure></p><p>其中各个配置节点的内容如下：</p><p id=blue>Node</p><p>包含了 Envoy 所在节点相关信息。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=s2>&#34;node&#34;</span><span class=err>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;id&#34;</span><span class=p>:</span> <span class=s2>&#34;sidecar~192.168.206.23~productpage-v1-54b8b9f55-bx2dq.default~default.svc.cluster.local&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=c1>//用于标识 envoy 所代理的 node（在k8s中对应为Pod）上的 service cluster，来自于 Envoy 进程启动时的 service-cluster 参数
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nt>&#34;cluster&#34;</span><span class=p>:</span> <span class=s2>&#34;productpage&#34;</span><span class=p>,</span>  
</span></span><span class=line><span class=cl>    <span class=nt>&#34;metadata&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=nt>&#34;INTERCEPTION_MODE&#34;</span><span class=p>:</span> <span class=s2>&#34;REDIRECT&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=nt>&#34;ISTIO_PROXY_SHA&#34;</span><span class=p>:</span> <span class=s2>&#34;istio-proxy:6166ae7ebac7f630206b2fe4e6767516bf198313&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=nt>&#34;ISTIO_PROXY_VERSION&#34;</span><span class=p>:</span> <span class=s2>&#34;1.0.0&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=nt>&#34;ISTIO_VERSION&#34;</span><span class=p>:</span> <span class=s2>&#34;1.0.0&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=nt>&#34;POD_NAME&#34;</span><span class=p>:</span> <span class=s2>&#34;productpage-v1-54b8b9f55-bx2dq&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=nt>&#34;istio&#34;</span><span class=p>:</span> <span class=s2>&#34;sidecar&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span></code></pre></div><p id=blue>Admin</p><p>配置 Envoy 的日志路径以及管理端口。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=s2>&#34;admin&#34;</span><span class=err>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;access_log_path&#34;</span><span class=p>:</span> <span class=s2>&#34;/dev/stdout&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;address&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;socket_address&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;address&#34;</span><span class=p>:</span> <span class=s2>&#34;127.0.0.1&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;port_value&#34;</span><span class=p>:</span> <span class=mi>15000</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span></code></pre></div><p id=blue>Dynamic_resources</p><p>配置动态资源,这里配置了 <code>ADS</code> 服务器。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=s2>&#34;dynamic_resources&#34;</span><span class=err>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;lds_config&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;ads&#34;</span><span class=p>:</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;cds_config&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;ads&#34;</span><span class=p>:</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;ads_config&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;api_type&#34;</span><span class=p>:</span> <span class=s2>&#34;GRPC&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;refresh_delay&#34;</span><span class=p>:</span> <span class=p>{</span><span class=nt>&#34;seconds&#34;</span><span class=p>:</span> <span class=mi>1</span><span class=p>,</span> <span class=nt>&#34;nanos&#34;</span><span class=p>:</span> <span class=mi>0</span><span class=p>},</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;grpc_services&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=nt>&#34;envoy_grpc&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;cluster_name&#34;</span><span class=p>:</span> <span class=s2>&#34;xds-grpc&#34;</span>
</span></span><span class=line><span class=cl>          <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span></code></pre></div><p id=blue>Static_resources</p><p>配置静态资源，包括了 <code>xds-grpc</code> 和 <code>zipkin</code> 两个 cluster。其中 xds-grpc cluster 对应前面 dynamic_resources 中 ADS 配置，指明了 Envoy 用于获取动态资源的服务器地址。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=s2>&#34;static_resources&#34;</span><span class=err>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;clusters&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;name&#34;</span><span class=p>:</span> <span class=s2>&#34;xds-grpc&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;type&#34;</span><span class=p>:</span> <span class=s2>&#34;STRICT_DNS&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;connect_timeout&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;seconds&#34;</span><span class=p>:</span> <span class=mi>10</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;nanos&#34;</span><span class=p>:</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>      <span class=p>},</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;lb_policy&#34;</span><span class=p>:</span> <span class=s2>&#34;ROUND_ROBIN&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;hosts&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=nt>&#34;socket_address&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;address&#34;</span><span class=p>:</span> <span class=s2>&#34;istio-pilot.istio-system&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;port_value&#34;</span><span class=p>:</span> <span class=mi>15010</span>
</span></span><span class=line><span class=cl>          <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=p>],</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;circuit_breakers&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;thresholds&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>          <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;priority&#34;</span><span class=p>:</span> <span class=s2>&#34;default&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;max_connections&#34;</span><span class=p>:</span> <span class=s2>&#34;100000&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;max_pending_requests&#34;</span><span class=p>:</span> <span class=s2>&#34;100000&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;max_requests&#34;</span><span class=p>:</span> <span class=s2>&#34;100000&#34;</span>
</span></span><span class=line><span class=cl>          <span class=p>},</span>
</span></span><span class=line><span class=cl>          <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;priority&#34;</span><span class=p>:</span> <span class=s2>&#34;high&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;max_connections&#34;</span><span class=p>:</span> <span class=s2>&#34;100000&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;max_pending_requests&#34;</span><span class=p>:</span> <span class=s2>&#34;100000&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;max_requests&#34;</span><span class=p>:</span> <span class=s2>&#34;100000&#34;</span>
</span></span><span class=line><span class=cl>          <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>]</span>
</span></span><span class=line><span class=cl>      <span class=p>},</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;upstream_connection_options&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;tcp_keepalive&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=nt>&#34;keepalive_time&#34;</span><span class=p>:</span> <span class=mi>300</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=p>},</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;http2_protocol_options&#34;</span><span class=p>:</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;name&#34;</span><span class=p>:</span> <span class=s2>&#34;zipkin&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;type&#34;</span><span class=p>:</span> <span class=s2>&#34;STRICT_DNS&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;connect_timeout&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;seconds&#34;</span><span class=p>:</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>      <span class=p>},</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;lb_policy&#34;</span><span class=p>:</span> <span class=s2>&#34;ROUND_ROBIN&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;hosts&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=nt>&#34;socket_address&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;address&#34;</span><span class=p>:</span> <span class=s2>&#34;zipkin.istio-system&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;port_value&#34;</span><span class=p>:</span> <span class=mi>9411</span>
</span></span><span class=line><span class=cl>          <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>]</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p id=blue>Tracing</p><p>配置分布式链路跟踪。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=s2>&#34;tracing&#34;</span><span class=err>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;http&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;name&#34;</span><span class=p>:</span> <span class=s2>&#34;envoy.zipkin&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;config&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;collector_cluster&#34;</span><span class=p>:</span> <span class=s2>&#34;zipkin&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p id=blue>Stats_sinks</p><p>这里配置的是和 Envoy 直连的 <code>metrics</code> 收集 sink,和 <code>Mixer telemetry</code> 没有关系。Envoy 自带 stats 格式的 metrics 上报。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=s2>&#34;stats_sinks&#34;</span><span class=err>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;name&#34;</span><span class=p>:</span> <span class=s2>&#34;envoy.statsd&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;config&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;address&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;socket_address&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=nt>&#34;address&#34;</span><span class=p>:</span> <span class=s2>&#34;10.254.238.237&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=nt>&#34;port_value&#34;</span><span class=p>:</span> <span class=mi>9125</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>]</span>
</span></span></code></pre></div><p>在Gist <a href=https://gist.github.com/zhaohuabing/14191bdcf72e37bf700129561c3b41ae target=_blank>https://gist.github.com/zhaohuabing/14191bdcf72e37bf700129561c3b41ae</a> 中可以查看该配置文件的完整内容。</p><div id=envoy-配置分析 class=anchor></div><h3 class="relative group">Envoy 配置分析
<span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#envoy-%e9%85%8d%e7%bd%ae%e5%88%86%e6%9e%90 aria-label=锚点>#</a></span></h3><div id=通过管理接口获取完整配置 class=anchor></div><h4 class="relative group">通过管理接口获取完整配置
<span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%e9%80%9a%e8%bf%87%e7%ae%a1%e7%90%86%e6%8e%a5%e5%8f%a3%e8%8e%b7%e5%8f%96%e5%ae%8c%e6%95%b4%e9%85%8d%e7%bd%ae aria-label=锚点>#</a></span></h4><p>从 Envoy 初始化配置文件中，我们可以大致看到 Istio 通过 Envoy 来实现服务发现和流量管理的基本原理。即控制平面将 xDS server 信息通过 <code>static resource</code> 的方式配置到 Envoy 的初始化配置文件中，Envoy 启动后通过 xDS server 获取到 <code>dynamic resource</code>，包括网格中的 service 信息及路由规则。</p><p>Envoy 配置初始化流程：</p><p><figure><img loading=lazy class="my-0 rounded-md" src=https://jsdelivr.icloudnative.io/gh/yangchuansheng/imghosting6@main/uPic/NQTN5a.jpg alt></figure></p><ol><li>Pilot-agent 根据启动参数和 K8S API Server 中的配置信息生成 Envoy 的初始配置文件 <code>envoy-rev0.json</code>，该文件告诉 Envoy 从 <code>xDS server</code> 中获取动态配置信息，并配置了 xDS server 的地址信息，即控制平面的 <code>Pilot</code>。</li><li>Pilot-agent 使用 envoy-rev0.json 启动 Envoy 进程。</li><li>Envoy 根据初始配置获得 Pilot 地址，采用 xDS 接口从 Pilot 获取到 <code>Listener</code>，<code>Cluster</code>，<code>Route</code> 等动态配置信息。</li><li>Envoy 根据获取到的动态配置启动 Listener，并根据 Listener 的配置，结合 Route 和 Cluster 对拦截到的流量进行处理。</li></ol><p>可以看到，Envoy 中实际生效的配置是由初始化配置文件中的静态配置和从 Pilot 获取的动态配置一起组成的。因此只对 envoy-rev0.json 进行分析并不能看到 Mesh 中流量管理的全貌。那么有没有办法可以看到 Envoy 中实际生效的完整配置呢？答案是可以的，我们可以通过 Envoy 的管理接口来获取 Envoy 的完整配置。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ kubectl <span class=nb>exec</span> -it productpage-v1-54b8b9f55-bx2dq -c istio-proxy curl http://127.0.0.1:15000/config_dump &gt; config_dump
</span></span></code></pre></div><p>该文件内容长达近7000行，本文中就不贴出来了，在Gist <a href=https://gist.github.com/zhaohuabing/034ef87786d290a4e89cd6f5ad6fcc97 target=_blank>https://gist.github.com/zhaohuabing/034ef87786d290a4e89cd6f5ad6fcc97</a> 中可以查看到全文。</p><div id=envoy-配置文件结构 class=anchor></div><h4 class="relative group">Envoy 配置文件结构
<span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#envoy-%e9%85%8d%e7%bd%ae%e6%96%87%e4%bb%b6%e7%bb%93%e6%9e%84 aria-label=锚点>#</a></span></h4><p><figure><img loading=lazy class="my-0 rounded-md" src=https://jsdelivr.icloudnative.io/gh/yangchuansheng/imghosting6@main/uPic/3DyRUz.jpg alt></figure></p><p>文件中的配置节点包括：</p><div id=bootstrap class=anchor></div><h5 class="relative group">Bootstrap
<span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#bootstrap aria-label=锚点>#</a></span></h5><p>从名字可以大致猜出这是 Envoy 的初始化配置，打开该节点，可以看到文件中的内容和前一章节中介绍的 envoy-rev0.json 是一致的，这里不再赘述。</p><p><figure><img loading=lazy class="my-0 rounded-md" src=https://jsdelivr.icloudnative.io/gh/yangchuansheng/imghosting6@main/uPic/CBAqAH.jpg alt></figure></p><div id=clusters class=anchor></div><h5 class="relative group">Clusters
<span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#clusters aria-label=锚点>#</a></span></h5><p>在 Envoy 中，Cluster 是一个服务集群，Cluster 中包含一个到多个 endpoint，每个 endpoint 都可以提供服务，Envoy 根据负载均衡算法将请求发送到这些 endpoint 中。</p><p>在 Productpage 的 clusters 配置中包含 <code>static_clusters</code> 和 <code>dynamic_active_clusters</code> 两部分，其中 static_clusters 是来自于 envoy-rev0.json 的 xDS server 和 zipkin server 信息。dynamic_active_clusters 是通过 xDS 接口从 Istio 控制平面获取的动态服务信息。</p><p><figure><img loading=lazy class="my-0 rounded-md" src=https://jsdelivr.icloudnative.io/gh/yangchuansheng/imghosting6@main/uPic/pXRSn3.jpg alt></figure></p><p>Dynamic Cluster 中有以下几类 Cluster：</p><p id=blue>Outbound Cluster</p><p>这部分的 Cluster 占了绝大多数，该类 Cluster 对应于 Envoy 所在节点的外部服务。以 <code>details</code> 为例，对于 Productpage 来说，details 是一个外部服务，因此其 Cluster 名称中包含 <code>outbound</code> 字样。</p><p>从 details 服务对应的 cluster 配置中可以看到，其类型为 <code>EDS</code>，即表示该 Cluster 的 endpoint 来自于动态发现，动态发现中 <code>eds_config</code> 则指向了 <code>ads</code>，最终指向 static Resource 中配置的 xds-grpc cluster，即 Pilot 的地址。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl> <span class=nt>&#34;version_info&#34;</span><span class=p>:</span> <span class=s2>&#34;2018-09-06T09:34:19Z&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl> <span class=nt>&#34;cluster&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;name&#34;</span><span class=p>:</span> <span class=s2>&#34;outbound|9080||details.default.svc.cluster.local&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;type&#34;</span><span class=p>:</span> <span class=s2>&#34;EDS&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;eds_cluster_config&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>   <span class=nt>&#34;eds_config&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;ads&#34;</span><span class=p>:</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>   <span class=p>},</span>
</span></span><span class=line><span class=cl>   <span class=nt>&#34;service_name&#34;</span><span class=p>:</span> <span class=s2>&#34;outbound|9080||details.default.svc.cluster.local&#34;</span>
</span></span><span class=line><span class=cl>  <span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;connect_timeout&#34;</span><span class=p>:</span> <span class=s2>&#34;1s&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;circuit_breakers&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>   <span class=nt>&#34;thresholds&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=p>{}</span>
</span></span><span class=line><span class=cl>   <span class=p>]</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl> <span class=p>},</span>
</span></span><span class=line><span class=cl> <span class=nt>&#34;last_updated&#34;</span><span class=p>:</span> <span class=s2>&#34;2018-09-06T09:34:20.404Z&#34;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>可以通过 Pilot 的调试接口获取该 Cluster 的 endpoint：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ curl http://10.96.8.103:9093/debug/edsz &gt; pilot_eds_dump
</span></span></code></pre></div><p>导出的文件长达 1300 多行，本文只贴出 details 服务相关的 <code>endpoint</code> 配置，完整文件参见: <a href=https://gist.github.com/zhaohuabing/a161d2f64746acd18097b74e6a5af551 target=_blank>https://gist.github.com/zhaohuabing/a161d2f64746acd18097b74e6a5af551</a></p><p>从下面的文件内容可以看到，details cluster 配置了 1 个 endpoint 地址，是 details 的 <code>pod ip</code>。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;clusterName&#34;</span><span class=p>:</span> <span class=s2>&#34;outbound|9080||details.default.svc.cluster.local&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;endpoints&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;locality&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      <span class=p>},</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;lbEndpoints&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=nt>&#34;endpoint&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;address&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>              <span class=nt>&#34;socketAddress&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=nt>&#34;address&#34;</span><span class=p>:</span> <span class=s2>&#34;192.168.206.21&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=nt>&#34;portValue&#34;</span><span class=p>:</span> <span class=mi>9080</span>
</span></span><span class=line><span class=cl>              <span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>          <span class=p>},</span>
</span></span><span class=line><span class=cl>          <span class=nt>&#34;metadata&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;filterMetadata&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>              <span class=nt>&#34;istio&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                  <span class=nt>&#34;uid&#34;</span><span class=p>:</span> <span class=s2>&#34;kubernetes://details-v1-6764bbc7f7-qwzdg.default&#34;</span>
</span></span><span class=line><span class=cl>                <span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>          <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>]</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p id=blue>Inbound Cluster</p><p>该类 Cluster 对应于 Envoy 所在节点上的服务。如果该服务接收到请求，当然就是一个入站请求。对于 Productpage Pod 上的 Envoy，其对应的 Inbound Cluster 只有一个，即 productpage。该 cluster 对应的 host 为 <code>127.0.0.1</code>，即环回地址上 productpage 的监听端口。由于 iptables 规则中排除了 127.0.0.1,入站请求通过该 Inbound cluster 处理后将跳过 Envoy，直接发送给 Productpage 进程处理。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>   <span class=nt>&#34;version_info&#34;</span><span class=p>:</span> <span class=s2>&#34;2018-09-14T01:44:05Z&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>   <span class=nt>&#34;cluster&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;name&#34;</span><span class=p>:</span> <span class=s2>&#34;inbound|9080||productpage.default.svc.cluster.local&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;connect_timeout&#34;</span><span class=p>:</span> <span class=s2>&#34;1s&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;hosts&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>     <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;socket_address&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>       <span class=nt>&#34;address&#34;</span><span class=p>:</span> <span class=s2>&#34;127.0.0.1&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>       <span class=nt>&#34;port_value&#34;</span><span class=p>:</span> <span class=mi>9080</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>     <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>],</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;circuit_breakers&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>     <span class=nt>&#34;thresholds&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>      <span class=p>{}</span>
</span></span><span class=line><span class=cl>     <span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>   <span class=p>},</span>
</span></span><span class=line><span class=cl>   <span class=nt>&#34;last_updated&#34;</span><span class=p>:</span> <span class=s2>&#34;2018-09-14T01:44:05.291Z&#34;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p id=blue>BlackHoleCluster</p><p>这是一个特殊的 Cluster，并没有配置后端处理请求的 Host。如其名字所暗示的一样，请求进入后将被直接丢弃掉。如果一个请求没有找到其对的目的服务，则被发到 BlackHoleCluster。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>   <span class=nt>&#34;version_info&#34;</span><span class=p>:</span> <span class=s2>&#34;2018-09-06T09:34:19Z&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>   <span class=nt>&#34;cluster&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;name&#34;</span><span class=p>:</span> <span class=s2>&#34;BlackHoleCluster&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;connect_timeout&#34;</span><span class=p>:</span> <span class=s2>&#34;5s&#34;</span>
</span></span><span class=line><span class=cl>   <span class=p>},</span>
</span></span><span class=line><span class=cl>   <span class=nt>&#34;last_updated&#34;</span><span class=p>:</span> <span class=s2>&#34;2018-09-06T09:34:20.408Z&#34;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><div id=listeners class=anchor></div><h5 class="relative group">Listeners
<span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#listeners aria-label=锚点>#</a></span></h5><p>Envoy 采用 listener 来接收并处理 <code>downstream</code> 发过来的请求，listener 的处理逻辑是插件式的，可以通过配置不同的 <code>filter</code> 来插入不同的处理逻辑。Istio 就在 Envoy 中加入了用于 <code>policy check</code> 和 <code>metric report</code> 的 Mixer filter。</p><p>Listener 可以绑定到 <code>IP Socket</code> 或者 <code>Unix Domain Socket</code> 上，也可以不绑定到一个具体的端口上，而是接收从其他 listener 转发来的数据。Istio 就是利用了 Envoy listener 的这一特点实现了将来发向不同服务的请求转交给不同的 listener 处理。</p><p id=blue>Virtual Listener</p><p>Envoy 创建了一个在 <code>15001</code> 端口监听的入口监听器。Iptables 将请求截取后发向 15001 端口，该监听器接收后并不进行业务处理，而是根据请求目的地分发给其他监听器处理。该监听器取名为 <code>virtual</code>（虚拟）监听器也是这个原因。</p><p>Envoy 是如何做到按服务分发的呢？ 可以看到该 Listener 的配置项 <code>use_original_dest</code> 设置为 true,该配置要求监听器将接收到的请求转交给和请求原目的地址关联的 listener 进行处理。</p><p>从其 filter 配置可以看到，如果找不到和请求目的地配置的 listener 进行转交，则请求将被发送到 <code>BlackHoleCluster</code>,由于 BlackHoleCluster 并没有配置 host，因此找不到对应目的地对应监听器的请求实际上会被丢弃。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl> <span class=nt>&#34;version_info&#34;</span><span class=p>:</span> <span class=s2>&#34;2018-09-06T09:34:19Z&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl> <span class=nt>&#34;listener&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;name&#34;</span><span class=p>:</span> <span class=s2>&#34;virtual&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;address&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>   <span class=nt>&#34;socket_address&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;address&#34;</span><span class=p>:</span> <span class=s2>&#34;0.0.0.0&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;port_value&#34;</span><span class=p>:</span> <span class=mi>15001</span>
</span></span><span class=line><span class=cl>   <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;filter_chains&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>   <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;filters&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>     <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;name&#34;</span><span class=p>:</span> <span class=s2>&#34;envoy.tcp_proxy&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;config&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>       <span class=nt>&#34;stat_prefix&#34;</span><span class=p>:</span> <span class=s2>&#34;BlackHoleCluster&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>       <span class=nt>&#34;cluster&#34;</span><span class=p>:</span> <span class=s2>&#34;BlackHoleCluster&#34;</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>     <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>]</span>
</span></span><span class=line><span class=cl>   <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>],</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;use_original_dst&#34;</span><span class=p>:</span> <span class=kc>true</span>
</span></span><span class=line><span class=cl> <span class=p>},</span>
</span></span><span class=line><span class=cl> <span class=nt>&#34;last_updated&#34;</span><span class=p>:</span> <span class=s2>&#34;2018-09-06T09:34:26.262Z&#34;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p id=blue>Inbound Listener</p><p>在 Productpage Pod 上的 Envoy 创建了 <code>Listener 192.168.206.23_9080</code>，当外部调用 Productpage 服务的请求到达 Pod 上 15001 的 <code>Virtual Listener</code> 时，Virtual Listener 根据请求目的地匹配到该 Listener,请求将被转发过来。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl> <span class=nt>&#34;version_info&#34;</span><span class=p>:</span> <span class=s2>&#34;2018-09-14T01:44:05Z&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl> <span class=nt>&#34;listener&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;name&#34;</span><span class=p>:</span> <span class=s2>&#34;192.168.206.23_9080&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;address&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>   <span class=nt>&#34;socket_address&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;address&#34;</span><span class=p>:</span> <span class=s2>&#34;192.168.206.23&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;port_value&#34;</span><span class=p>:</span> <span class=mi>9080</span>
</span></span><span class=line><span class=cl>   <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;filter_chains&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>   <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;filters&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>     <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;name&#34;</span><span class=p>:</span> <span class=s2>&#34;mixer&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;config&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>       <span class=nt>&#34;transport&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;check_cluster&#34;</span><span class=p>:</span> <span class=s2>&#34;outbound|9091||istio-policy.istio-system.svc.cluster.local&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;network_fail_policy&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>         <span class=nt>&#34;policy&#34;</span><span class=p>:</span> <span class=s2>&#34;FAIL_CLOSE&#34;</span>
</span></span><span class=line><span class=cl>        <span class=p>},</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;report_cluster&#34;</span><span class=p>:</span> <span class=s2>&#34;outbound|9091||istio-telemetry.istio-system.svc.cluster.local&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;attributes_for_mixer_proxy&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>         <span class=nt>&#34;attributes&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=nt>&#34;source.uid&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>           <span class=nt>&#34;string_value&#34;</span><span class=p>:</span> <span class=s2>&#34;kubernetes://productpage-v1-54b8b9f55-bx2dq.default&#34;</span>
</span></span><span class=line><span class=cl>          <span class=p>}</span>
</span></span><span class=line><span class=cl>         <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>       <span class=p>},</span>
</span></span><span class=line><span class=cl>       <span class=nt>&#34;mixer_attributes&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;attributes&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>         <span class=nt>&#34;destination.port&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=nt>&#34;int64_value&#34;</span><span class=p>:</span> <span class=s2>&#34;9080&#34;</span>
</span></span><span class=line><span class=cl>         <span class=p>},</span>
</span></span><span class=line><span class=cl>         <span class=nt>&#34;context.reporter.uid&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=nt>&#34;string_value&#34;</span><span class=p>:</span> <span class=s2>&#34;kubernetes://productpage-v1-54b8b9f55-bx2dq.default&#34;</span>
</span></span><span class=line><span class=cl>         <span class=p>},</span>
</span></span><span class=line><span class=cl>         <span class=nt>&#34;destination.namespace&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=nt>&#34;string_value&#34;</span><span class=p>:</span> <span class=s2>&#34;default&#34;</span>
</span></span><span class=line><span class=cl>         <span class=p>},</span>
</span></span><span class=line><span class=cl>         <span class=nt>&#34;destination.ip&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=nt>&#34;bytes_value&#34;</span><span class=p>:</span> <span class=s2>&#34;AAAAAAAAAAAAAP//wKjOFw==&#34;</span>
</span></span><span class=line><span class=cl>         <span class=p>},</span>
</span></span><span class=line><span class=cl>         <span class=nt>&#34;destination.uid&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=nt>&#34;string_value&#34;</span><span class=p>:</span> <span class=s2>&#34;kubernetes://productpage-v1-54b8b9f55-bx2dq.default&#34;</span>
</span></span><span class=line><span class=cl>         <span class=p>},</span>
</span></span><span class=line><span class=cl>         <span class=nt>&#34;context.reporter.kind&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=nt>&#34;string_value&#34;</span><span class=p>:</span> <span class=s2>&#34;inbound&#34;</span>
</span></span><span class=line><span class=cl>         <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>       <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>     <span class=p>},</span>
</span></span><span class=line><span class=cl>     <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;name&#34;</span><span class=p>:</span> <span class=s2>&#34;envoy.tcp_proxy&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;config&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>       <span class=nt>&#34;stat_prefix&#34;</span><span class=p>:</span> <span class=s2>&#34;inbound|9080||productpage.default.svc.cluster.local&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>       <span class=nt>&#34;cluster&#34;</span><span class=p>:</span> <span class=s2>&#34;inbound|9080||productpage.default.svc.cluster.local&#34;</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>     <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>]</span>
</span></span><span class=line><span class=cl>   <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>],</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;deprecated_v1&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>   <span class=nt>&#34;bind_to_port&#34;</span><span class=p>:</span> <span class=kc>false</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl> <span class=p>},</span>
</span></span><span class=line><span class=cl> <span class=nt>&#34;last_updated&#34;</span><span class=p>:</span> <span class=s2>&#34;2018-09-14T01:44:05.754Z&#34;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>从上面的配置 <code>”bind_to_port”: false</code> 可以得知该 listener 创建后并不会被绑定到 tcp 端口上直接接收网络上的数据，因此其所有请求都转发自 15001 端口。</p><p>该 listener 配置的 <code>envoy.tcp_proxy filter</code> 对应的 cluster为 <code>inbound|9080||productpage.default.svc.cluster.local</code>,该 cluster 配置的 host 为 127.0.0.1:9080，因此 Envoy 会将该请求发向 <code>127.0.0.1:9080</code>。由于 iptables 设置中 127.0.0.1 不会被拦截,该请求将发送到 Productpage 进程的 9080 端口进行业务处理。</p><p>除此以外，Listenter 中还包含 <code>Mixer filter</code> 的配置信息，配置了策略检查(Mixer check)和 Metrics 上报(Mixer report)服务器地址，以及 Mixer上 报的一些 attribute 取值。</p><p id=blue>Outbound Listener</p><p>Envoy 为网格中的外部服务按端口创建多个 Listener，以用于处理出向请求。</p><p>Productpage Pod 中的 Envoy 创建了多个 Outbound Listener：</p><ul><li><code>0.0.0.0_9080</code> : 处理对 details，reviews 和 rating 服务的出向请求</li><li><code>0.0.0.0_9411</code> : 处理对 <code>zipkin</code> 的出向请求</li><li><code>0.0.0.0_15031</code> :处理对 <code>ingressgateway</code> 的出向请求</li><li><code>0.0.0.0_3000</code> : 处理对 <code>grafana</code> 的出向请求</li><li><code>0.0.0.0_9093</code> :处理对 citadel、galley、pilot、(Mixer)policy、(Mixer)telemetry 的出向请求</li><li><code>0.0.0.0_15004</code> : 处理对 (Mixer)policy、(Mixer)telemetry 的出向请求</li><li>&mldr;&mldr;</li></ul><p>除了 9080 这个 Listener 用于处理应用的业务之外，其他 listener 都是 Istio 用于处理自身组件之间通信使用的，有的控制平面组件如 Pilot，Mixer 对应多个 listener，是因为该组件有多个端口提供服务。</p><p>我们这里主要分析一下 <code>9080</code> 这个业务端口的 Listenrer。和 Outbound Listener 一样，该 Listener 同样配置了 <code>”bind_to_port”: false</code> 属性，因此该 listener 也没有被绑定到 tcp 端口上，其接收到的所有请求都转发自 15001 端口的 Virtual listener。</p><p>监听器 name 为 <code>0.0.0.0_9080</code>，推测其含义应为匹配发向任意 IP 的 9080 的请求，从 bookinfo 程序结构可以看到该程序中的 productpage，revirews，ratings，details 四个 service 都是 9080 端口，那么 Envoy 如何区别处理这四个 service 呢？</p><p>首先需要区分<strong>入向</strong>（发送给productpage）请求和<strong>出向</strong>（发送给其他几个服务）请求：</p><ul><li>发给 productpage 的入向请求，virtual listener 根据其目的 IP 和 Port 首先匹配到 <code>192.168.206.23_9080</code> 这个 listener 上，不会进入 <code>0.0.0.0_9080</code> listener处理。</li><li>从 productpage 外发给 reviews、details 和 ratings 的出向请求，virtual listener 无法找到和其目的 IP 完全匹配的 listener，因此根据通配原则转交给 <code>0.0.0.0_9080</code> 处理。</li></ul><p id=blockquote>备注：<br>1. 该转发逻辑为根据 Envoy 配置进行的推测，并未分析 Envoy 代码进行验证。欢迎了解 Envoy 代码和实现机制的朋友指正。<br>2. 根据业务逻辑，实际上 productpage 并不会调用 ratings 服务，但 Istio 并不知道各个业务之间会如何调用，因此将所有的服务信息都下发到了 Envoy 中。这样做对效率和性能理论上有一定影响，存在一定的优化空间。</p><p>由于对应到 reviews、details 和 ratings 三个服务，当 0.0.0.0_9080 接收到出向请求后，并不能直接发送到一个 downstream cluster 中，而是需要根据请求目的地进行不同的路由。</p><p>在该 listener 的配置中，我们可以看到并没有像 inbound listener 那样通过 envoy.tcp_proxy 直接指定一个 downstream 的 cluster，而是通过 <code>rds</code> 配置了一个路由规则 <code>9080</code>，在路由规则中再根据不同的请求目的地对请求进行处理。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>     <span class=nt>&#34;version_info&#34;</span><span class=p>:</span> <span class=s2>&#34;2018-09-06T09:34:19Z&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>     <span class=nt>&#34;listener&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;name&#34;</span><span class=p>:</span> <span class=s2>&#34;0.0.0.0_9080&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;address&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>       <span class=nt>&#34;socket_address&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;address&#34;</span><span class=p>:</span> <span class=s2>&#34;0.0.0.0&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;port_value&#34;</span><span class=p>:</span> <span class=mi>9080</span>
</span></span><span class=line><span class=cl>       <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=p>},</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;filter_chains&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>       <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;filters&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>         <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=nt>&#34;name&#34;</span><span class=p>:</span> <span class=s2>&#34;envoy.http_connection_manager&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=nt>&#34;config&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>           <span class=nt>&#34;access_log&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>            <span class=p>{</span>
</span></span><span class=line><span class=cl>             <span class=nt>&#34;name&#34;</span><span class=p>:</span> <span class=s2>&#34;envoy.file_access_log&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>             <span class=nt>&#34;config&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>              <span class=nt>&#34;path&#34;</span><span class=p>:</span> <span class=s2>&#34;/dev/stdout&#34;</span>
</span></span><span class=line><span class=cl>             <span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>           <span class=p>],</span>
</span></span><span class=line><span class=cl>           <span class=nt>&#34;http_filters&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>            <span class=p>{</span>
</span></span><span class=line><span class=cl>             <span class=nt>&#34;name&#34;</span><span class=p>:</span> <span class=s2>&#34;mixer&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>             <span class=nt>&#34;config&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>			  <span class=err>......</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>             <span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=p>},</span>
</span></span><span class=line><span class=cl>            <span class=p>{</span>
</span></span><span class=line><span class=cl>             <span class=nt>&#34;name&#34;</span><span class=p>:</span> <span class=s2>&#34;envoy.cors&#34;</span>
</span></span><span class=line><span class=cl>            <span class=p>},</span>
</span></span><span class=line><span class=cl>            <span class=p>{</span>
</span></span><span class=line><span class=cl>             <span class=nt>&#34;name&#34;</span><span class=p>:</span> <span class=s2>&#34;envoy.fault&#34;</span>
</span></span><span class=line><span class=cl>            <span class=p>},</span>
</span></span><span class=line><span class=cl>            <span class=p>{</span>
</span></span><span class=line><span class=cl>             <span class=nt>&#34;name&#34;</span><span class=p>:</span> <span class=s2>&#34;envoy.router&#34;</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>           <span class=p>],</span>
</span></span><span class=line><span class=cl>           <span class=nt>&#34;tracing&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;operation_name&#34;</span><span class=p>:</span> <span class=s2>&#34;EGRESS&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;client_sampling&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>             <span class=nt>&#34;value&#34;</span><span class=p>:</span> <span class=mi>100</span>
</span></span><span class=line><span class=cl>            <span class=p>},</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;overall_sampling&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>             <span class=nt>&#34;value&#34;</span><span class=p>:</span> <span class=mi>100</span>
</span></span><span class=line><span class=cl>            <span class=p>},</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;random_sampling&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>             <span class=nt>&#34;value&#34;</span><span class=p>:</span> <span class=mi>100</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>           <span class=p>},</span>
</span></span><span class=line><span class=cl>           <span class=nt>&#34;use_remote_address&#34;</span><span class=p>:</span> <span class=kc>false</span><span class=p>,</span>
</span></span><span class=line><span class=cl>           <span class=nt>&#34;stat_prefix&#34;</span><span class=p>:</span> <span class=s2>&#34;0.0.0.0_9080&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>           <span class=nt>&#34;rds&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;route_config_name&#34;</span><span class=p>:</span> <span class=s2>&#34;9080&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;config_source&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>             <span class=nt>&#34;ads&#34;</span><span class=p>:</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>           <span class=p>},</span>
</span></span><span class=line><span class=cl>           <span class=nt>&#34;stream_idle_timeout&#34;</span><span class=p>:</span> <span class=s2>&#34;0.000s&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>           <span class=nt>&#34;generate_request_id&#34;</span><span class=p>:</span> <span class=kc>true</span><span class=p>,</span>
</span></span><span class=line><span class=cl>           <span class=nt>&#34;upgrade_configs&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>            <span class=p>{</span>
</span></span><span class=line><span class=cl>             <span class=nt>&#34;upgrade_type&#34;</span><span class=p>:</span> <span class=s2>&#34;websocket&#34;</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>           <span class=p>]</span>
</span></span><span class=line><span class=cl>          <span class=p>}</span>
</span></span><span class=line><span class=cl>         <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>]</span>
</span></span><span class=line><span class=cl>       <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=p>],</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;deprecated_v1&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>       <span class=nt>&#34;bind_to_port&#34;</span><span class=p>:</span> <span class=kc>false</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>     <span class=p>},</span>
</span></span><span class=line><span class=cl>     <span class=nt>&#34;last_updated&#34;</span><span class=p>:</span> <span class=s2>&#34;2018-09-06T09:34:26.172Z&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span><span class=err>,</span>
</span></span></code></pre></div><div id=routes class=anchor></div><h5 class="relative group">Routes
<span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#routes aria-label=锚点>#</a></span></h5><p>配置 Envoy 的路由规则。Istio 下发的缺省路由规则中对每个端口设置了一个路由规则，根据 host 来对请求进行路由分发。</p><p>下面是 <code>9080</code> 的路由配置，从文件中可以看到对应了 3 个 <code>virtual host</code>，分别是 details、ratings 和 reviews，这三个 virtual host 分别对应到不同的 <code>outbound cluster</code>。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>     <span class=nt>&#34;version_info&#34;</span><span class=p>:</span> <span class=s2>&#34;2018-09-14T01:38:20Z&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>     <span class=nt>&#34;route_config&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;name&#34;</span><span class=p>:</span> <span class=s2>&#34;9080&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;virtual_hosts&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>       <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;name&#34;</span><span class=p>:</span> <span class=s2>&#34;details.default.svc.cluster.local:9080&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;domains&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>         <span class=s2>&#34;details.default.svc.cluster.local&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>         <span class=s2>&#34;details.default.svc.cluster.local:9080&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>         <span class=s2>&#34;details&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>         <span class=s2>&#34;details:9080&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>         <span class=s2>&#34;details.default.svc.cluster&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>         <span class=s2>&#34;details.default.svc.cluster:9080&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>         <span class=s2>&#34;details.default.svc&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>         <span class=s2>&#34;details.default.svc:9080&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>         <span class=s2>&#34;details.default&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>         <span class=s2>&#34;details.default:9080&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>         <span class=s2>&#34;10.101.163.201&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>         <span class=s2>&#34;10.101.163.201:9080&#34;</span>
</span></span><span class=line><span class=cl>        <span class=p>],</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;routes&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>         <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=nt>&#34;match&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>           <span class=nt>&#34;prefix&#34;</span><span class=p>:</span> <span class=s2>&#34;/&#34;</span>
</span></span><span class=line><span class=cl>          <span class=p>},</span>
</span></span><span class=line><span class=cl>          <span class=nt>&#34;route&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>           <span class=nt>&#34;cluster&#34;</span><span class=p>:</span> <span class=s2>&#34;outbound|9080||details.default.svc.cluster.local&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>           <span class=nt>&#34;timeout&#34;</span><span class=p>:</span> <span class=s2>&#34;0s&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>           <span class=nt>&#34;max_grpc_timeout&#34;</span><span class=p>:</span> <span class=s2>&#34;0s&#34;</span>
</span></span><span class=line><span class=cl>          <span class=p>},</span>
</span></span><span class=line><span class=cl>          <span class=nt>&#34;decorator&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>           <span class=nt>&#34;operation&#34;</span><span class=p>:</span> <span class=s2>&#34;details.default.svc.cluster.local:9080/*&#34;</span>
</span></span><span class=line><span class=cl>          <span class=p>},</span>
</span></span><span class=line><span class=cl>          <span class=nt>&#34;per_filter_config&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>           <span class=nt>&#34;mixer&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=err>......</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>           <span class=p>}</span>
</span></span><span class=line><span class=cl>          <span class=p>}</span>
</span></span><span class=line><span class=cl>         <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>]</span>
</span></span><span class=line><span class=cl>       <span class=p>},</span>
</span></span><span class=line><span class=cl>       <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;name&#34;</span><span class=p>:</span> <span class=s2>&#34;ratings.default.svc.cluster.local:9080&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;domains&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>         <span class=s2>&#34;ratings.default.svc.cluster.local&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>         <span class=s2>&#34;ratings.default.svc.cluster.local:9080&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>         <span class=s2>&#34;ratings&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>         <span class=s2>&#34;ratings:9080&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>         <span class=s2>&#34;ratings.default.svc.cluster&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>         <span class=s2>&#34;ratings.default.svc.cluster:9080&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>         <span class=s2>&#34;ratings.default.svc&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>         <span class=s2>&#34;ratings.default.svc:9080&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>         <span class=s2>&#34;ratings.default&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>         <span class=s2>&#34;ratings.default:9080&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>         <span class=s2>&#34;10.99.16.205&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>         <span class=s2>&#34;10.99.16.205:9080&#34;</span>
</span></span><span class=line><span class=cl>        <span class=p>],</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;routes&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>         <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=nt>&#34;match&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>           <span class=nt>&#34;prefix&#34;</span><span class=p>:</span> <span class=s2>&#34;/&#34;</span>
</span></span><span class=line><span class=cl>          <span class=p>},</span>
</span></span><span class=line><span class=cl>          <span class=nt>&#34;route&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>           <span class=nt>&#34;cluster&#34;</span><span class=p>:</span> <span class=s2>&#34;outbound|9080||ratings.default.svc.cluster.local&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>           <span class=nt>&#34;timeout&#34;</span><span class=p>:</span> <span class=s2>&#34;0s&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>           <span class=nt>&#34;max_grpc_timeout&#34;</span><span class=p>:</span> <span class=s2>&#34;0s&#34;</span>
</span></span><span class=line><span class=cl>          <span class=p>},</span>
</span></span><span class=line><span class=cl>          <span class=nt>&#34;decorator&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>           <span class=nt>&#34;operation&#34;</span><span class=p>:</span> <span class=s2>&#34;ratings.default.svc.cluster.local:9080/*&#34;</span>
</span></span><span class=line><span class=cl>          <span class=p>},</span>
</span></span><span class=line><span class=cl>          <span class=nt>&#34;per_filter_config&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>           <span class=nt>&#34;mixer&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>           <span class=err>......</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=p>},</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;disable_check_calls&#34;</span><span class=p>:</span> <span class=kc>true</span>
</span></span><span class=line><span class=cl>           <span class=p>}</span>
</span></span><span class=line><span class=cl>          <span class=p>}</span>
</span></span><span class=line><span class=cl>         <span class=err>}</span>
</span></span><span class=line><span class=cl>        <span class=p>]</span>
</span></span><span class=line><span class=cl>       <span class=p>},</span>
</span></span><span class=line><span class=cl>       <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;name&#34;</span><span class=p>:</span> <span class=s2>&#34;reviews.default.svc.cluster.local:9080&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;domains&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>         <span class=s2>&#34;reviews.default.svc.cluster.local&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>         <span class=s2>&#34;reviews.default.svc.cluster.local:9080&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>         <span class=s2>&#34;reviews&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>         <span class=s2>&#34;reviews:9080&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>         <span class=s2>&#34;reviews.default.svc.cluster&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>         <span class=s2>&#34;reviews.default.svc.cluster:9080&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>         <span class=s2>&#34;reviews.default.svc&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>         <span class=s2>&#34;reviews.default.svc:9080&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>         <span class=s2>&#34;reviews.default&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>         <span class=s2>&#34;reviews.default:9080&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>         <span class=s2>&#34;10.108.25.157&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>         <span class=s2>&#34;10.108.25.157:9080&#34;</span>
</span></span><span class=line><span class=cl>        <span class=p>],</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;routes&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>         <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=nt>&#34;match&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>           <span class=nt>&#34;prefix&#34;</span><span class=p>:</span> <span class=s2>&#34;/&#34;</span>
</span></span><span class=line><span class=cl>          <span class=p>},</span>
</span></span><span class=line><span class=cl>          <span class=nt>&#34;route&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>           <span class=nt>&#34;cluster&#34;</span><span class=p>:</span> <span class=s2>&#34;outbound|9080||reviews.default.svc.cluster.local&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>           <span class=nt>&#34;timeout&#34;</span><span class=p>:</span> <span class=s2>&#34;0s&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>           <span class=nt>&#34;max_grpc_timeout&#34;</span><span class=p>:</span> <span class=s2>&#34;0s&#34;</span>
</span></span><span class=line><span class=cl>          <span class=p>},</span>
</span></span><span class=line><span class=cl>          <span class=nt>&#34;decorator&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>           <span class=nt>&#34;operation&#34;</span><span class=p>:</span> <span class=s2>&#34;reviews.default.svc.cluster.local:9080/*&#34;</span>
</span></span><span class=line><span class=cl>          <span class=p>},</span>
</span></span><span class=line><span class=cl>          <span class=nt>&#34;per_filter_config&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>           <span class=nt>&#34;mixer&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=err>......</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=p>},</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;disable_check_calls&#34;</span><span class=p>:</span> <span class=kc>true</span>
</span></span><span class=line><span class=cl>           <span class=p>}</span>
</span></span><span class=line><span class=cl>          <span class=p>}</span>
</span></span><span class=line><span class=cl>         <span class=err>}</span>
</span></span><span class=line><span class=cl>        <span class=p>]</span>
</span></span><span class=line><span class=cl>       <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=p>],</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;validate_clusters&#34;</span><span class=p>:</span> <span class=kc>false</span>
</span></span><span class=line><span class=cl>     <span class=p>},</span>
</span></span><span class=line><span class=cl>     <span class=nt>&#34;last_updated&#34;</span><span class=p>:</span> <span class=s2>&#34;2018-09-27T07:17:50.242Z&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span></code></pre></div><div id=bookinfo-端到端调用分析 class=anchor></div><h3 class="relative group">Bookinfo 端到端调用分析
<span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#bookinfo-%e7%ab%af%e5%88%b0%e7%ab%af%e8%b0%83%e7%94%a8%e5%88%86%e6%9e%90 aria-label=锚点>#</a></span></h3><p>通过前面章节对 Envoy 配置文件的分析，我们了解到 Istio 控制平面如何将服务和路由信息通过 xDS 接口下发到数据平面中；并介绍了 Envoy 上生成的各种配置数据的结构，包括 listener，cluster，route 和 endpoint。</p><p>下面我们来分析一个端到端的调用请求，通过调用请求的流程把这些配置串连起来，以从全局上理解 Istio 控制平面的流量控制是如何在数据平面的 Envoy 上实现的。</p><p>下图描述了一个 <code>Productpage</code> 服务调用 <code>Details</code> 服务的请求流程：</p><p><figure><img loading=lazy class="my-0 rounded-md" src=https://jsdelivr.icloudnative.io/gh/yangchuansheng/imghosting6@main/uPic/yD84dx.jpg alt></figure></p><p>1、Productpage 发起对 Details 的调用：<code>http://details:9080/details/0</code>。</p><p>2、请求被 Pod 的 iptables 规则拦截，转发到 15001 端口。</p><p>3、Envoy 的 Virtual Listener 在 <code>15001</code> 端口上监听，收到了该请求。</p><p>4、请求被 Virtual Listener 根据原目标 IP（通配）和端口（9080）转发到 <code>0.0.0.0_9080</code> 这个 listener。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl> <span class=nt>&#34;version_info&#34;</span><span class=p>:</span> <span class=s2>&#34;2018-09-06T09:34:19Z&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl> <span class=nt>&#34;listener&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;name&#34;</span><span class=p>:</span> <span class=s2>&#34;virtual&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;address&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>   <span class=nt>&#34;socket_address&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;address&#34;</span><span class=p>:</span> <span class=s2>&#34;0.0.0.0&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;port_value&#34;</span><span class=p>:</span> <span class=mi>15001</span>
</span></span><span class=line><span class=cl>   <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=err>......</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=s2>&#34;use_original_dst&#34;</span><span class=p>:</span> <span class=kc>true</span> <span class=c1>//请求转发给和原始目的IP:Port匹配的listener
</span></span></span><span class=line><span class=cl><span class=c1></span> <span class=p>},</span>
</span></span></code></pre></div><p>5、根据 0.0.0.0_9080 listener 的 <code>http_connection_manager filter</code> 配置,该请求采用 “9080” route 进行分发。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;version_info&#34;</span><span class=p>:</span> <span class=s2>&#34;2018-09-06T09:34:19Z&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;listener&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>   <span class=nt>&#34;name&#34;</span><span class=p>:</span> <span class=s2>&#34;0.0.0.0_9080&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>   <span class=nt>&#34;address&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;socket_address&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>     <span class=nt>&#34;address&#34;</span><span class=p>:</span> <span class=s2>&#34;0.0.0.0&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>     <span class=nt>&#34;port_value&#34;</span><span class=p>:</span> <span class=mi>9080</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>   <span class=p>},</span>
</span></span><span class=line><span class=cl>   <span class=nt>&#34;filter_chains&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>     <span class=nt>&#34;filters&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>      <span class=p>{</span>
</span></span><span class=line><span class=cl>       <span class=nt>&#34;name&#34;</span><span class=p>:</span> <span class=s2>&#34;envoy.http_connection_manager&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>       <span class=nt>&#34;config&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>       <span class=err>......</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;rds&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>         <span class=nt>&#34;route_config_name&#34;</span><span class=p>:</span> <span class=s2>&#34;9080&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>         <span class=nt>&#34;config_source&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=nt>&#34;ads&#34;</span><span class=p>:</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>         <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>},</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>     <span class=err>]</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>   <span class=p>],</span>
</span></span><span class=line><span class=cl>   <span class=nt>&#34;deprecated_v1&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;bind_to_port&#34;</span><span class=p>:</span> <span class=kc>false</span>
</span></span><span class=line><span class=cl>   <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=s2>&#34;last_updated&#34;</span><span class=err>:</span> <span class=s2>&#34;2018-09-06T09:34:26.172Z&#34;</span>
</span></span><span class=line><span class=cl> <span class=err>}</span><span class=p>,</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=p>},</span>
</span></span></code></pre></div><p>6、<code>9080</code> 这个 route 的配置中，host name 为 <code>details:9080</code> 的请求对应的 cluster 为 <code>outbound|9080||details.default.svc.cluster.local</code></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;version_info&#34;</span><span class=p>:</span> <span class=s2>&#34;2018-09-14T01:38:20Z&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;route_config&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>   <span class=nt>&#34;name&#34;</span><span class=p>:</span> <span class=s2>&#34;9080&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>   <span class=nt>&#34;virtual_hosts&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>     <span class=nt>&#34;name&#34;</span><span class=p>:</span> <span class=s2>&#34;details.default.svc.cluster.local:9080&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>     <span class=nt>&#34;domains&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>      <span class=s2>&#34;details.default.svc.cluster.local&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=s2>&#34;details.default.svc.cluster.local:9080&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=s2>&#34;details&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=s2>&#34;details:9080&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=s2>&#34;details.default.svc.cluster&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=s2>&#34;details.default.svc.cluster:9080&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=s2>&#34;details.default.svc&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=s2>&#34;details.default.svc:9080&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=s2>&#34;details.default&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=s2>&#34;details.default:9080&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=s2>&#34;10.101.163.201&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=s2>&#34;10.101.163.201:9080&#34;</span>
</span></span><span class=line><span class=cl>     <span class=p>],</span>
</span></span><span class=line><span class=cl>     <span class=nt>&#34;routes&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>      <span class=p>{</span>
</span></span><span class=line><span class=cl>       <span class=nt>&#34;match&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;prefix&#34;</span><span class=p>:</span> <span class=s2>&#34;/&#34;</span>
</span></span><span class=line><span class=cl>       <span class=p>},</span>
</span></span><span class=line><span class=cl>       <span class=nt>&#34;route&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;cluster&#34;</span><span class=p>:</span> <span class=s2>&#34;outbound|9080||details.default.svc.cluster.local&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;timeout&#34;</span><span class=p>:</span> <span class=s2>&#34;0s&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;max_grpc_timeout&#34;</span><span class=p>:</span> <span class=s2>&#34;0s&#34;</span>
</span></span><span class=line><span class=cl>       <span class=p>},</span>
</span></span><span class=line><span class=cl>         <span class=err>......</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>       <span class=err>}</span>
</span></span><span class=line><span class=cl>      <span class=err>}</span>
</span></span><span class=line><span class=cl>     <span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>      <span class=err>......</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=p>},</span>   
</span></span></code></pre></div><p>7、<code>outbound|9080||details.default.svc.cluster.local</code> cluster 为动态资源，通过 eds 查询得到其 endpoint 为 192.168.206.21:9080。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl> <span class=p>{</span>
</span></span><span class=line><span class=cl> <span class=nt>&#34;clusterName&#34;</span><span class=p>:</span> <span class=s2>&#34;outbound|9080||details.default.svc.cluster.local&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl> <span class=nt>&#34;endpoints&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl> <span class=p>{</span>
</span></span><span class=line><span class=cl>   <span class=nt>&#34;locality&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>   <span class=p>},</span>
</span></span><span class=line><span class=cl>   <span class=nt>&#34;lbEndpoints&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>     <span class=p>{</span>
</span></span><span class=line><span class=cl>       <span class=nt>&#34;endpoint&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>         <span class=nt>&#34;address&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>           <span class=nt>&#34;socketAddress&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>             <span class=nt>&#34;address&#34;</span><span class=p>:</span> <span class=s2>&#34;192.168.206.21&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>             <span class=nt>&#34;portValue&#34;</span><span class=p>:</span> <span class=mi>9080</span>
</span></span><span class=line><span class=cl>           <span class=p>}</span>
</span></span><span class=line><span class=cl>         <span class=p>}</span>
</span></span><span class=line><span class=cl>       <span class=p>},</span>
</span></span><span class=line><span class=cl>      <span class=err>......</span>  
</span></span><span class=line><span class=cl>     <span class=p>}</span>
</span></span><span class=line><span class=cl>   <span class=p>]</span>
</span></span><span class=line><span class=cl> <span class=p>}</span>
</span></span><span class=line><span class=cl> <span class=p>]</span>
</span></span><span class=line><span class=cl> <span class=p>}</span>   
</span></span></code></pre></div><p>8、请求被转发到 192.168.206.21，即 Details 服务所在的 Pod，被 iptables 规则拦截，转发到 15001 端口。</p><p>9、Envoy 的 <code>Virtual Listener</code> 在 15001 端口上监听，收到了该请求。</p><p>10、请求被 Virtual Listener 根据请求原目标地址 IP（192.168.206.21）和端口（9080）转发到 <code>192.168.206.21_9080</code> 这个 listener。</p><p>11、根据 92.168.206.21_9080 listener 的 <code>http_connection_manager filter</code> 配置，该请求对应的 cluster 为 <code>inbound|9080||details.default.svc.cluster.local</code>。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;version_info&#34;</span><span class=p>:</span> <span class=s2>&#34;2018-09-06T09:34:16Z&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;listener&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>   <span class=nt>&#34;name&#34;</span><span class=p>:</span> <span class=s2>&#34;192.168.206.21_9080&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>   <span class=nt>&#34;address&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;socket_address&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>     <span class=nt>&#34;address&#34;</span><span class=p>:</span> <span class=s2>&#34;192.168.206.21&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>     <span class=nt>&#34;port_value&#34;</span><span class=p>:</span> <span class=mi>9080</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>   <span class=p>},</span>
</span></span><span class=line><span class=cl>   <span class=nt>&#34;filter_chains&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>     <span class=nt>&#34;filters&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>      <span class=p>{</span>
</span></span><span class=line><span class=cl>       <span class=nt>&#34;name&#34;</span><span class=p>:</span> <span class=s2>&#34;envoy.http_connection_manager&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>       <span class=err>......</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>       <span class=nt>&#34;route_config&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>         <span class=nt>&#34;name&#34;</span><span class=p>:</span> <span class=s2>&#34;inbound|9080||details.default.svc.cluster.local&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>         <span class=nt>&#34;validate_clusters&#34;</span><span class=p>:</span> <span class=kc>false</span><span class=p>,</span>
</span></span><span class=line><span class=cl>         <span class=nt>&#34;virtual_hosts&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>          <span class=p>{</span>
</span></span><span class=line><span class=cl>           <span class=nt>&#34;name&#34;</span><span class=p>:</span> <span class=s2>&#34;inbound|http|9080&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>           <span class=nt>&#34;routes&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>             <span class=err>......</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>             <span class=s2>&#34;route&#34;</span><span class=err>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>              <span class=nt>&#34;max_grpc_timeout&#34;</span><span class=p>:</span> <span class=s2>&#34;0.000s&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>              <span class=nt>&#34;cluster&#34;</span><span class=p>:</span> <span class=s2>&#34;inbound|9080||details.default.svc.cluster.local&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>              <span class=nt>&#34;timeout&#34;</span><span class=p>:</span> <span class=s2>&#34;0.000s&#34;</span>
</span></span><span class=line><span class=cl>             <span class=p>},</span>
</span></span><span class=line><span class=cl>             <span class=err>......</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>             <span class=s2>&#34;match&#34;</span><span class=err>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>              <span class=nt>&#34;prefix&#34;</span><span class=p>:</span> <span class=s2>&#34;/&#34;</span>
</span></span><span class=line><span class=cl>             <span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=err>}</span>
</span></span><span class=line><span class=cl>           <span class=p>],</span>
</span></span><span class=line><span class=cl>           <span class=nt>&#34;domains&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;*&#34;</span>
</span></span><span class=line><span class=cl>           <span class=p>]</span>
</span></span><span class=line><span class=cl>          <span class=p>}</span>
</span></span><span class=line><span class=cl>         <span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=p>},</span>
</span></span><span class=line><span class=cl>         <span class=err>......</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=err>]</span>
</span></span><span class=line><span class=cl>       <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=err>}</span>
</span></span><span class=line><span class=cl>     <span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>   <span class=p>],</span>
</span></span><span class=line><span class=cl>   <span class=nt>&#34;deprecated_v1&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;bind_to_port&#34;</span><span class=p>:</span> <span class=kc>false</span>
</span></span><span class=line><span class=cl>   <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;last_updated&#34;</span><span class=p>:</span> <span class=s2>&#34;2018-09-06T09:34:22.184Z&#34;</span>
</span></span><span class=line><span class=cl> <span class=p>}</span>   
</span></span></code></pre></div><p>12、<code>inbound|9080||details.default.svc.cluster.local</code> cluster 配置的 host 为<code>127.0.0.1:9080</code>。</p><p>13、请求被转发到 127.0.0.1:9080，即 Details 服务进行处理。</p><p>上述调用流程涉及的完整 Envoy 配置文件参见：</p><ul><li>Proudctpage ：<a href=https://gist.github.com/zhaohuabing/034ef87786d290a4e89cd6f5ad6fcc97 target=_blank>https://gist.github.com/zhaohuabing/034ef87786d290a4e89cd6f5ad6fcc97</a></li><li>Details ：<a href=https://gist.github.com/zhaohuabing/544d4d45447b65d10150e528a190f8ee target=_blank>https://gist.github.com/zhaohuabing/544d4d45447b65d10150e528a190f8ee</a></li></ul><div id=小结 class=anchor></div><h2 class="relative group">小结
<span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%e5%b0%8f%e7%bb%93 aria-label=锚点>#</a></span></h2><hr><p>本文介绍了 Istio 流量管理相关组件，Istio 控制平面和数据平面之间的标准接口，以及 Istio 下发到 Envoy 的完整配置数据的结构和内容。然后通过 Bookinfo 示例程序的一个端到端调用分析了 Envoy 是如何实现服务网格中服务发现和路由转发的，希望能帮助大家透过概念更进一步深入理解 Istio 流量管理的实现机制。</p><div id=参考资料 class=anchor></div><h2 class="relative group">参考资料
<span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%e5%8f%82%e8%80%83%e8%b5%84%e6%96%99 aria-label=锚点>#</a></span></h2><hr><ol><li><a href=https://istio.io/docs/concepts/traffic-management/#pilot-and-envoy target=_blank>Istio Traffic Managment Concept</a></li><li><a href=https://github.com/envoyproxy/data-plane-api/blob/master/API_OVERVIEW.md target=_blank>Data Plane API</a></li><li><a href=https://kubernetes.io/docs/concepts/extend-kubernetes/api-extension/custom-resources target=_blank>kubernetes Custom Resource</a></li><li><a href=https://github.com/istio/old_pilot_repo/blob/master/doc/design.md target=_blank>Istio Pilot Design Overview</a></li><li><a href=https://www.envoyproxy.io/docs/envoy/latest/configuration/overview/v2_overview target=_blank>Envoy V2 API Overview</a></li><li><a href=https://github.com/envoyproxy/data-plane-api/tree/master/envoy/api/v2 target=_blank>Data Plane API Protocol Buffer Definition</a></li><li><a href=https://github.com/envoyproxy/data-plane-api/blob/master/XDS_PROTOCOL.md target=_blank>xDS REST and gRPC protocol</a></li><li><a href=https://github.com/istio/istio/tree/master/pilot/pkg/proxy/envoy/v2 target=_blank>Pilot Debug interface</a></li><li><a href=https://zhaohuabing.com/2018/05/23/istio-auto-injection-with-webhook/ target=_blank>Istio Sidecar自动注入原理</a></li></ol></div><div class="text-neutral-700 dark:text-neutral-300" style=text-align:center;font-size:16px;font-family:cursive>-------他日江湖相逢
<span class="relative icon" style=display:inline-block><svg version="1.0" id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="800" height="800" viewBox="0 0 64 64" enable-background="new 0 0 64 64"><g><path fill="#394240" d="M35 4.145V3.002 3c0-1.656-1.343-3-3-3s-3 1.344-3 3v.002 1.143C12.734 5.658.0 19.338.0 36c0 0 0 1 1 1s1.867-1 1.867-1C4.68 34.15 7.204 33 10 33c4.1.0 7.618 2.469 9.162 6 0 0 .541 1 1.838 1s1.838-1 1.838-1c1.15-2.629 3.396-4.668 6.162-5.539V56c0 4.418 3.582 8 8 8s8-3.582 8-8c0-1.656-1.343-3-3-3s-3 1.344-3 3c0 1.104-.896 2-2 2s-2-.896-2-2V33.461c2.766.871 5.012 2.91 6.162 5.539.0.0.541 1 1.838 1s1.838-1 1.838-1c1.544-3.531 5.062-6 9.162-6 2.796.0 5.319 1.15 7.133 3 0 0 .867 1 1.867 1s1-1 1-1C64 19.338 51.266 5.658 35 4.145zM31 3c0-.553.447-1 1-1s1 .447 1 1v1.025C32.667 4.016 32.335 4 32 4s-.667.016-1 .025V3zM10 31c-3.047.0-5.816 1.145-7.928 3.018C3.006 19.729 13.94 8.17 27.947 6.277 22.911 14.678 20 24.492 20 35v1.387C17.853 33.145 14.181 31 10 31zM37 60c2.209.0 4-1.791 4-4 0-.553.447-1 1-1s1 .447 1 1c0 3.312-2.687 6-6 6s-6-2.688-6-6V33.055C31.329 33.023 31.662 33 32 33s.671.023 1 .055V56c0 2.209 1.791 4 4 4zM32 31c-4.181.0-7.853 2.145-10 5.387V35c0-10.662 3.113-20.588 8.449-28.959.5-.025 1.004-.039 1.511-.039h.08c.507.0 1.011.014 1.511.039C38.887 14.412 42 24.338 42 35v1.387C39.853 33.145 36.181 31 32 31zm22 0c-4.181.0-7.853 2.145-10 5.387V35c0-10.508-2.911-20.322-7.947-28.723C50.06 8.17 60.994 19.729 61.928 34.018 59.816 32.145 57.047 31 54 31z"/><path fill="#f9ebb2" d="M31 3c0-.553.447-1 1-1s1 .447 1 1v1.025C32.667 4.016 32.335 4 32 4s-.667.016-1 .025V3z"/><g><path fill="#45aab8" d="M2.072 34.018C4.184 32.145 6.953 31 10 31c4.181.0 7.853 2.145 10 5.387V35c0-10.508 2.911-20.322 7.947-28.723C13.94 8.17 3.006 19.729 2.072 34.018z"/><path fill="#45aab8" d="M36.053 6.277C41.089 14.678 44 24.492 44 35v1.387C46.147 33.145 49.819 31 54 31c3.047.0 5.816 1.145 7.928 3.018C60.994 19.729 50.06 8.17 36.053 6.277z"/></g><path fill="#b4ccb9" d="M32.04 6.002h-.08c-.507.0-1.011.014-1.511.039C25.113 14.412 22 24.338 22 35v1.387C24.147 33.145 27.819 31 32 31s7.853 2.145 10 5.387V35c0-10.662-3.113-20.588-8.449-28.959C33.051 6.016 32.547 6.002 32.04 6.002z"/><path fill="#f9ebb2" d="M37 60c2.209.0 4-1.791 4-4 0-.553.447-1 1-1s1 .447 1 1c0 3.312-2.687 6-6 6s-6-2.688-6-6V33.055C31.329 33.023 31.662 33 32 33s.671.023 1 .055V56c0 2.209 1.791 4 4 4z"/></g></svg></span>再当杯酒言欢-------</div><section class="flex flex-row flex-wrap justify-center pt-4 text-xl"><a target=_blank class="m-1 rounded bg-neutral-300 p-1.5 text-neutral-700 hover:bg-primary-500 hover:text-neutral dark:bg-neutral-700 dark:text-neutral-300 dark:hover:bg-primary-400 dark:hover:text-neutral-800" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https://icloudnative.io/posts/istio-traffic-management-impl-intro/&amp;title=Istio%20%e6%b5%81%e9%87%8f%e7%ae%a1%e7%90%86%e5%ae%9e%e7%8e%b0%e6%9c%ba%e5%88%b6%e6%b7%b1%e5%ba%a6%e8%a7%a3%e6%9e%90" title="分享到 LinkedIn" aria-label="分享到 LinkedIn"><span class="relative block icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path fill="currentcolor" d="M416 32H31.9C14.3 32 0 46.5.0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6.0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3zM135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3.0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2.0 38.5 17.3 38.5 38.5.0 21.3-17.2 38.5-38.5 38.5zm282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6.0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2.0 79.7 44.3 79.7 101.9V416z"/></svg></span></a><a target=_blank class="m-1 rounded bg-neutral-300 p-1.5 text-neutral-700 hover:bg-primary-500 hover:text-neutral dark:bg-neutral-700 dark:text-neutral-300 dark:hover:bg-primary-400 dark:hover:text-neutral-800" href="https://twitter.com/intent/tweet/?url=https://icloudnative.io/posts/istio-traffic-management-impl-intro/&amp;text=Istio%20%e6%b5%81%e9%87%8f%e7%ae%a1%e7%90%86%e5%ae%9e%e7%8e%b0%e6%9c%ba%e5%88%b6%e6%b7%b1%e5%ba%a6%e8%a7%a3%e6%9e%90" title="分享到 Twitter" aria-label="分享到 Twitter"><span class="relative block icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M389.2 48h70.6L305.6 224.2 487 464H345L233.7 318.6 106.5 464H35.8L200.7 275.5 26.8 48H172.4L272.9 180.9 389.2 48zM364.4 421.8h39.1L151.1 88h-42L364.4 421.8z"/></svg></span></a><a target=_blank class="m-1 rounded bg-neutral-300 p-1.5 text-neutral-700 hover:bg-primary-500 hover:text-neutral dark:bg-neutral-700 dark:text-neutral-300 dark:hover:bg-primary-400 dark:hover:text-neutral-800" href="https://reddit.com/submit/?url=https://icloudnative.io/posts/istio-traffic-management-impl-intro/&amp;resubmit=true&amp;title=Istio%20%e6%b5%81%e9%87%8f%e7%ae%a1%e7%90%86%e5%ae%9e%e7%8e%b0%e6%9c%ba%e5%88%b6%e6%b7%b1%e5%ba%a6%e8%a7%a3%e6%9e%90" title="提交到 Reddit" aria-label="提交到 Reddit"><span class="relative block icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M201.5 305.5c-13.8.0-24.9-11.1-24.9-24.6.0-13.8 11.1-24.9 24.9-24.9 13.6.0 24.6 11.1 24.6 24.9.0 13.6-11.1 24.6-24.6 24.6zM504 256c0 137-111 248-248 248S8 393 8 256 119 8 256 8s248 111 248 248zm-132.3-41.2c-9.4.0-17.7 3.9-23.8 10-22.4-15.5-52.6-25.5-86.1-26.6l17.4-78.3 55.4 12.5c0 13.6 11.1 24.6 24.6 24.6 13.8.0 24.9-11.3 24.9-24.9s-11.1-24.9-24.9-24.9c-9.7.0-18 5.8-22.1 13.8l-61.2-13.6c-3-.8-6.1 1.4-6.9 4.4l-19.1 86.4c-33.2 1.4-63.1 11.3-85.5 26.8-6.1-6.4-14.7-10.2-24.1-10.2-34.9.0-46.3 46.9-14.4 62.8-1.1 5-1.7 10.2-1.7 15.5.0 52.6 59.2 95.2 132 95.2 73.1.0 132.3-42.6 132.3-95.2.0-5.3-.6-10.8-1.9-15.8 31.3-16 19.8-62.5-14.9-62.5zM302.8 331c-18.2 18.2-76.1 17.9-93.6.0-2.2-2.2-6.1-2.2-8.3.0-2.5 2.5-2.5 6.4.0 8.6 22.8 22.8 87.3 22.8 110.2.0 2.5-2.2 2.5-6.1.0-8.6-2.2-2.2-6.1-2.2-8.3.0zm7.7-75c-13.6.0-24.6 11.1-24.6 24.9.0 13.6 11.1 24.6 24.6 24.6 13.8.0 24.9-11.1 24.9-24.6.0-13.8-11-24.9-24.9-24.9z"/></svg></span></a><a target=_blank class="m-1 rounded bg-neutral-300 p-1.5 text-neutral-700 hover:bg-primary-500 hover:text-neutral dark:bg-neutral-700 dark:text-neutral-300 dark:hover:bg-primary-400 dark:hover:text-neutral-800" href="https://api.whatsapp.com/send?text=https://icloudnative.io/posts/istio-traffic-management-impl-intro/&amp;resubmit=true&amp;title=Istio%20%e6%b5%81%e9%87%8f%e7%ae%a1%e7%90%86%e5%ae%9e%e7%8e%b0%e6%9c%ba%e5%88%b6%e6%b7%b1%e5%ba%a6%e8%a7%a3%e6%9e%90" title aria-label><span class="relative block icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path fill="currentcolor" d="M380.9 97.1C339 55.1 283.2 32 223.9 32c-122.4.0-222 99.6-222 222 0 39.1 10.2 77.3 29.6 111L0 480l117.7-30.9c32.4 17.7 68.9 27 106.1 27h.1c122.3.0 224.1-99.6 224.1-222 0-59.3-25.2-115-67.1-157zm-157 341.6c-33.2.0-65.7-8.9-94-25.7l-6.7-4-69.8 18.3L72 359.2l-4.4-7c-18.5-29.4-28.2-63.3-28.2-98.2.0-101.7 82.8-184.5 184.6-184.5 49.3.0 95.6 19.2 130.4 54.1 34.8 34.9 56.2 81.2 56.1 130.5.0 101.8-84.9 184.6-186.6 184.6zm101.2-138.2c-5.5-2.8-32.8-16.2-37.9-18-5.1-1.9-8.8-2.8-12.5 2.8s-14.3 18-17.6 21.8c-3.2 3.7-6.5 4.2-12 1.4-32.6-16.3-54-29.1-75.5-66-5.7-9.8 5.7-9.1 16.3-30.3 1.8-3.7.9-6.9-.5-9.7-1.4-2.8-12.5-30.1-17.1-41.2-4.5-10.8-9.1-9.3-12.5-9.5-3.2-.2-6.9-.2-10.6-.2s-9.7 1.4-14.8 6.9c-5.1 5.6-19.4 19-19.4 46.3.0 27.3 19.9 53.7 22.6 57.4 2.8 3.7 39.1 59.7 94.8 83.8 35.2 15.2 49 16.5 66.6 13.9 10.7-1.6 32.8-13.4 37.4-26.4 4.6-13 4.6-24.1 3.2-26.4-1.3-2.5-5-3.9-10.5-6.6z"/></svg></span></a><a target=_blank class="m-1 rounded bg-neutral-300 p-1.5 text-neutral-700 hover:bg-primary-500 hover:text-neutral dark:bg-neutral-700 dark:text-neutral-300 dark:hover:bg-primary-400 dark:hover:text-neutral-800" href="https://t.me/share/url?url=https://icloudnative.io/posts/istio-traffic-management-impl-intro/&amp;resubmit=true&amp;title=Istio%20%e6%b5%81%e9%87%8f%e7%ae%a1%e7%90%86%e5%ae%9e%e7%8e%b0%e6%9c%ba%e5%88%b6%e6%b7%b1%e5%ba%a6%e8%a7%a3%e6%9e%90" title aria-label><span class="relative block icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><path fill="currentcolor" d="M248 8C111.033 8 0 119.033.0 256S111.033 504 248 504 496 392.967 496 256 384.967 8 248 8zM362.952 176.66c-3.732 39.215-19.881 134.378-28.1 178.3-3.476 18.584-10.322 24.816-16.948 25.425-14.4 1.326-25.338-9.517-39.287-18.661-21.827-14.308-34.158-23.215-55.346-37.177-24.485-16.135-8.612-25 5.342-39.5 3.652-3.793 67.107-61.51 68.335-66.746.153-.655.3-3.1-1.154-4.384s-3.59-.849-5.135-.5q-3.283.746-104.608 69.142-14.845 10.194-26.894 9.934c-8.855-.191-25.888-5.006-38.551-9.123-15.531-5.048-27.875-7.717-26.8-16.291q.84-6.7 18.45-13.7 108.446-47.248 144.628-62.3c68.872-28.647 83.183-33.623 92.511-33.789 2.052-.034 6.639.474 9.61 2.885a10.452 10.452.0 013.53 6.716A43.765 43.765.0 01362.952 176.66z"/></svg></span></a><a target=_blank class="m-1 rounded bg-neutral-300 p-1.5 text-neutral-700 hover:bg-primary-500 hover:text-neutral dark:bg-neutral-700 dark:text-neutral-300 dark:hover:bg-primary-400 dark:hover:text-neutral-800" href="https://pinterest.com/pin/create/bookmarklet/?url=https://icloudnative.io/posts/istio-traffic-management-impl-intro/&amp;description=Istio%20%e6%b5%81%e9%87%8f%e7%ae%a1%e7%90%86%e5%ae%9e%e7%8e%b0%e6%9c%ba%e5%88%b6%e6%b7%b1%e5%ba%a6%e8%a7%a3%e6%9e%90" title="钉到 Pinterest" aria-label="钉到 Pinterest"><span class="relative block icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><path fill="currentcolor" d="M496 256c0 137-111 248-248 248-25.6.0-50.2-3.9-73.4-11.1 10.1-16.5 25.2-43.5 30.8-65 3-11.6 15.4-59 15.4-59 8.1 15.4 31.7 28.5 56.8 28.5 74.8.0 128.7-68.8 128.7-154.3.0-81.9-66.9-143.2-152.9-143.2-107 0-163.9 71.8-163.9 150.1.0 36.4 19.4 81.7 50.3 96.1 4.7 2.2 7.2 1.2 8.3-3.3.8-3.4 5-20.3 6.9-28.1.6-2.5.3-4.7-1.7-7.1-10.1-12.5-18.3-35.3-18.3-56.6.0-54.7 41.4-107.6 112-107.6 60.9.0 103.6 41.5 103.6 100.9.0 67.1-33.9 113.6-78 113.6-24.3.0-42.6-20.1-36.7-44.8 7-29.5 20.5-61.3 20.5-82.6.0-19-10.2-34.9-31.4-34.9-24.9.0-44.9 25.7-44.9 60.2.0 22 7.4 36.8 7.4 36.8s-24.5 103.8-29 123.2c-5 21.4-3 51.6-.9 71.2C65.4 450.9.0 361.1.0 256 0 119 111 8 248 8s248 111 248 248z"/></svg></span></a><a target=_blank class="m-1 rounded bg-neutral-300 p-1.5 text-neutral-700 hover:bg-primary-500 hover:text-neutral dark:bg-neutral-700 dark:text-neutral-300 dark:hover:bg-primary-400 dark:hover:text-neutral-800" href="https://www.facebook.com/sharer/sharer.php?u=https://icloudnative.io/posts/istio-traffic-management-impl-intro/&amp;quote=Istio%20%e6%b5%81%e9%87%8f%e7%ae%a1%e7%90%86%e5%ae%9e%e7%8e%b0%e6%9c%ba%e5%88%b6%e6%b7%b1%e5%ba%a6%e8%a7%a3%e6%9e%90" title="分享到 Facebook" aria-label="分享到 Facebook"><span class="relative block icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M504 256C504 119 393 8 256 8S8 119 8 256c0 123.78 90.69 226.38 209.25 245V327.69h-63V256h63v-54.64c0-62.15 37-96.48 93.67-96.48 27.14.0 55.52 4.84 55.52 4.84v61h-31.28c-30.8.0-40.41 19.12-40.41 38.73V256h68.78l-11 71.69h-57.78V501C413.31 482.38 504 379.78 504 256z"/></svg></span></a><a target=_blank class="m-1 rounded bg-neutral-300 p-1.5 text-neutral-700 hover:bg-primary-500 hover:text-neutral dark:bg-neutral-700 dark:text-neutral-300 dark:hover:bg-primary-400 dark:hover:text-neutral-800" href="mailto:?body=https://icloudnative.io/posts/istio-traffic-management-impl-intro/&amp;subject=Istio%20%e6%b5%81%e9%87%8f%e7%ae%a1%e7%90%86%e5%ae%9e%e7%8e%b0%e6%9c%ba%e5%88%b6%e6%b7%b1%e5%ba%a6%e8%a7%a3%e6%9e%90" title=通过电子邮件发送 aria-label=通过电子邮件发送><span class="relative block icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M207.8 20.73c-93.45 18.32-168.7 93.66-187 187.1-27.64 140.9 68.65 266.2 199.1 285.1 19.01 2.888 36.17-12.26 36.17-31.49l1e-4-.6631c0-15.74-11.44-28.88-26.84-31.24-84.35-12.98-149.2-86.13-149.2-174.2.0-102.9 88.61-185.5 193.4-175.4 91.54 8.869 158.6 91.25 158.6 183.2v16.16c0 22.09-17.94 40.05-40 40.05s-40.01-17.96-40.01-40.05v-120.1c0-8.847-7.161-16.02-16.01-16.02l-31.98.0036c-7.299.0-13.2 4.992-15.12 11.68-24.85-12.15-54.24-16.38-86.06-5.106-38.75 13.73-68.12 48.91-73.72 89.64-9.483 69.01 43.81 128 110.9 128 26.44.0 50.43-9.544 69.59-24.88 24 31.3 65.23 48.69 109.4 37.49C465.2 369.3 496 324.1 495.1 277.2V256.3c0-149.2-133.9-265.632-287.3-235.57zM239.1 304.3c-26.47.0-48-21.56-48-48.05s21.53-48.05 48-48.05 48 21.56 48 48.05-20.6 48.05-48 48.05z"/></svg></span></a></section><h2 class="mt-8 text-2xl font-extrabold mb-10">相关文章</h2><section class="w-full grid gap-4 sm:grid-cols-2 md:grid-cols-3"><a href=/posts/vistio-visualize-your-istio-mesh-using-netflixs-vizceral/ class=min-w-full><div class="min-h-full border border-neutral-200 dark:border-neutral-700 border-2 rounded overflow-hidden shadow-2xl relative backdrop-blur"><div class="w-full thumbnail_card_related nozoom" style=background-image:url(/posts/vistio-visualize-your-istio-mesh-using-netflixs-vizceral/featured_hu4b2085f0cc3f0ae18cfe3c81c9868eac_91012_600x0_resize_q75_box.jpg)></div><div class="px-6 py-4"><div class="font-bold text-xl text-neutral-800 decoration-primary-500 hover:underline hover:underline-offset-2 dark:text-neutral" href=/posts/vistio-visualize-your-istio-mesh-using-netflixs-vizceral/>Vistio—使用 Netflix 的 Vizceral 可视化 Istio service mesh</div><div class="text-sm text-neutral-500 dark:text-neutral-400"><div class="flex flex-row flex-wrap items-center"><time datetime="2018-08-03 15:29:37 +0800 +0800">2018年8月3日</time><span class="px-2 text-primary-500">&#183;</span><span>1797 字</span><span class="px-2 text-primary-500">&#183;</span><span title=预计阅读>4 分钟</span><span class="px-2 text-primary-500">&#183;</span><span>
<span id=busuanzi_page_pv></span>
<span class="inline-block align-text-bottom"><span class="relative block icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><path fill="currentcolor" d="M288 32c-80.8.0-145.5 36.8-192.6 80.6C48.6 156 17.3 208 2.5 243.7c-3.3 7.9-3.3 16.7.0 24.6C17.3 304 48.6 356 95.4 399.4 142.5 443.2 207.2 480 288 480s145.5-36.8 192.6-80.6c46.8-43.5 78.1-95.4 93-131.1 3.3-7.9 3.3-16.7.0-24.6-14.9-35.7-46.2-87.7-93-131.1C433.5 68.8 368.8 32 288 32zM432 256c0 79.5-64.5 144-144 144s-144-64.5-144-144 64.5-144 144-144 144 64.5 144 144zM288 192c0 35.3-28.7 64-64 64-11.5.0-22.3-3-31.6-8.4-.2 2.8-.4 5.5-.4 8.4.0 53 43 96 96 96s96-43 96-96-43-96-96-96c-2.8.0-5.6.1-8.4.4 5.3 9.3 8.4 20.1 8.4 31.6z"/></svg></span></span></span></div><div class="flex flex-row flex-wrap items-center"></div><div class="flex flex-row flex-wrap items-center"><span style=margin-top:.5rem class=mr-2 onclick='window.open("/categories/service-mesh/","_self")'><span class=flex><span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">服务网格
</span></span></span><span style=margin-top:.5rem class=mr-2 onclick='window.open("/tags/istio/","_self")'><span class=flex><span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">Istio</span></span></span></div></div></div><div class="px-6 pt-4 pb-2"></div></div></a><a href=/posts/increasing-security-of-istio-deployments/ class=min-w-full><div class="min-h-full border border-neutral-200 dark:border-neutral-700 border-2 rounded overflow-hidden shadow-2xl relative backdrop-blur"><div class="w-full thumbnail_card_related nozoom" style=background-image:url(/posts/increasing-security-of-istio-deployments/featured_hu6148ca75d81086ce4da70a9aa4cc68ce_12833_600x0_resize_q75_box.jpg)></div><div class="px-6 py-4"><div class="font-bold text-xl text-neutral-800 decoration-primary-500 hover:underline hover:underline-offset-2 dark:text-neutral" href=/posts/increasing-security-of-istio-deployments/>通过消除对特权容器的需求来提高 Istio Deployment 的安全性</div><div class="text-sm text-neutral-500 dark:text-neutral-400"><div class="flex flex-row flex-wrap items-center"><time datetime="2018-09-21 13:10:18 +0800 +0800">2018年9月21日</time><span class="px-2 text-primary-500">&#183;</span><span>1519 字</span><span class="px-2 text-primary-500">&#183;</span><span title=预计阅读>4 分钟</span><span class="px-2 text-primary-500">&#183;</span><span>
<span id=busuanzi_page_pv></span>
<span class="inline-block align-text-bottom"><span class="relative block icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><path fill="currentcolor" d="M288 32c-80.8.0-145.5 36.8-192.6 80.6C48.6 156 17.3 208 2.5 243.7c-3.3 7.9-3.3 16.7.0 24.6C17.3 304 48.6 356 95.4 399.4 142.5 443.2 207.2 480 288 480s145.5-36.8 192.6-80.6c46.8-43.5 78.1-95.4 93-131.1 3.3-7.9 3.3-16.7.0-24.6-14.9-35.7-46.2-87.7-93-131.1C433.5 68.8 368.8 32 288 32zM432 256c0 79.5-64.5 144-144 144s-144-64.5-144-144 64.5-144 144-144 144 64.5 144 144zM288 192c0 35.3-28.7 64-64 64-11.5.0-22.3-3-31.6-8.4-.2 2.8-.4 5.5-.4 8.4.0 53 43 96 96 96s96-43 96-96-43-96-96-96c-2.8.0-5.6.1-8.4.4 5.3 9.3 8.4 20.1 8.4 31.6z"/></svg></span></span></span></div><div class="flex flex-row flex-wrap items-center"></div><div class="flex flex-row flex-wrap items-center"><span style=margin-top:.5rem class=mr-2 onclick='window.open("/categories/service-mesh/","_self")'><span class=flex><span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">服务网格
</span></span></span><span style=margin-top:.5rem class=mr-2 onclick='window.open("/tags/istio/","_self")'><span class=flex><span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">Istio</span></span></span></div></div></div><div class="px-6 pt-4 pb-2"></div></div></a><a href=/posts/expose-gateway-of-istio/ class=min-w-full><div class="min-h-full border border-neutral-200 dark:border-neutral-700 border-2 rounded overflow-hidden shadow-2xl relative backdrop-blur"><div class="w-full thumbnail_card_related nozoom" style=background-image:url(/posts/expose-gateway-of-istio/featured_huaf0ca824606f8f4d9c1f80e506c596e0_65432_600x0_resize_q75_box.jpg)></div><div class="px-6 py-4"><div class="font-bold text-xl text-neutral-800 decoration-primary-500 hover:underline hover:underline-offset-2 dark:text-neutral" href=/posts/expose-gateway-of-istio/>暴露 Istio Service Mesh 中的 Gateway</div><div class="text-sm text-neutral-500 dark:text-neutral-400"><div class="flex flex-row flex-wrap items-center"><time datetime="2018-09-17 13:14:55 +0800 +0800">2018年9月17日</time><span class="px-2 text-primary-500">&#183;</span><span>1421 字</span><span class="px-2 text-primary-500">&#183;</span><span title=预计阅读>3 分钟</span><span class="px-2 text-primary-500">&#183;</span><span>
<span id=busuanzi_page_pv></span>
<span class="inline-block align-text-bottom"><span class="relative block icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><path fill="currentcolor" d="M288 32c-80.8.0-145.5 36.8-192.6 80.6C48.6 156 17.3 208 2.5 243.7c-3.3 7.9-3.3 16.7.0 24.6C17.3 304 48.6 356 95.4 399.4 142.5 443.2 207.2 480 288 480s145.5-36.8 192.6-80.6c46.8-43.5 78.1-95.4 93-131.1 3.3-7.9 3.3-16.7.0-24.6-14.9-35.7-46.2-87.7-93-131.1C433.5 68.8 368.8 32 288 32zM432 256c0 79.5-64.5 144-144 144s-144-64.5-144-144 64.5-144 144-144 144 64.5 144 144zM288 192c0 35.3-28.7 64-64 64-11.5.0-22.3-3-31.6-8.4-.2 2.8-.4 5.5-.4 8.4.0 53 43 96 96 96s96-43 96-96-43-96-96-96c-2.8.0-5.6.1-8.4.4 5.3 9.3 8.4 20.1 8.4 31.6z"/></svg></span></span></span></div><div class="flex flex-row flex-wrap items-center"></div><div class="flex flex-row flex-wrap items-center"><span style=margin-top:.5rem class=mr-2 onclick='window.open("/categories/service-mesh/","_self")'><span class=flex><span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">服务网格
</span></span></span><span style=margin-top:.5rem class=mr-2 onclick='window.open("/tags/istio/","_self")'><span class=flex><span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">Istio</span></span></span></div></div></div><div class="px-6 pt-4 pb-2"></div></div></a><a href=/posts/control-egress-traffic/ class=min-w-full><div class="min-h-full border border-neutral-200 dark:border-neutral-700 border-2 rounded overflow-hidden shadow-2xl relative backdrop-blur"><div class="w-full thumbnail_card_related nozoom" style=background-image:url(/posts/control-egress-traffic/featured_hu5042f4836d6d33a2a1b18110ad11539a_100071_600x0_resize_q75_box.jpg)></div><div class="px-6 py-4"><div class="font-bold text-xl text-neutral-800 decoration-primary-500 hover:underline hover:underline-offset-2 dark:text-neutral" href=/posts/control-egress-traffic/>控制 Egress 流量</div><div class="text-sm text-neutral-500 dark:text-neutral-400"><div class="flex flex-row flex-wrap items-center"><time datetime="2018-08-16 13:40:27 +0800 +0800">2018年8月16日</time><span class="px-2 text-primary-500">&#183;</span><span>3911 字</span><span class="px-2 text-primary-500">&#183;</span><span title=预计阅读>8 分钟</span><span class="px-2 text-primary-500">&#183;</span><span>
<span id=busuanzi_page_pv></span>
<span class="inline-block align-text-bottom"><span class="relative block icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><path fill="currentcolor" d="M288 32c-80.8.0-145.5 36.8-192.6 80.6C48.6 156 17.3 208 2.5 243.7c-3.3 7.9-3.3 16.7.0 24.6C17.3 304 48.6 356 95.4 399.4 142.5 443.2 207.2 480 288 480s145.5-36.8 192.6-80.6c46.8-43.5 78.1-95.4 93-131.1 3.3-7.9 3.3-16.7.0-24.6-14.9-35.7-46.2-87.7-93-131.1C433.5 68.8 368.8 32 288 32zM432 256c0 79.5-64.5 144-144 144s-144-64.5-144-144 64.5-144 144-144 144 64.5 144 144zM288 192c0 35.3-28.7 64-64 64-11.5.0-22.3-3-31.6-8.4-.2 2.8-.4 5.5-.4 8.4.0 53 43 96 96 96s96-43 96-96-43-96-96-96c-2.8.0-5.6.1-8.4.4 5.3 9.3 8.4 20.1 8.4 31.6z"/></svg></span></span></span></div><div class="flex flex-row flex-wrap items-center"></div><div class="flex flex-row flex-wrap items-center"><span style=margin-top:.5rem class=mr-2 onclick='window.open("/categories/service-mesh/","_self")'><span class=flex><span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">服务网格
</span></span></span><span style=margin-top:.5rem class=mr-2 onclick='window.open("/tags/istio/","_self")'><span class=flex><span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">Istio
</span></span></span><span style=margin-top:.5rem class=mr-2 onclick='window.open("/tags/kubernetes/","_self")'><span class=flex><span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">Kubernetes</span></span></span></div></div></div><div class="px-6 pt-4 pb-2"></div></div></a><a href=/posts/where-is-the-request-2/ class=min-w-full><div class="min-h-full border border-neutral-200 dark:border-neutral-700 border-2 rounded overflow-hidden shadow-2xl relative backdrop-blur"><div class="w-full thumbnail_card_related nozoom" style=background-image:url(/posts/where-is-the-request-2/featured_huc17e0323829cf95f12c7e1ed852626b5_210372_600x0_resize_q75_box.jpg)></div><div class="px-6 py-4"><div class="font-bold text-xl text-neutral-800 decoration-primary-500 hover:underline hover:underline-offset-2 dark:text-neutral" href=/posts/where-is-the-request-2/>数据包在 Istio 网格中的生命周期（下）</div><div class="text-sm text-neutral-500 dark:text-neutral-400"><div class="flex flex-row flex-wrap items-center"><time datetime="2018-08-13 16:30:30 +0800 +0800">2018年8月13日</time><span class="px-2 text-primary-500">&#183;</span><span>2535 字</span><span class="px-2 text-primary-500">&#183;</span><span title=预计阅读>6 分钟</span><span class="px-2 text-primary-500">&#183;</span><span>
<span id=busuanzi_page_pv></span>
<span class="inline-block align-text-bottom"><span class="relative block icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><path fill="currentcolor" d="M288 32c-80.8.0-145.5 36.8-192.6 80.6C48.6 156 17.3 208 2.5 243.7c-3.3 7.9-3.3 16.7.0 24.6C17.3 304 48.6 356 95.4 399.4 142.5 443.2 207.2 480 288 480s145.5-36.8 192.6-80.6c46.8-43.5 78.1-95.4 93-131.1 3.3-7.9 3.3-16.7.0-24.6-14.9-35.7-46.2-87.7-93-131.1C433.5 68.8 368.8 32 288 32zM432 256c0 79.5-64.5 144-144 144s-144-64.5-144-144 64.5-144 144-144 144 64.5 144 144zM288 192c0 35.3-28.7 64-64 64-11.5.0-22.3-3-31.6-8.4-.2 2.8-.4 5.5-.4 8.4.0 53 43 96 96 96s96-43 96-96-43-96-96-96c-2.8.0-5.6.1-8.4.4 5.3 9.3 8.4 20.1 8.4 31.6z"/></svg></span></span></span></div><div class="flex flex-row flex-wrap items-center"></div><div class="flex flex-row flex-wrap items-center"><span style=margin-top:.5rem class=mr-2 onclick='window.open("/categories/service-mesh/","_self")'><span class=flex><span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">服务网格
</span></span></span><span style=margin-top:.5rem class=mr-2 onclick='window.open("/tags/istio/","_self")'><span class=flex><span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">Istio
</span></span></span><span style=margin-top:.5rem class=mr-2 onclick='window.open("/tags/kubernetes/","_self")'><span class=flex><span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">Kubernetes</span></span></span></div></div></div><div class="px-6 pt-4 pb-2"></div></div></a><a href=/posts/where-is-the-request-1/ class=min-w-full><div class="min-h-full border border-neutral-200 dark:border-neutral-700 border-2 rounded overflow-hidden shadow-2xl relative backdrop-blur"><div class="w-full thumbnail_card_related nozoom" style=background-image:url(/posts/where-is-the-request-1/featured_hu0cba631b840dc807ba0b015b43333d53_616175_600x0_resize_q75_box.jpg)></div><div class="px-6 py-4"><div class="font-bold text-xl text-neutral-800 decoration-primary-500 hover:underline hover:underline-offset-2 dark:text-neutral" href=/posts/where-is-the-request-1/>数据包在 Istio 网格中的生命周期（上）</div><div class="text-sm text-neutral-500 dark:text-neutral-400"><div class="flex flex-row flex-wrap items-center"><time datetime="2018-08-08 16:56:31 +0800 +0800">2018年8月8日</time><span class="px-2 text-primary-500">&#183;</span><span>3332 字</span><span class="px-2 text-primary-500">&#183;</span><span title=预计阅读>7 分钟</span><span class="px-2 text-primary-500">&#183;</span><span>
<span id=busuanzi_page_pv></span>
<span class="inline-block align-text-bottom"><span class="relative block icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><path fill="currentcolor" d="M288 32c-80.8.0-145.5 36.8-192.6 80.6C48.6 156 17.3 208 2.5 243.7c-3.3 7.9-3.3 16.7.0 24.6C17.3 304 48.6 356 95.4 399.4 142.5 443.2 207.2 480 288 480s145.5-36.8 192.6-80.6c46.8-43.5 78.1-95.4 93-131.1 3.3-7.9 3.3-16.7.0-24.6-14.9-35.7-46.2-87.7-93-131.1C433.5 68.8 368.8 32 288 32zM432 256c0 79.5-64.5 144-144 144s-144-64.5-144-144 64.5-144 144-144 144 64.5 144 144zM288 192c0 35.3-28.7 64-64 64-11.5.0-22.3-3-31.6-8.4-.2 2.8-.4 5.5-.4 8.4.0 53 43 96 96 96s96-43 96-96-43-96-96-96c-2.8.0-5.6.1-8.4.4 5.3 9.3 8.4 20.1 8.4 31.6z"/></svg></span></span></span></div><div class="flex flex-row flex-wrap items-center"></div><div class="flex flex-row flex-wrap items-center"><span style=margin-top:.5rem class=mr-2 onclick='window.open("/categories/service-mesh/","_self")'><span class=flex><span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">服务网格
</span></span></span><span style=margin-top:.5rem class=mr-2 onclick='window.open("/tags/istio/","_self")'><span class=flex><span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">Istio
</span></span></span><span style=margin-top:.5rem class=mr-2 onclick='window.open("/tags/kubernetes/","_self")'><span class=flex><span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">Kubernetes</span></span></span></div></div></div><div class="px-6 pt-4 pb-2"></div></div></a></section></div><script>var oid="views_posts/istio-traffic-management-impl-intro/index.md",oid_likes="likes_posts/istio-traffic-management-impl-intro/index.md"</script><script type=text/javascript src=/js/page.min.0e49973b4ad0a382c7c6012d8bff8226316642daabc4f8a20477bd08674f3da6e2fa993bc20ad4f51e7c5bb68e6f913a207a7c4fe37ea0e7b806894afce0a64e.js integrity="sha512-DkmXO0rQo4LHxgEti/+CJjFmQtqrxPiiBHe9CGdPPabi+pk7wgrU9R58W7aOb5E6IHp8T+N+oOe4BolK/OCmTg=="></script></section><footer class="pt-8 max-w-prose print:hidden"><div class=pt-8><hr class="border-dotted border-neutral-300 dark:border-neutral-600"><div class="flex justify-between pt-3"><span><a class="flex group mr-3" href=/posts/setting-up-ssl-in-envoy-practice/><span class="mr-3 text-neutral-700 group-hover:text-primary-600 ltr:inline rtl:hidden dark:text-neutral dark:group-hover:text-primary-400">&larr;</span>
<span class="ml-3 text-neutral-700 group-hover:text-primary-600 ltr:hidden rtl:inline dark:text-neutral dark:group-hover:text-primary-400">&rarr;</span>
<span class="flex flex-col"><span class="mt-[0.1rem] leading-6 group-hover:underline group-hover:decoration-primary-500">Envoy 基础教程：开启 TLS 验证实战</span>
<span class="mt-[0.1rem] text-xs text-neutral-500 dark:text-neutral-400"><time datetime="2018-09-26 17:43:00 +0800 +0800">2018年9月26日</time>
</span></span></a></span><span><a class="flex text-right group ml-3" href=/posts/envoy-xds-protocol/><span class="flex flex-col"><span class="mt-[0.1rem] leading-6 group-hover:underline group-hover:decoration-primary-500">Envoy 基础教程：xDS REST 和 gRPC 协议详解</span>
<span class="mt-[0.1rem] text-xs text-neutral-500 dark:text-neutral-400"><time datetime="2018-10-10 22:23:51 +0800 +0800">2018年10月10日</time>
</span></span><span class="ml-3 text-neutral-700 group-hover:text-primary-600 ltr:inline rtl:hidden dark:text-neutral dark:group-hover:text-primary-400">&rarr;</span>
<span class="mr-3 text-neutral-700 group-hover:text-primary-600 ltr:hidden rtl:inline dark:text-neutral dark:group-hover:text-primary-400">&larr;</span></a></span></div></div><div class=pt-3><hr class="border-dotted border-neutral-300 dark:border-neutral-600"><div class=pt-3><img src=/img/wechat-qr.webp alt=公众号二维码>
<link rel=stylesheet href=https://icloudnative.io/css/iDisqus.min.css><div id=comment></div><script src=https://icloudnative.io/js/iDisqus.min.js></script><script>document.addEventListener("DOMContentLoaded",function(){var e=new IntersectionObserver(function(t){if(t[0].isIntersecting){var n=new iDisqus("comment",{forum:"fuckcloudnative",api:"https://disqus.icloudnative.io",site:"https://icloudnative.io",emojiPath:"https://jsdelivr.icloudnative.io/gh/yangchuansheng/imghosting@master/emoji/",mode:2,timeout:15,init:!0});e.disconnect()}},{threshold:[.1]});e.observe(document.getElementById("comment"))})</script></div></div></footer></article><div id=top-scroller class="pointer-events-none absolute top-[110vh] bottom-0 w-12 ltr:right-0 rtl:left-0"><a href=#the-top class="pointer-events-auto sticky top-[calc(100vh-5.5rem)] flex h-12 w-12 mb-16 items-center justify-center rounded-full bg-neutral/50 text-xl text-neutral-700 backdrop-blur hover:text-primary-600 dark:bg-neutral-800/50 dark:text-neutral dark:hover:text-primary-400" aria-label title>&uarr;</a></div></main><footer id=site-footer class="py-10 print:hidden" style=margin-inline:auto;text-align:center><nav class="flex flex-row pb-4 text-base font-medium text-neutral-500 dark:text-neutral-400"><ul class="flex flex-col list-none sm:flex-row"><li class="flex mb-1 ltr:text-right rtl:text-left sm:mb-0 ltr:sm:mr-7 ltr:sm:last:mr-0 rtl:sm:ml-7 rtl:sm:last:ml-0"><a class="decoration-primary-500 hover:underline hover:decoration-2 hover:underline-offset-2" href=/tags/ title=标签>标签</a></li><li class="flex mb-1 ltr:text-right rtl:text-left sm:mb-0 ltr:sm:mr-7 ltr:sm:last:mr-0 rtl:sm:ml-7 rtl:sm:last:ml-0"><a class="decoration-primary-500 hover:underline hover:decoration-2 hover:underline-offset-2" href=/categories/ title=分类>分类</a></li></ul></nav><div class="items-center justify-between"></div><script>mediumZoom(document.querySelectorAll("img:not(.nozoom)"),{margin:24,background:"rgba(0,0,0,0.5)",scrollOffset:0})</script><script type=text/javascript src=/js/process.min.35c1113bcc16c5a59bf031082f9e63822aa95280423881a7847a7ff33a16e6299ce6a840d9ef4e10d947e030a18f3f20359afb2ec0f35967484b9a9360ac3145.js integrity="sha512-NcERO8wWxaWb8DEIL55jgiqpUoBCOIGnhHp/8zoW5imc5qhA2e9OENlH4DChjz8gNZr7LsDzWWdIS5qTYKwxRQ=="></script><div class=busuanzi style=margin-inline:auto;text-align:center><div class=busuanzi__item><span class="busuanzi__item--label text-neutral-500 dark:text-neutral-400">总访客</span>
<span id=busuanzi_site_uv class="busuanzi__item--number text-neutral-500 dark:text-neutral-400"></span></div><div class=busuanzi__item><span class="busuanzi__item--label text-neutral-500 dark:text-neutral-400">总浏览量</span>
<span id=busuanzi_site_pv class="busuanzi__item--number text-neutral-500 dark:text-neutral-400"></span></div></div><p class="text-sm text-neutral-500 dark:text-neutral-400" style=margin-inline:auto;text-align:center>&copy; 2023 米开朗基杨<br>本站内容依据
<a href=https://creativecommons.org/licenses/by-nc-nd/4.0/deed.zh target=_blank>CC BY-SA 4.0</a>
许可证进行授权，转载请附上出处链接。</p><div class=github-badge><span class=badge-subject>构建工具</span><span class="badge-value bg-blue"><a style=color:#fff href=https://gohugo.io/ target=_blank>Hugo v0.120.4</a></span>
<span class=badge-subject>托管于</span><span class="badge-value bg-brightgreen"><a style=color:#fff href=https://sealos.run target=_blank>Sealos</a></span>
<span class=badge-subject>CDN</span><span class="badge-value bg-blueviolet"><a style=color:#fff href=https://vercel.com target=_blank>Vercel</a></span>
<span class=badge-subject>图床</span><span class="badge-value bg-orange"><a style=color:#fff href=https://www.jsdelivr.com/ target=_blank>jsDelivr</a></span>
<span class=badge-subject>主题</span><span class="badge-value bg-blue"><a style=color:#fff href=https://github.com/nunocoracao/blowfish target=_blank>Blowfish</a></span></div><section class="text-sm text-neutral-500 dark:text-neutral-400"><span id=span_dt_dt></span><script language=javascript>function show_date_time(){window.setTimeout("show_date_time()",1e3),BirthDay=new Date("10/8/2019 10:56:12"),today=new Date,timeold=today.getTime()-BirthDay.getTime(),sectimeold=timeold/1e3,secondsold=Math.floor(sectimeold),msPerDay=24*60*60*1e3,e_daysold=timeold/msPerDay,daysold=Math.floor(e_daysold),e_hrsold=(e_daysold-daysold)*24,hrsold=Math.floor(e_hrsold),e_minsold=(e_hrsold-hrsold)*60,minsold=Math.floor((e_hrsold-hrsold)*60),seconds=Math.floor((e_minsold-minsold)*60),span_dt_dt.innerHTML="本站已经开心运行 "+daysold+" 天 "+hrsold+" 小时 "+minsold+" 分 "+seconds+" 秒"}show_date_time()</script></section><style>.wxtip{background:rgba(0,0,0,.8);text-align:center;position:fixed;left:0;top:0;width:100%;height:100%;z-index:998;display:none}.wxtip-icon{width:52px;height:67px;background:url(img/weixin-tip.png)no-repeat;display:block;position:absolute;right:20px;top:20px}.wxtip-txt{margin-top:107px;color:#fff;font-size:16px;line-height:1.5}</style><div class=wxtip id=JweixinTip><span class=wxtip-icon></span><p class=wxtip-txt>点击屏幕右上角的 ···<br>在弹出的窗口中选择 <span style=color:red>在浏览器中打开</span></p><br><br><p><img style=width:85%;border-radius:10px;display:block;margin-left:auto;margin-right:auto src=/img/wechat-browser.jpg></p></div><script>is_weixn_qq()&&(document.getElementById("JweixinTip").style.display="block",document.getElementById("container").style.display="none",document.getElementById("top-grrk").style.display="none");function is_weixn_qq(){var e=navigator.userAgent,t=!!/MicroMessenger/i.test(e),n=!!/QQ\//i.test(e);return!!(t||n)}</script><div id=fixed-box><div class=feedback-btn-wrapper><a data-umami-event=FastGPT href=https://github.com/labring/FastGPT style=text-decoration:none target=_blank><button id=feedback-btn title=FastGPT>
<svg xmlns="http://www.w3.org/2000/svg" height="1em" viewBox="0 0 640 512" fill="currentcolor"><path d="M320 0c17.7.0 32 14.3 32 32V96H472c39.8.0 72 32.2 72 72V440c0 39.8-32.2 72-72 72H168c-39.8.0-72-32.2-72-72V168c0-39.8 32.2-72 72-72H288V32c0-17.7 14.3-32 32-32zM208 384c-8.8.0-16 7.2-16 16s7.2 16 16 16h32c8.8.0 16-7.2 16-16s-7.2-16-16-16H208zm96 0c-8.8.0-16 7.2-16 16s7.2 16 16 16h32c8.8.0 16-7.2 16-16s-7.2-16-16-16H304zm96 0c-8.8.0-16 7.2-16 16s7.2 16 16 16h32c8.8.0 16-7.2 16-16s-7.2-16-16-16H4e2zM264 256a40 40 0 10-80 0 40 40 0 1080 0zm152 40a40 40 0 100-80 40 40 0 100 80zM48 224H64V416H48c-26.5.0-48-21.5-48-48V272c0-26.5 21.5-48 48-48zm544 0c26.5.0 48 21.5 48 48v96c0 26.5-21.5 48-48 48H576V224h16z"/></svg><span _msttexthash=6039839 _msthash=295>AI 客服</span></button></a></div></div><script type=text/javascript>document.addEventListener("DOMContentLoaded",e=>{var n=["Docker","Kubernetes","Prometheus","Sealos","FastGPT","Envoy","eBPF","Laf","Webassembly","WireGuard","Tailscale","Cloud Native"],t=0;document.body.addEventListener("click",function(e){var s,o,i,a,r,l=n[t];t=(t+1)%n.length,s=document.createElement("span"),s.textContent=l,s.style.cssText=`
            z-index: 9999;
            top: ${e.pageY-20}px;
            left: ${e.pageX}px;
            position: absolute;
            font-weight: bold;
            color: ${randomColor()};
            opacity: 1;
            transition: opacity 1.5s;
        `,document.body.appendChild(s),o=null,a=1500,i=e.pageY-20,r=i-160;function c(e){o===null&&(o=e);var t=(e-o)/a;t<1?(s.style.top=i-t*(i-r)+"px",requestAnimationFrame(c)):s.remove()}requestAnimationFrame(c)})});function randomColor(){var e=["#FFDA65","#00BFFF","#cb80ff","#acc2ef","#87CEEB","#FFB6C1"];return e[Math.floor(Math.random()*e.length)]}</script></footer><div id=search-wrapper class="invisible fixed inset-0 flex h-screen w-screen cursor-default flex-col bg-neutral-500/50 p-4 backdrop-blur-sm dark:bg-neutral-900/50 sm:p-6 md:p-[10vh] lg:p-[12vh]" data-url=https://icloudnative.io style=z-index:500><div id=search-modal class="flex flex-col w-full max-w-3xl min-h-0 mx-auto border rounded-md shadow-lg top-20 border-neutral-200 bg-neutral dark:border-neutral-700 dark:bg-neutral-800"><header class="relative z-10 flex items-center justify-between flex-none px-2"><form class="flex items-center flex-auto min-w-0"><div class="flex items-center justify-center w-8 h-8 text-neutral-400"><span class="relative block icon"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M505 442.7 405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9.0 208 0S0 93.1.0 208s93.1 208 208 208c48.3.0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9.0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7.0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7.0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg></span></div><input type=search id=search-query class="flex flex-auto h-12 mx-1 bg-transparent appearance-none focus:outline-dotted focus:outline-2 focus:outline-transparent" placeholder tabindex=0></form><button id=close-search-button class="flex items-center justify-center w-8 h-8 text-neutral-700 hover:text-primary-600 dark:text-neutral dark:hover:text-primary-400" title>
<span class="relative block icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><path fill="currentcolor" d="M310.6 361.4c12.5 12.5 12.5 32.75.0 45.25C304.4 412.9 296.2 416 288 416s-16.38-3.125-22.62-9.375L160 301.3 54.63 406.6C48.38 412.9 40.19 416 32 416S15.63 412.9 9.375 406.6c-12.5-12.5-12.5-32.75.0-45.25l105.4-105.4L9.375 150.6c-12.5-12.5-12.5-32.75.0-45.25s32.75-12.5 45.25.0L160 210.8l105.4-105.4c12.5-12.5 32.75-12.5 45.25.0s12.5 32.75.0 45.25l-105.4 105.4L310.6 361.4z"/></svg></span></button></header><section class="flex-auto px-2 overflow-auto"><ul id=search-results></ul></section></div></div></div></body></html>