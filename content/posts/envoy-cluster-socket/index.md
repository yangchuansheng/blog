---
keywords:
- ç±³å¼€æœ—åŸºæ¨
- envoy
- uds
- nginx
title: "Envoy åŸºç¡€æ•™ç¨‹ï¼šä½¿ç”¨ Unix Domain Socketï¼ˆUDSï¼‰ ä¸ä¸Šæ¸¸é›†ç¾¤é€šä¿¡"
date: 2020-04-23T00:41:26+08:00
lastmod: 2020-04-23T00:41:26+08:00
description: æœ¬æ–‡ä¸»è¦ä»‹ç»äº† Envoy Proxy å¦‚ä½•ä½¿ç”¨ UDSï¼ˆUnix Domain Socketï¼‰ä¸ä¸Šæ¸¸é›†ç¾¤é€šä¿¡ã€‚
draft: false
author: ç±³å¼€æœ—åŸºæ¨
hideToc: false
enableToc: true
enableTocContent: false
tocLevels: ["h2", "h3", "h4"]
tags:
- Envoy
categories: service-mesh
img: https://jsd.onmicrosoft.cn/gh/yangchuansheng/imghosting@master/img/20200426205419.png
---

Envoy Proxy åœ¨å¤§å¤šæ•°æƒ…å†µä¸‹éƒ½æ˜¯ä½œä¸º `Sidecar` ä¸åº”ç”¨éƒ¨ç½²åœ¨åŒä¸€ç½‘ç»œç¯å¢ƒä¸­ï¼Œæ¯ä¸ªåº”ç”¨åªéœ€è¦ä¸ Envoyï¼ˆ`localhost`ï¼‰äº¤äº’ï¼Œä¸éœ€è¦çŸ¥é“å…¶ä»–æœåŠ¡çš„åœ°å€ã€‚ç„¶è€Œè¿™å¹¶ä¸æ˜¯ Envoy ä»…æœ‰çš„ä½¿ç”¨åœºæ™¯ï¼Œå®ƒæœ¬èº«å°±æ˜¯ä¸€ä¸ªä¸ƒå±‚ä»£ç†ï¼Œé€šè¿‡æ¨¡å—åŒ–ç»“æ„å®ç°äº†æµé‡æ²»ç†ã€ä¿¡æ¯ç›‘æ§ç­‰æ ¸å¿ƒåŠŸèƒ½ï¼Œæ¯”å¦‚æµé‡æ²»ç†åŠŸèƒ½å°±åŒ…æ‹¬è‡ªåŠ¨é‡è¿ã€ç†”æ–­ã€å…¨å±€é™é€Ÿã€æµé‡é•œåƒå’Œå¼‚å¸¸æ£€æµ‹ç­‰å¤šç§é«˜çº§åŠŸèƒ½ï¼Œå› æ­¤ Envoy ä¹Ÿå¸¸å¸¸è¢«ç”¨äº**è¾¹ç¼˜ä»£ç†**ï¼Œæ¯”å¦‚ Istio çš„ `Ingress Gateway`ã€åŸºäº Envoy å®ç°çš„ Ingress Controllerï¼ˆ[Contour](/posts/use-envoy-as-a-kubernetes-ingress/)ã€[Ambassador](https://www.getambassador.io)ã€[Gloo](https://github.com/solo-io/gloo) ç­‰ï¼‰ã€‚

æˆ‘çš„åšå®¢ä¹Ÿæ˜¯éƒ¨ç½²åœ¨è½»é‡çº§ `Kubernetes` é›†ç¾¤ä¸Šçš„ï¼ˆå…¶å®æ˜¯ `k3s` å•¦ï¼‰ï¼Œä¸€å¼€å§‹ä½¿ç”¨ `Contour` ä½œä¸º `Ingress Controller`ï¼Œæš´éœ²é›†ç¾¤å†…çš„åšå®¢ã€è¯„è®ºç­‰æœåŠ¡ã€‚ä½†å¥½æ™¯ä¸é•¿ï¼Œç”±äºæˆ‘åœ¨é›†ç¾¤å†…éƒ¨ç½²äº†å„ç§å¥‡å¥‡æ€ªæ€ªçš„ä¸œè¥¿ï¼Œæœ‰äº›ä¸ªæ€§åŒ–é…ç½® `Contour` æ— æ³•æ»¡è¶³æˆ‘çš„éœ€æ±‚ï¼Œæ¯•ç«Ÿå¤§å®¶éƒ½çŸ¥é“ï¼Œ**æ¯æŠ½è±¡ä¸€å±‚å°±ä¼šä¸¢å¤±å¾ˆå¤šç»†èŠ‚**ã€‚æ¢ä¸€ä¸ª Controller ä¿ä¸é½ä»¥åè¿˜ä¼šé‡åˆ°è¿™ç§é—®é¢˜ï¼Œç´¢æ€§å°±ç›´æ¥è£¸ç”¨ `Envoy` ä½œä¸ºè¾¹ç¼˜ä»£ç†ï¼Œå¤§ä¸äº†æ‰‹æ’¸ `YAML` å‘—ã€‚

å½“ç„¶ä¹Ÿä¸å…¨æ˜¯æ‰‹æ’¸ï¼Œè™½ç„¶æ²¡æœ‰æ‰€è°“çš„**æ§åˆ¶å¹³é¢**ï¼Œä½†ä»ªå¼æ„Ÿè¿˜æ˜¯è¦æœ‰çš„ï¼Œæˆ‘å¯ä»¥åŸºäºæ–‡ä»¶æ¥åŠ¨æ€æ›´æ–°é…ç½®å•Šï¼Œå…·ä½“çš„æ–¹æ³•å‚è€ƒ [Envoy åŸºç¡€æ•™ç¨‹ï¼šåŸºäºæ–‡ä»¶ç³»ç»ŸåŠ¨æ€æ›´æ–°é…ç½®](/posts/file-based-dynamic-routing-configuration/)ã€‚

## 1. UDS ä»‹ç»

----

è¯´äº†é‚£ä¹ˆå¤šåºŸè¯ï¼Œä¸‹é¢è¿›å…¥æ­£é¢˜ã€‚ä¸ºäº†æé«˜åšå®¢çš„æ€§èƒ½ï¼Œæˆ‘é€‰æ‹©å°†åšå®¢ä¸ `Envoy` éƒ¨ç½²åœ¨åŒä¸€ä¸ªèŠ‚ç‚¹ä¸Šï¼Œå¹¶ä¸”å…¨éƒ¨ä½¿ç”¨ `HostNetwork` æ¨¡å¼ï¼Œ`Envoy` é€šè¿‡ localhost ä¸åšå®¢æ‰€åœ¨çš„ Podï¼ˆ`Nginx`ï¼‰ é€šä¿¡ã€‚ä¸ºäº†è¿›ä¸€æ­¥æé«˜æ€§èƒ½ï¼Œæˆ‘ç›¯ä¸Šäº† [Unix Domain Socketï¼ˆUDSï¼ŒUnixåŸŸå¥—æ¥å­—ï¼‰](https://en.wikipedia.org/wiki/Unix_domain_socket)ï¼Œå®ƒè¿˜æœ‰å¦ä¸€ä¸ªåå­—å« `IPC`ï¼ˆinter-process communicationï¼Œè¿›ç¨‹é—´é€šä¿¡ï¼‰ã€‚ä¸ºäº†ç†è§£ `UDS`ï¼Œæˆ‘ä»¬å…ˆæ¥å»ºç«‹ä¸€ä¸ªç®€å•çš„æ¨¡å‹ã€‚

ç°å®ä¸–ç•Œä¸­ä¸¤ä¸ªäººè¿›è¡Œä¿¡æ¯äº¤æµçš„æ•´ä¸ªè¿‡ç¨‹è¢«ç§°ä½œä¸€æ¬¡é€šä¿¡ï¼ˆ`Communication`ï¼‰ï¼Œé€šä¿¡çš„åŒæ–¹è¢«ç§°ä¸ºç«¯ç‚¹ï¼ˆ`Endpoint`ï¼‰ã€‚å·¥å…·é€šè®¯ç¯å¢ƒçš„ä¸åŒï¼Œç«¯ç‚¹ä¹‹é—´å¯ä»¥é€‰æ‹©ä¸åŒçš„å·¥å…·è¿›è¡Œé€šä¿¡ï¼Œè·ç¦»è¿‘å¯ä»¥ç›´æ¥å¯¹è¯ï¼Œè·ç¦»è¿œå¯ä»¥é€‰æ‹©æ‰“ç”µè¯ã€å¾®ä¿¡èŠå¤©ã€‚è¿™äº›å·¥å…·å°±è¢«ç§°ä¸º `Socket`ã€‚

![](https://jsd.onmicrosoft.cn/gh/yangchuansheng/imghosting@master/img/20200426213301.png)

åŒç†ï¼Œåœ¨è®¡ç®—æœºä¸­ä¹Ÿæœ‰ç±»ä¼¼çš„æ¦‚å¿µï¼š

+ åœ¨ `Unix` ä¸­ï¼Œä¸€æ¬¡é€šä¿¡ç”±ä¸¤ä¸ªç«¯ç‚¹ç»„æˆï¼Œä¾‹å¦‚ `HTTP` æœåŠ¡ç«¯å’Œ `HTTP` å®¢æˆ·ç«¯ã€‚
+ ç«¯ç‚¹ä¹‹é—´æƒ³è¦é€šä¿¡ï¼Œå¿…é¡»å€ŸåŠ©æŸäº›å·¥å…·ï¼ŒUnix ä¸­ç«¯ç‚¹ä¹‹é—´ä½¿ç”¨ `Socket` æ¥è¿›è¡Œé€šä¿¡ã€‚

`Socket` åŸæœ¬æ˜¯ä¸ºç½‘ç»œé€šä¿¡è€Œè®¾è®¡çš„ï¼Œä½†åæ¥åœ¨ `Socket` çš„æ¡†æ¶ä¸Šå‘å±•å‡ºä¸€ç§ `IPC` æœºåˆ¶ï¼Œå°±æ˜¯ `UDS`ã€‚ä½¿ç”¨ UDS çš„å¥½å¤„æ˜¾è€Œæ˜“è§ï¼šä¸éœ€è¦ç»è¿‡ç½‘ç»œåè®®æ ˆï¼Œä¸éœ€è¦æ‰“åŒ…æ‹†åŒ…ã€è®¡ç®—æ ¡éªŒå’Œã€ç»´æŠ¤åºå·å’Œåº”ç­”ç­‰ï¼Œåªæ˜¯å°†åº”ç”¨å±‚æ•°æ®ä»ä¸€ä¸ªè¿›ç¨‹æ‹·è´åˆ°å¦ä¸€ä¸ªè¿›ç¨‹ã€‚è¿™æ˜¯å› ä¸ºï¼Œ**IPC æœºåˆ¶æœ¬è´¨ä¸Šæ˜¯å¯é çš„é€šè®¯ï¼Œè€Œç½‘ç»œåè®®æ˜¯ä¸ºä¸å¯é çš„é€šè®¯è®¾è®¡çš„**ã€‚

`UDS` ä¸ç½‘ç»œ Socket æœ€æ˜æ˜¾çš„åŒºåˆ«åœ¨äºï¼Œ**ç½‘ç»œ Socket** åœ°å€æ˜¯ IP åœ°å€åŠ ç«¯å£å·ï¼Œè€Œ `UDS` çš„åœ°å€æ˜¯ä¸€ä¸ª Socket ç±»å‹çš„æ–‡ä»¶åœ¨æ–‡ä»¶ç³»ç»Ÿä¸­çš„è·¯å¾„ï¼Œä¸€èˆ¬åå­—ä»¥ `.sock` ç»“å°¾ã€‚è¿™ä¸ª Socket æ–‡ä»¶å¯ä»¥è¢«ç³»ç»Ÿè¿›ç¨‹å¼•ç”¨ï¼Œä¸¤ä¸ªè¿›ç¨‹å¯ä»¥åŒæ—¶æ‰“å¼€ä¸€ä¸ª `UDS` è¿›è¡Œé€šä¿¡ï¼Œè€Œä¸”è¿™ç§é€šä¿¡æ–¹å¼åªä¼šå‘ç”Ÿåœ¨ç³»ç»Ÿå†…æ ¸é‡Œï¼Œä¸ä¼šåœ¨ç½‘ç»œä¸Šè¿›è¡Œä¼ æ’­ã€‚ä¸‹é¢å°±æ¥çœ‹çœ‹å¦‚ä½•è®© `Envoy` é€šè¿‡ `UDS` ä¸ä¸Šæ¸¸é›†ç¾¤ `Nginx` è¿›è¡Œé€šä¿¡å§ï¼Œå®ƒä»¬ä¹‹é—´çš„é€šä¿¡æ¨¡å‹å¤§æ¦‚å°±æ˜¯è¿™ä¸ªæ ·å­ï¼š

![](https://jsd.onmicrosoft.cn/gh/yangchuansheng/imghosting@master/img/20200427143709.png)

## 2. Nginx ç›‘å¬ UDS

----

é¦–å…ˆéœ€è¦ä¿®æ”¹ `Nginx` çš„é…ç½®ï¼Œè®©å…¶ç›‘å¬åœ¨ `UDS` ä¸Šï¼Œè‡³äº `Socket` æè¿°ç¬¦æ–‡ä»¶çš„å­˜å‚¨ä½ç½®ï¼Œå°±éšä½ çš„æ„äº†ã€‚å…·ä½“éœ€è¦ä¿®æ”¹ `listen` å‚æ•°ä¸ºä¸‹é¢çš„å½¢å¼ï¼š

```nginx
listen      unix:/sock/hugo.sock;
```

å½“ç„¶ï¼Œå¦‚æœæƒ³è·å¾—æ›´å¿«çš„é€šä¿¡é€Ÿåº¦ï¼Œå¯ä»¥æ”¾åœ¨ `/dev/shm` ç›®å½•ä¸‹ï¼Œè¿™ä¸ªç›®å½•æ˜¯æ‰€è°“çš„ `tmpfs`ï¼Œå®ƒæ˜¯ `RAM` å¯ä»¥ç›´æ¥ä½¿ç”¨çš„åŒºåŸŸï¼Œæ‰€ä»¥è¯»å†™é€Ÿåº¦éƒ½ä¼šå¾ˆå¿«ï¼Œä¸‹æ–‡ä¼šå•ç‹¬è¯´æ˜ã€‚

## 3. Envoy-->UDS-->Nginx

----

`Envoy` é»˜è®¤æƒ…å†µä¸‹æ˜¯ä½¿ç”¨ IP åœ°å€å’Œç«¯å£å·å’Œä¸Šæ¸¸é›†ç¾¤é€šä¿¡çš„ï¼Œå¦‚æœæƒ³ä½¿ç”¨ `UDS` ä¸ä¸Šæ¸¸é›†ç¾¤é€šä¿¡ï¼Œé¦–å…ˆéœ€è¦ä¿®æ”¹æœåŠ¡å‘ç°çš„ç±»å‹ï¼Œå°† `type` ä¿®æ”¹ä¸º `static`ï¼š

```yaml
type: static
```

åŒæ—¶è¿˜éœ€å°†ç«¯ç‚¹å®šä¹‰ä¸º UDSï¼š

```yaml
- endpoint:
    address:
      pipe:
        path: "/sock/hugo.sock"
```

æœ€ç»ˆçš„ Cluster é…ç½®å¦‚ä¸‹ï¼š

```yaml
- "@type": type.googleapis.com/envoy.api.v2.Cluster
  name: hugo
  connect_timeout: 15s
  type: static
  load_assignment:
    cluster_name: hugo
    endpoints:
    - lb_endpoints:
      - endpoint:
          address:
            pipe:
              path: "/sock/hugo.sock"
```

æœ€åè¦è®© `Envoy` èƒ½å¤Ÿè®¿é—® `Nginx` çš„ `Socket` æ–‡ä»¶ï¼ŒKubernetes ä¸­å¯ä»¥å°†åŒä¸€ä¸ª `emptyDir` æŒ‚è½½åˆ°ä¸¤ä¸ª Container ä¸­æ¥è¾¾åˆ°å…±äº«çš„ç›®çš„ï¼Œ**å½“ç„¶æœ€å¤§çš„å‰ææ˜¯ Pod ä¸­çš„ Container æ˜¯å…±äº« IPC çš„**ã€‚é…ç½®å¦‚ä¸‹ï¼š

```yaml
spec:
  ...
  template:
    ...
    spec:
      containers:
      - name: envoy
        ...
        volumeMounts:
        - mountPath: /sock
          name: hugo-socket
          ...
      - name: hugo
        ...
        volumeMounts:
        - mountPath: /sock
          name: hugo-socket
          ...
      volumes:
      ...
      - name: hugo-socket
        emptyDir: {}
```

ç°åœ¨ä½ åˆå¯ä»¥æ„‰å¿«åœ°è®¿é—®æˆ‘çš„[åšå®¢](https://icloudnative.io)äº†ï¼ŒæŸ¥çœ‹ `Envoy` çš„æ—¥å¿—ï¼ŒæˆåŠŸå°†è¯·æ±‚é€šè¿‡ `Socket` è½¬å‘ç»™äº†ä¸Šæ¸¸é›†ç¾¤ï¼š

```bash
[2020-04-27T02:49:47.943Z] "GET /posts/prometheus-histograms/ HTTP/1.1" 200 - 0 169949 1 0 "66.249.64.209,45.145.38.4" "Mozilla/5.0 (Linux; Android 6.0.1; Nexus 5X Build/MMB29P) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/41.0.2272.96 Mobile Safari/537.36 (compatible; Googlebot/2.1; +http://www.google.com/bot.html)" "9d490b2d-7c18-4dc7-b815-97f11bfc04d5" "icloudnative.io" "/dev/shm/hugo.sock"
```

å˜¿å˜¿ï¼Œ`Google` çš„çˆ¬è™«ä¹Ÿæ¥å‡‘çƒ­é—¹ã€‚

ä½ å¯èƒ½ä¼šé—®æˆ‘ï¼šä½ è¿™é‡Œçš„ Socket ä¸ºä»€ä¹ˆåœ¨ `/dev/shm/` ç›®å½•ä¸‹å•Šï¼Ÿåˆ«æ€¥ï¼Œè¿˜æ²¡ç»“æŸå‘¢ï¼Œå…ˆæ¥è¡¥å……ä¸€ä¸ªèƒŒæ™¯çŸ¥è¯†ã€‚

## 4. Linux å…±äº«å†…å­˜æœºåˆ¶

----

å…±äº«å†…å­˜ï¼ˆshared memoryï¼‰ï¼Œæ˜¯ `Linux` ä¸Šä¸€ç§ç”¨äºè¿›ç¨‹é—´é€šä¿¡ï¼ˆIPCï¼‰çš„æœºåˆ¶ã€‚

è¿›ç¨‹é—´é€šä¿¡å¯ä»¥ä½¿ç”¨ç®¡é“ï¼ŒSocketï¼Œä¿¡å·ï¼Œä¿¡å·é‡ï¼Œæ¶ˆæ¯é˜Ÿåˆ—ç­‰æ–¹å¼ï¼Œä½†è¿™äº›æ–¹å¼é€šå¸¸éœ€è¦åœ¨ç”¨æˆ·æ€ã€å†…æ ¸æ€ä¹‹é—´æ‹·è´ï¼Œä¸€èˆ¬è®¤ä¸ºä¼šæœ‰ 4 æ¬¡æ‹·è´ï¼›ç›¸æ¯”ä¹‹ä¸‹ï¼Œå…±äº«å†…å­˜å°†å†…å­˜ç›´æ¥æ˜ å°„åˆ°ç”¨æˆ·æ€ç©ºé—´ï¼Œå³å¤šä¸ªè¿›ç¨‹è®¿é—®åŒä¸€å—å†…å­˜ï¼Œç†è®ºä¸Šæ€§èƒ½æ›´é«˜ã€‚å˜¿å˜¿ï¼Œåˆå¯ä»¥æ”¹è¿›ä¸Šé¢çš„æ–¹æ¡ˆäº†ã€‚

å…±äº«å†…å­˜æœ‰ä¸¤ç§æœºåˆ¶ï¼š

+ `POSIX` å…±äº«å†…å­˜ï¼ˆ`shm_open()ã€shm_unlink()`ï¼‰
+ `System V` å…±äº«å†…å­˜ï¼ˆ`shmget()ã€shmat()ã€shmdt()`ï¼‰

å…¶ä¸­ï¼Œ`System V` å…±äº«å†…å­˜å†å²æ‚ ä¹…ï¼Œä¸€èˆ¬çš„ `UNIX` ç³»ç»Ÿä¸Šéƒ½æœ‰è¿™å¥—æœºåˆ¶ï¼›è€Œ `POSIX` å…±äº«å†…å­˜æœºåˆ¶æ¥å£æ›´åŠ æ–¹ä¾¿æ˜“ç”¨ï¼Œä¸€èˆ¬æ˜¯ç»“åˆå†…å­˜æ˜ å°„ `mmap` ä½¿ç”¨ã€‚

`mmap` å’Œ `System V` å…±äº«å†…å­˜çš„ä¸»è¦åŒºåˆ«åœ¨äºï¼š

+ System V shm æ˜¯æŒä¹…åŒ–çš„ï¼Œé™¤éè¢«ä¸€ä¸ªè¿›ç¨‹æ˜ç¡®çš„åˆ é™¤ï¼Œå¦åˆ™å®ƒå§‹ç»ˆå­˜åœ¨äºå†…å­˜é‡Œï¼Œç›´åˆ°ç³»ç»Ÿå…³æœºã€‚
+ `mmap` æ˜ å°„çš„å†…å­˜ä¸æ˜¯æŒä¹…åŒ–çš„ï¼Œå¦‚æœè¿›ç¨‹å…³é—­ï¼Œæ˜ å°„éšå³å¤±æ•ˆï¼Œé™¤éäº‹å…ˆå·²ç»æ˜ å°„åˆ°äº†ä¸€ä¸ªæ–‡ä»¶ä¸Šã€‚
+ `/dev/shm` æ˜¯ Linux ä¸‹ sysv å…±äº«å†…å­˜çš„é»˜è®¤æŒ‚è½½ç‚¹ã€‚

`POSIX` å…±äº«å†…å­˜æ˜¯åŸºäº `tmpfs` æ¥å®ç°çš„ã€‚å®é™…ä¸Šï¼Œæ›´è¿›ä¸€æ­¥ï¼Œä¸ä»… `PSM`(POSIX shared memory)ï¼Œè€Œä¸” `SSM`(System V shared memory) åœ¨å†…æ ¸ä¹Ÿæ˜¯åŸºäº `tmpfs` å®ç°çš„ã€‚

ä»è¿™é‡Œå¯ä»¥çœ‹åˆ° `tmpfs` ä¸»è¦æœ‰ä¸¤ä¸ªä½œç”¨ï¼š

- ç”¨äº `System V` å…±äº«å†…å­˜ï¼Œè¿˜æœ‰åŒ¿åå†…å­˜æ˜ å°„ï¼›è¿™éƒ¨åˆ†ç”±å†…æ ¸ç®¡ç†ï¼Œç”¨æˆ·ä¸å¯è§ã€‚
- ç”¨äº `POSIX` å…±äº«å†…å­˜ï¼Œç”±ç”¨æˆ·è´Ÿè´£ `mount`ï¼Œè€Œä¸”ä¸€èˆ¬ mount åˆ° `/dev/shm`ï¼Œä¾èµ–äº `CONFIG_TMPFS`ã€‚

è™½ç„¶ System V ä¸ POSIX å…±äº«å†…å­˜éƒ½æ˜¯é€šè¿‡ tmpfs å®ç°ï¼Œä½†æ˜¯å—çš„é™åˆ¶å´ä¸ç›¸åŒã€‚ä¹Ÿå°±æ˜¯è¯´ **/proc/sys/kernel/shmmax åªä¼šå½±å“ System V å…±äº«å†…å­˜ï¼Œ/dev/shm åªä¼šå½±å“ POSIX å…±äº«å†…å­˜**ã€‚å®é™…ä¸Šï¼Œ`System V` ä¸ `POSIX` å…±äº«å†…å­˜æœ¬æ¥å°±æ˜¯ä½¿ç”¨çš„ä¸¤ä¸ªä¸åŒçš„ `tmpfs` å®ä¾‹ã€‚

`System V` å…±äº«å†…å­˜èƒ½å¤Ÿä½¿ç”¨çš„å†…å­˜ç©ºé—´åªå— `/proc/sys/kernel/shmmax` é™åˆ¶ï¼›è€Œç”¨æˆ·é€šè¿‡æŒ‚è½½çš„ `/dev/shm`ï¼Œé»˜è®¤ä¸ºç‰©ç†å†…å­˜çš„ `1/2`ã€‚

![](https://jsd.onmicrosoft.cn/gh/yangchuansheng/imghosting@master/img/20200427124844.png)

æ¦‚æ‹¬ä¸€ä¸‹ï¼š

+ `POSIX` å…±äº«å†…å­˜ä¸ `System V` å…±äº«å†…å­˜åœ¨å†…æ ¸éƒ½æ˜¯é€šè¿‡ `tmpfs` å®ç°ï¼Œä½†å¯¹åº”ä¸¤ä¸ªä¸åŒçš„ `tmpfs` å®ä¾‹ï¼Œç›¸äº’ç‹¬ç«‹ã€‚
+ é€šè¿‡ `/proc/sys/kernel/shmmax` å¯ä»¥é™åˆ¶ `System V` å…±äº«å†…å­˜çš„æœ€å¤§å€¼ï¼Œé€šè¿‡ `/dev/shm` å¯ä»¥é™åˆ¶ `POSIX` å…±äº«å†…å­˜çš„æœ€å¤§å€¼ã€‚

## 5. Kubernetes å…±äº«å†…å­˜

----

`Kubernetes` åˆ›å»ºçš„ Podï¼Œå…¶å…±äº«å†…å­˜é»˜è®¤ `64MB`ï¼Œä¸”ä¸å¯æ›´æ”¹ã€‚

ä¸ºä»€ä¹ˆæ˜¯è¿™ä¸ªå€¼å‘¢ï¼Ÿå…¶å®ï¼ŒKubernetes æœ¬èº«æ˜¯æ²¡æœ‰è®¾ç½®å…±äº«å†…å­˜çš„å¤§å°çš„ï¼Œ`64MB` å…¶å®æ˜¯ `Docker` é»˜è®¤çš„å…±äº«å†…å­˜çš„å¤§å°ã€‚

Docker run çš„æ—¶å€™ï¼Œå¯ä»¥é€šè¿‡ `--shm-size` æ¥è®¾ç½®å…±äº«å†…å­˜çš„å¤§å°ï¼š

```bash
ğŸ³ â†’ docker run  --rm centos:7 df -h |grep shm
shm              64M     0   64M   0% /dev/shm

ğŸ³ â†’ docker run  --rm --shm-size 128M centos:7 df -h |grep shm
shm             128M     0  128M   0% /dev/shm
```

ç„¶è€Œï¼ŒKubernetes å¹¶æ²¡æœ‰æä¾›è®¾ç½® `shm` å¤§å°çš„é€”å¾„ã€‚åœ¨è¿™ä¸ª [issue](https://github.com/kubernetes/kubernetes/issues/28272) é‡Œç¤¾åŒºè®¨è®ºäº†å¾ˆä¹…æ˜¯å¦è¦ç»™ `shm` å¢åŠ ä¸€ä¸ªå‚æ•°ï¼Œä½†æ˜¯æœ€ç»ˆå¹¶æ²¡æœ‰å½¢æˆç»“è®ºï¼Œåªæ˜¯æœ‰ä¸€ä¸ª workgroud çš„åŠæ³•ï¼šå°† `Memory` ç±»å‹çš„ `emptyDir` æŒ‚è½½åˆ° `/dev/shm` æ¥è§£å†³ã€‚

Kubernetes æä¾›äº†ä¸€ç§ç‰¹æ®Šçš„ `emptyDir`ï¼šå¯ä»¥å°† `emptyDir.medium` å­—æ®µè®¾ç½®ä¸º `"Memory"`ï¼Œä»¥å‘Šè¯‰ Kubernetes ä½¿ç”¨ `tmpfs`ï¼ˆåŸºäº RAM çš„æ–‡ä»¶ç³»ç»Ÿï¼‰ä½œä¸ºä»‹è´¨ã€‚ç”¨æˆ·å¯ä»¥å°† Memory ä»‹è´¨çš„ `emptyDir` æŒ‚åˆ°ä»»ä½•ç›®å½•ï¼Œç„¶åå°†è¿™ä¸ªç›®å½•å½“ä½œä¸€ä¸ªé«˜æ€§èƒ½çš„æ–‡ä»¶ç³»ç»Ÿæ¥ä½¿ç”¨ï¼Œå½“ç„¶ä¹Ÿå¯ä»¥æŒ‚è½½åˆ° `/dev/shm`ï¼Œè¿™æ ·å°±å¯ä»¥è§£å†³å…±äº«å†…å­˜ä¸å¤Ÿç”¨çš„é—®é¢˜äº†ã€‚

ä½¿ç”¨ emptyDir è™½ç„¶å¯ä»¥è§£å†³é—®é¢˜ï¼Œä½†ä¹Ÿæ˜¯æœ‰ç¼ºç‚¹çš„ï¼š

+ ä¸èƒ½åŠæ—¶ç¦æ­¢ç”¨æˆ·ä½¿ç”¨å†…å­˜ã€‚è™½ç„¶è¿‡ 1~2 åˆ†é’Ÿ `Kubelet` ä¼šå°† `Pod` æŒ¤å‡ºï¼Œä½†æ˜¯è¿™ä¸ªæ—¶é—´å†…ï¼Œå…¶å®å¯¹ `Node` è¿˜æ˜¯æœ‰é£é™©çš„ã€‚
+ å½±å“ Kubernetes è°ƒåº¦ï¼Œå› ä¸º `emptyDir` å¹¶ä¸æ¶‰åŠ Node çš„ `Resources`ï¼Œè¿™æ ·ä¼šé€ æˆ Pod â€œå·å·â€ä½¿ç”¨äº† Node çš„å†…å­˜ï¼Œä½†æ˜¯è°ƒåº¦å™¨å¹¶ä¸çŸ¥æ™“ã€‚
+ ç”¨æˆ·ä¸èƒ½åŠæ—¶æ„ŸçŸ¥åˆ°å†…å­˜ä¸å¯ç”¨ã€‚

ç”±äºå…±äº«å†…å­˜ä¹Ÿä¼šå— `Cgroup` é™åˆ¶ï¼Œæˆ‘ä»¬åªéœ€è¦ç»™ Pod è®¾ç½® `Memory limits` å°±å¯ä»¥äº†ã€‚å¦‚æœå°† Pod çš„ `Memory limits` è®¾ç½®ä¸ºå…±äº«å†…å­˜çš„å¤§å°ï¼Œå°±ä¼šé‡åˆ°ä¸€ä¸ªé—®é¢˜ï¼šå½“å…±äº«å†…å­˜è¢«è€—å°½æ—¶ï¼Œä»»ä½•å‘½ä»¤éƒ½æ— æ³•æ‰§è¡Œï¼Œåªèƒ½ç­‰è¶…æ—¶åè¢« Kubelet é©±é€ã€‚

è¿™ä¸ªé—®é¢˜ä¹Ÿå¾ˆå¥½è§£å†³ï¼Œå°†å…±äº«å†…å­˜çš„å¤§å°è®¾ç½®ä¸º `Memory limits` çš„ `50%` å°±å¥½ã€‚ç»¼åˆä»¥ä¸Šåˆ†æï¼Œæœ€ç»ˆè®¾è®¡å¦‚ä¸‹ï¼š

1. å°† Memory ä»‹è´¨çš„ `emptyDir` æŒ‚è½½åˆ° `/dev/shm/`ã€‚
2. é…ç½® Pod çš„ `Memory limits`ã€‚
3. é…ç½® `emptyDir` çš„ `sizeLimit` ä¸º `Memory limits` çš„ 50%ã€‚

## 6. æœ€ç»ˆé…ç½®

----

æ ¹æ®ä¸Šé¢çš„è®¾è®¡ï¼Œæœ€ç»ˆçš„é…ç½®å¦‚ä¸‹ã€‚

`Nginx` çš„é…ç½®æ”¹ä¸ºï¼š

```nginx
listen      unix:/dev/shm/hugo.sock;
```

`Envoy` çš„é…ç½®æ”¹ä¸ºï¼š

```yaml
- "@type": type.googleapis.com/envoy.api.v2.Cluster
  name: hugo
  connect_timeout: 15s
  type: static
  load_assignment:
    cluster_name: hugo
    endpoints:
    - lb_endpoints:
      - endpoint:
          address:
            pipe:
              path: "/dev/shm/hugo.sock"
```

Kubernetes çš„ `manifest` æ”¹ä¸ºï¼š

```yaml
spec:
  ...
  template:
    ...
    spec:
      containers:
      - name: envoy
        resources:
          limits:
            memory: 256Mi
        ...
        volumeMounts:
        - mountPath: /dev/shm
          name: hugo-socket
          ...
      - name: hugo
        resources:
          limits:
            memory: 256Mi
        ...
        volumeMounts:
        - mountPath: /dev/shm
          name: hugo-socket
          ...
      volumes:
      ...
      - name: hugo-socket
        emptyDir:
          medium: Memory
          sizeLimit: 128Mi
```

## 7. å‚è€ƒèµ„æ–™

----

+ [è®¾ç½®kubernetes Podçš„shared memory](https://ieevee.com/tech/2019/11/10/shm.html)
+ [Kubernetesä¸­Podé—´å…±äº«å†…å­˜æ–¹æ¡ˆ](https://my.oschina.net/jxcdwangtao/blog/3006365)



